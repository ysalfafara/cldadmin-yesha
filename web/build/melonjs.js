if(function(){function e(){if(!n){if(!document.body)return setTimeout(e,13);document.removeEventListener?document.removeEventListener("DOMContentLoaded",e,!1):window.removeEventListener("load",e,!1),n=!0;for(var t=0;t<r.length;t++)r[t].call(window,[]);r.length=0,"function"==typeof define&&define.amd&&define("me",[],function(){return me})}}function t(){return i?void 0:(i=!0,"complete"===document.readyState?e():(document.addEventListener&&document.addEventListener("DOMContentLoaded",e,!1),void window.addEventListener("load",e,!1)))}window.me=window.me||{};var i=!1,n=!1,r=[];window.onReady=function(e){return t(),n?e.call(window,[]):r.push(function(){return e.call(window,[])}),this},me.skipAutoInit!==!0?window.onReady(function(){me.boot()}):me.init=function(){me.boot(),e()},window.throttle||(window.throttle=function(e,t,i){var n,r=window.performance.now();return"boolean"!=typeof t&&(t=!1),function(){var o=window.performance.now(),s=o-r,a=arguments;return e>s?void(t===!1&&(clearTimeout(n),n=setTimeout(function(){return r=o,i.apply(null,a)},s))):(r=o,i.apply(null,a))}}),"undefined"==typeof console&&(console={log:function(){},info:function(){},error:function(){alert(Array.prototype.slice.call(arguments).join(", "))}})}(),Object.defineProperty||(Object.defineProperty=function(e,t,i){if(!e.__defineGetter__)throw new TypeError("Object.defineProperty not supported");i.get&&e.__defineGetter__(t,i.get),i.set&&e.__defineSetter__(t,i.set)}),"function"!=typeof Object.create&&(Object.create=function(e){var t=function(){};return t.prototype=e,new t}),!Function.prototype.bind){var Empty=function(){};Function.prototype.bind=function(e){var t=this;if("function"!=typeof t)throw new TypeError("Function.prototype.bind called on incompatible "+t);var i=Array.prototype.slice.call(arguments,1),n=function(){if(this instanceof n){var r=t.apply(this,i.concat(Array.prototype.slice.call(arguments)));return Object(r)===r?r:this}return t.apply(e,i.concat(Array.prototype.slice.call(arguments)))};return t.prototype&&(Empty.prototype=t.prototype,n.prototype=new Empty,Empty.prototype=null),n}}if(function(){function e(e,t,i){Object.keys(i).forEach(function(n){if(t[n]=i[n],"function"!=typeof i[n])throw new TypeError("extend: Method `"+n+"` is not a function");Object.defineProperty(e.prototype,n,{configurable:!0,value:i[n]})})}function t(e,t,i){return e.prototype[t].apply(this,i)}Object.defineProperty(Object.prototype,"extend",{value:function(){function i(){return this.init.apply(this,arguments),this}var n={},r=Array.prototype.slice.call(arguments,0);if(i.prototype=Object.create(this.prototype),r.forEach(function(t){e(i,n,t.__methods__||t)}),!("init"in i.prototype))throw new TypeError("extend: Class is missing a constructor named `init`");return Object.defineProperty(i.prototype,"_super",{value:t}),Object.defineProperty(i,"__methods__",{value:n}),i}})}(),me.Error=Error.extend({init:function(e){this.name="me.Error",this.message=e}}),Function.prototype.defer=function(){return setTimeout(this.bind.apply(this,arguments),.01)},Number.prototype.clamp=function(e,t){return e>this?e:this>t?t:+this},Number.prototype.random=function(e,t){return t||(t=e,e=this),~~(Math.random()*(t-e))+e},Number.prototype.randomFloat=function(e,t){return t||(t=e,e=this),Math.random()*(t-e)+e},Number.prototype.weightedRandom=function(e,t){return t||(t=e,e=this),~~(Math.pow(Math.random(),2)*(t-e))+e},Number.prototype.round=function(e,t){e=arguments.length<2?this:e;var i=Math.pow(10,t||e||0);return~~(.5+e*i)/i},Number.prototype.toHex=function(){return"0123456789ABCDEF".charAt(this-this%16>>4)+"0123456789ABCDEF".charAt(this%16)},Number.prototype.sign=function(){return 0>this?-1:this>0?1:0},Number.prototype.degToRad=function(e){return(e||this)/180*Math.PI},Number.prototype.radToDeg=function(e){return(e||this)*(180/Math.PI)},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.trimLeft||(String.prototype.trimLeft=function(){return this.replace(/^\s+/,"")}),String.prototype.trimRight||(String.prototype.trimRight=function(){return this.replace(/\s+$/,"")}),String.prototype.isNumeric=function(){return!isNaN(this)&&""!==this.trim()},String.prototype.isBoolean=function(){var e=this.trim();return"true"===e||"false"===e},String.prototype.contains||(String.prototype.contains=function(e,t){return-1!==String.prototype.indexOf.call(this,e,t)}),String.prototype.toHex=function(){for(var e="",t=0;t<this.length;)e+=this.charCodeAt(t++).toString(16);return e},Array.prototype.remove=function(e){var t=Array.prototype.indexOf.call(this,e);return-1!==t&&Array.prototype.splice.call(this,t,1),this},Array.prototype.forEach||(Array.prototype.forEach=function(e,t){for(var i=0,n=this.length;n--;i++)e.call(t||this,this[i],i,this)}),Array.isArray||(Array.isArray=function(e){var t;return t=e instanceof Array}),Array.prototype.random=function(e){return e[0..random(e.length)]},Array.prototype.weightedRandom=function(e){return e[0..weightedRandom(e.length)]},me.TypedArray=function(e){var t=0;if(Array.isArray(e))for(t=0;t<e.length;t++)this.push(e[t]);else{if(1!==arguments.length||"number"!=typeof e)throw new me.Error("TypedArray polyfill: Unsupported constructor arguments",arguments);for(t=0;e>t;t++)this.push(0)}},me.TypedArray.prototype=Array.prototype,window.Float32Array=window.Float32Array||me.TypedArray,window.Uint16Array=window.Uint16Array||me.TypedArray,window.Uint32Array=window.Uint32Array||me.TypedArray,"undefined"==typeof window.performance&&(window.performance={}),"undefined"==typeof Date.now&&(Date.now=function(){return(new Date).getTime()}),!window.performance.now){var timeOffset=Date.now();window.performance.timing&&window.performance.timing.navigationStart&&(timeOffset=window.performance.timing.navigationStart),window.performance.now=function(){return Date.now()-timeOffset}}!function(){me.mod="melonJS",me.version="2.0.2",me.sys={fps:60,interpolation:!1,scale:null,scalingInterpolation:!1,gravity:void 0,stopOnAudioError:!0,pauseOnBlur:!0,resumeOnFocus:!0,stopOnBlur:!1,preRender:!1,checkVersion:function(e,t){t=t||me.version;for(var i=e.split("."),n=t.split("."),r=Math.min(i.length,n.length),o=0,s=0;r>s&&!(o=+i[s]-+n[s]);s++);return o?o:i.length-n.length}};var e=!1;Object.defineProperty(me,"initialized",{get:function(){return e}}),me.boot=function(){e||(me.device._check(),me.save._init(),me.loader.setNocache(document.location.href.match(/\?nocache/)||!1),me.timer.init(),me.mapReader=new me.TMXMapReader,me.state.init(),me.pool.init(),me.device.isMobile===!1&&me.input._enableKeyboardEvent(),me.levelDirector.reset(),e=!0)}}(),function(){me.game=function(){var e={},t=!1,i=!0,n=0,r=1,o=null;return e.viewport=null,e.currentLevel=null,e.world=null,e.mergeGroup=!0,e.sortOn="z",e.tmxRenderer=null,e.onLevelLoaded=null,e.init=function(n,r){t||(n=n||me.video.renderer.getWidth(),r=r||me.video.renderer.getHeight(),e.viewport=new me.Viewport(0,0,n,r),e.world=new me.Container(0,0,n,r),e.world.name="rootContainer",me.collision.init(),o=me.video.renderer,me.event.publish(me.event.GAME_INIT),me.input._translatePointerEvents(),i=!0,e.currentLevel={pos:{x:0,y:0}},t=!0)},e.reset=function(){me.collision.quadTree.clear(),e.world.destroy(),e.viewport&&e.viewport.reset(),e.currentLevel={pos:{x:0,y:0}},o.resetTransform(),n=0,r=~~(.5+60/me.sys.fps)},e.getParentContainer=function(e){return e.ancestor},e.repaint=function(){i=!0},e.update=function(t){++n%r===0&&(n=0,me.timer.update(t),me.collision.quadTree.clear(),me.collision.quadTree.insertContainer(e.world),i=e.world.update(me.timer.getDelta())||i,i=e.viewport.update(me.timer.getDelta())||i)},e.draw=function(){if(i){var t=e.viewport.pos.x+~~e.viewport.offset.x,n=e.viewport.pos.y+~~e.viewport.offset.y;e.world.transform.translate(-t,-n),e.viewport.screenX=t-e.currentLevel.pos.x,e.viewport.screenY=n-e.currentLevel.pos.y,e.world.draw(o,e.viewport),e.world.transform.translate(t,n),e.viewport.draw(o)}i=!1,me.video.renderer.blitSurface()},e}()}(),function(){var e=function(e){return e.substring(0,1).toUpperCase()+e.substring(1,e.length)};me.agent=function(){var t={},i=["ms","MS","moz","webkit","o"];return t.prefixed=function(t,n){if(n=n||window,t in n)return n[t];var r,o=e(t);return i.some(function(e){var t=e+o;return r=t in n?n[t]:void 0}),r},t.setPrefixed=function(t,n,r){if(r=r||window,t in r)return void(r[t]=n);var o=e(t);i.some(function(e){var t=e+o;return t in r?(r[t]=n,!0):!1})},t}()}(),function(){me.device=function(){function e(e){e.reading?(i.accelerationX=e.reading.accelerationX,i.accelerationY=e.reading.accelerationY,i.accelerationZ=e.reading.accelerationZ):(i.accelerationX=e.accelerationIncludingGravity.x,i.accelerationY=e.accelerationIncludingGravity.y,i.accelerationZ=e.accelerationIncludingGravity.z)}function t(e){i.gamma=e.gamma,i.beta=e.beta,i.alpha=e.alpha}var i={},n=!1,r=!1,o=null;return i._check=function(){me.device._detectDevice(),me.device.pointerEnabled=me.agent.prefixed("pointerEnabled",navigator),navigator.maxTouchPoints=me.agent.prefixed("maxTouchPoints",navigator)||0,window.gesture=me.agent.prefixed("gesture"),me.device.touch="createTouch"in document||"ontouchstart"in window||navigator.isCocoonJS||me.device.pointerEnabled&&navigator.maxTouchPoints>0,me.device.hasAccelerometer="undefined"!=typeof window.DeviceMotionEvent||"undefined"!=typeof window.Windows&&"function"==typeof Windows.Devices.Sensors.Accelerometer,this.hasPointerLockSupport=me.agent.prefixed("pointerLockElement",document),this.hasPointerLockSupport&&(document.exitPointerLock=me.agent.prefixed("exitPointerLock",document)),window.DeviceOrientationEvent&&(me.device.hasDeviceOrientation=!0),this.hasFullscreenSupport=me.agent.prefixed("fullscreenEnabled",document)||document.mozFullScreenEnabled,document.exitFullscreen=me.agent.prefixed("cancelFullScreen",document)||me.agent.prefixed("exitFullscreen",document),navigator.vibrate=me.agent.prefixed("vibrate",navigator);try{i.localStorage=!!window.localStorage}catch(e){i.localStorage=!1}window.addEventListener("blur",function(){me.sys.stopOnBlur&&me.state.stop(!0),me.sys.pauseOnBlur&&me.state.pause(!0)},!1),window.addEventListener("focus",function(){me.sys.stopOnBlur&&me.state.restart(!0),me.sys.resumeOnFocus&&me.state.resume(!0)},!1);var t,n;"undefined"!=typeof document.hidden?(t="hidden",n="visibilitychange"):"undefined"!=typeof document.mozHidden?(t="mozHidden",n="mozvisibilitychange"):"undefined"!=typeof document.msHidden?(t="msHidden",n="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(t="webkitHidden",n="webkitvisibilitychange"),"string"==typeof n&&document.addEventListener(n,function(){document[t]?(me.sys.stopOnBlur&&me.state.stop(!0),me.sys.pauseOnBlur&&me.state.pause(!0)):(me.sys.stopOnBlur&&me.state.restart(!0),me.sys.resumeOnFocus&&me.state.resume(!0))},!1)},i._detectDevice=function(){me.device.iOS=me.device.ua.match(/iPhone|iPad|iPod/i)||!1,me.device.android=me.device.ua.match(/Android/i)||!1,me.device.android2=me.device.ua.match(/Android 2/i)||!1,me.device.wp=me.device.ua.match(/Windows Phone/i)||!1,me.device.BlackBerry=me.device.ua.match(/BlackBerry/i)||!1,me.device.Kindle=me.device.ua.match(/Kindle|Silk.*Mobile Safari/i)||!1,me.device.isMobile=me.device.ua.match(/Mobi/i)||me.device.iOS||me.device.android||me.device.wp||me.device.BlackBerry||me.device.Kindle||me.device.iOS||!1},i.ua=navigator.userAgent,i.localStorage=!1,i.hasAccelerometer=!1,i.hasDeviceOrientation=!1,i.hasFullscreenSupport=!1,i.hasPointerLockSupport=!1,i.nativeBase64="function"==typeof window.atob,i.touch=!1,i.isMobile=!1,i.iOS=!1,i.android=!1,i.android2=!1,i.wp=!1,i.BlackBerry=!1,i.Kindle=!1,i.orientation=0,i.accelerationX=0,i.accelerationY=0,i.accelerationZ=0,i.gamma=0,i.beta=0,i.alpha=0,i.requestFullscreen=function(e){this.hasFullscreenSupport&&(e=e||me.video.getWrapper(),e.requestFullscreen=me.agent.prefixed("requestFullscreen",e)||e.mozRequestFullScreen,e.requestFullscreen())},i.exitFullscreen=function(){this.hasFullscreenSupport&&document.exitFullscreen()},i.getPixelRatio=function(){if(null===o){var e;e="undefined"!=typeof me.video.renderer?me.video.renderer.getScreenContext():me.CanvasRenderer.getContext2d(document.createElement("canvas"));var t=window.devicePixelRatio||1,i=me.agent.prefixed("backingStorePixelRatio",e)||1;o=t/i}return o},i.getStorage=function(e){switch(e=e||"local"){case"local":return me.save;default:throw new me.Error("storage type "+e+" not supported")}},i.turnOnPointerLock=function(){if(this.hasPointerLockSupport){var e=me.video.getWrapper();if(me.device.ua.match(/Firefox/i)){var t=function(){(me.agent.prefixed("fullscreenElement",document)||document.mozFullScreenElement)===e&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),e.requestPointerLock=me.agent.prefixed("requestPointerLock",e),e.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),me.device.requestFullscreen()}else e.requestPointerLock()}},i.turnOffPointerLock=function(){this.hasPointerLockSupport&&document.exitPointerLock()},i.watchAccelerometer=function(){if(me.device.hasAccelerometer){if(!n){if("undefined"==typeof Windows)window.addEventListener("devicemotion",e,!1);else{var t=Windows.Devices.Sensors.Accelerometer.getDefault();if(t){var i=t.minimumReportInterval,r=i>=16?i:25;t.reportInterval=r,t.addEventListener("readingchanged",e,!1)}}n=!0}return!0}return!1},i.unwatchAccelerometer=function(){if(n){if("undefined"==typeof Windows)window.removeEventListener("devicemotion",e,!1);else{var t=Windows.Device.Sensors.Accelerometer.getDefault();t.removeEventListener("readingchanged",e,!1)}n=!1}},i.watchDeviceOrientation=function(){return me.device.hasDeviceOrientation&&!r&&(window.addEventListener("deviceorientation",t,!1),r=!0),!1},i.unwatchDeviceOrientation=function(){r&&(window.removeEventListener("deviceorientation",t,!1),r=!1)},i.vibrate=function(e){navigator.vibrate&&navigator.vibrate(e)},i}(),Object.defineProperty(me.device,"isFullscreen",{get:function(){if(me.device.hasFullscreenSupport){var e=me.agent.prefixed("fullscreenElement",document)||document.mozFullScreenElement;return e===me.video.getWrapper()}return!1}}),Object.defineProperty(me.device,"sound",{get:function(){return!Howler.noAudio}})}(),function(){me.timer=function(){var e={},t=0,i=0,n=0,r=0,o=0,s=Math.ceil(1e3/me.sys.fps),a=1e3/me.sys.fps*1.25,h=[],l=0,u=function(e){for(var t=0,i=h.length;i>t;t++)if(h[t].timerId===e){h.splice(t,1);break}},d=function(e){for(var t=0,i=h.length;i>t;t++){var n=h[t];n.pauseable&&me.state.isPaused()||(n.elapsed+=e),n.elapsed>=n.delay&&(n.func.apply(this),n.repeat===!0?n.elapsed-=n.delay:me.timer.clearTimeout(n.timerId))}};return e.tick=1,e.fps=0,e.init=function(){e.reset(),r=n=0},e.reset=function(){n=r=window.performance.now(),o=0,i=0,t=0},e.setTimeout=function(e,t,i){return h.push({func:e,delay:t,elapsed:0,repeat:!1,timerId:++l,pauseable:i===!0||!0}),l},e.setInterval=function(e,t,i){return h.push({func:e,delay:t,elapsed:0,repeat:!0,timerId:++l,pauseable:i===!0||!0}),l},e.clearTimeout=function(e){u.defer(this,e)},e.clearInterval=function(e){u.defer(this,e)},e.getTime=function(){return r},e.getDelta=function(){return o},e.countFPS=function(){t++,i+=o,t%10===0&&(this.fps=(~~(1e3*t/i)).clamp(0,me.sys.fps),i=0,t=0)},e.update=function(t){return n=r,r=t,o=r-n,e.tick=o>a&&me.sys.interpolation?o/s:1,d(o),o},e}()}(),function(){me.pool=function(){var e={},t={};return e.init=function(){e.register("me.Entity",me.Entity),e.register("me.CollectableEntity",me.CollectableEntity),e.register("me.LevelEntity",me.LevelEntity),e.register("TileObject",me.Sprite),e.register("me.Tween",me.Tween,!0),e.register("me.Color",me.Color,!0),e.register("me.Particle",me.Particle,!0)},e.register=function(e,i,n){return n?void(t[e.toLowerCase()]={"class":i,pool:[]}):void(t[e.toLowerCase()]={"class":i,pool:void 0})},e.pull=function(e){var i="string"==typeof e?e.toLowerCase():void 0,n=Array.prototype.slice.call(arguments);if(i&&t[i]){var r;if(!t[i].pool)return r=t[i]["class"],n[0]=r,new(r.bind.apply(r,n));var o,s=t[i];return r=s["class"],s.pool.length>0?(o=s.pool.pop(),"function"==typeof o.init&&o.init.apply(o,n.slice(1)),"function"==typeof o.onResetEvent&&o.onResetEvent.apply(o,n.slice(1))):(n[0]=r,o=new(r.bind.apply(r,n)),o.className=i),o}return i&&console.error("Cannot instantiate entity of type '"+e+"': Class not found!"),null},e.purge=function(){for(var e in t)t.hasOwnProperty(e)&&(t[e].pool=[])},e.push=function(e){var i=e.className;"undefined"!=typeof i&&t[i]&&t[i].pool.push(e)},e}()}(),function(){me.Vector2d=Object.extend({init:function(e,t){return this.set(e||0,t||0)},set:function(e,t){if(e!==+e||t!==+t)throw new me.Vector2d.Error("invalid x,y parameters (not a number)");return this.x=e,this.y=t,this},setZero:function(){return this.set(0,0)},setV:function(e){return this.x=e.x,this.y=e.y,this},add:function(e){return this.x+=e.x,this.y+=e.y,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this},scale:function(e,t){return this.x*=e,this.y*="undefined"!=typeof t?t:e,this},scaleV:function(e){return this.x*=e.x,this.y*=e.y,this},div:function(e){return this.x/=e,this.y/=e,this},abs:function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this},clamp:function(e,t){return new me.Vector2d(this.x.clamp(e,t),this.y.clamp(e,t))},clampSelf:function(e,t){return this.x=this.x.clamp(e,t),this.y=this.y.clamp(e,t),this},minV:function(e){return this.x=this.x<e.x?this.x:e.x,this.y=this.y<e.y?this.y:e.y,this},maxV:function(e){return this.x=this.x>e.x?this.x:e.x,this.y=this.y>e.y?this.y:e.y,this},floor:function(){return new me.Vector2d(~~this.x,~~this.y)},floorSelf:function(){return this.x=~~this.x,this.y=~~this.y,this},ceil:function(){return new me.Vector2d(Math.ceil(this.x),Math.ceil(this.y))},ceilSelf:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},negate:function(){return new me.Vector2d(-this.x,-this.y)},negateSelf:function(){return this.x=-this.x,this.y=-this.y,this},copy:function(e){return this.x=e.x,this.y=e.y,this},equals:function(e){return this.x===e.x&&this.y===e.y},normalize:function(){var e=this.length();return e>0&&(this.x=this.x/e,this.y=this.y/e),this},perp:function(){var e=this.x;return this.x=this.y,this.y=-e,this},rotate:function(e){var t=this.x,i=this.y;return this.x=t*Math.cos(e)-i*Math.sin(e),this.y=t*Math.sin(e)+i*Math.cos(e),this},reverse:function(){return this.x=-this.x,this.y=-this.y,this},dotProduct:function(e){return this.x*e.x+this.y*e.y},length2:function(){return this.dotProduct(this)},length:function(){return Math.sqrt(this.length2())},distance:function(e){return Math.sqrt((this.x-e.x)*(this.x-e.x)+(this.y-e.y)*(this.y-e.y))},angle:function(e){return Math.atan2(e.y-this.y,e.x-this.x)},project:function(e){var t=this.dotProduct(e)/e.length2();return this.x=t*e.x,this.y=t*e.y,this},projectN:function(e){var t=this.dotProduct(e);return this.x=t*e.x,this.y=t*e.y,this},reflect:function(e){var t=this.x,i=this.y;return this.project(e).scale(2),this.x-=t,this.y-=i,this},reflectN:function(e){var t=this.x,i=this.y;return this.projectN(e).scale(2),this.x-=t,this.y-=i,this},clone:function(){return new me.Vector2d(this.x,this.y)},toString:function(){return"x:"+this.x+",y:"+this.y}}),me.Vector2d.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.Vector2d.Error"}})}(),function(){me.Rect=Object.extend({init:function(e,t,i,n){this.pos=new me.Vector2d(e,t),this.width=i,this.height=n,this.shapeType="Rectangle"},setShape:function(e,t,i,n){return this.pos.set(e,t),this.resize(i,n),this},resize:function(e,t){return this.width=e,this.height=t,this},getBounds:function(){return this},updateBounds:function(){return this},clone:function(){return new me.Rect(this.pos.x,this.pos.y,this.width,this.height)},copy:function(e){return this.setShape(e.pos.x,e.pos.y,e.width,e.height)},translate:function(e,t){return this.pos.x+=e,this.pos.y+=t,this},translateV:function(e){return this.translate(e.x,e.y)},union:function(e){var t=Math.min(this.left,e.left),i=Math.min(this.top,e.top);return this.resize(Math.max(this.right,e.right)-t,Math.max(this.bottom,e.bottom)-i),this.pos.set(t,i),this},overlaps:function(e){return this.left<e.right&&e.left<this.right&&this.top<e.bottom&&e.top<this.bottom},contains:function(e){return e.left>=this.left&&e.right<=this.right&&e.top>=this.top&&e.bottom<=this.bottom},containsPointV:function(e){return this.containsPoint(e.x,e.y)},containsPoint:function(e,t){return e>=this.left&&e<=this.right&&t>=this.top&&t<=this.bottom},toPolygon:function(){var e=this.pos,t=this.width,i=this.height;return new me.Polygon(e.x,e.y,[new me.Vector2d,new me.Vector2d(t,0),new me.Vector2d(t,i),new me.Vector2d(0,i)])}}),Object.defineProperty(me.Rect.prototype,"left",{get:function(){return this.pos.x},configurable:!0}),Object.defineProperty(me.Rect.prototype,"right",{get:function(){return this.pos.x+this.width||this.width},configurable:!0}),Object.defineProperty(me.Rect.prototype,"top",{get:function(){return this.pos.y},configurable:!0}),Object.defineProperty(me.Rect.prototype,"bottom",{get:function(){return this.pos.y+this.height||this.height},configurable:!0})}(),function(){me.Ellipse=Object.extend({init:function(e,t,i,n){this.pos=new me.Vector2d,this.bounds=void 0,this.radius=0/0,this.radiusV=new me.Vector2d,this.radiusSq=new me.Vector2d,this.ratio=new me.Vector2d,this.shapeType="Ellipse",this.setShape(e,t,i,n)},setShape:function(e,t,i,n){var r=i/2,o=n/2;this.pos.set(e,t),this.radius=Math.max(r,o),this.ratio.set(r/this.radius,o/this.radius),this.radiusV.set(this.radius,this.radius).scaleV(this.ratio);var s=this.radius*this.radius;return this.radiusSq.set(s,s).scaleV(this.ratio),this.updateBounds(),this},rotate:function(){return this},scale:function(e,t){return t="undefined"!=typeof t?t:e,this.setShape(this.pos.x,this.pos.y,2*this.radiusV.x*e,2*this.radiusV.y*t)},scaleV:function(e){return this.scale(e.x,e.y)},translate:function(e,t){return this.pos.x+=e,this.pos.y+=t,this.bounds.translate(e,t),this},translateV:function(e){return this.pos.add(e),this.bounds.translateV(e),this},containsPointV:function(e){return this.containsPoint(e.x,e.y)},containsPoint:function(e,t){return e-=this.pos.x,t-=this.pos.y,e*e/this.radiusSq.x+t*t/this.radiusSq.y<=1},getBounds:function(){return this.bounds},updateBounds:function(){var e=this.radiusV.x,t=this.radiusV.y,i=this.pos.x-e,n=this.pos.y-t,r=2*e,o=2*t;return this.bounds?this.bounds.setShape(i,n,r,o):this.bounds=new me.Rect(i,n,r,o),this.bounds},clone:function(){return new me.Ellipse(this.pos.x,this.pos.y,2*this.radiusV.x,2*this.radiusV.y)}})}(),function(){me.Polygon=Object.extend({init:function(e,t,i){this.pos=new me.Vector2d,this.bounds=void 0,this.points=null,this.shapeType="Polygon",this.setShape(e,t,i)},setShape:function(e,t,i){return this.pos.set(e,t),this.points=i,this.recalc(),this.updateBounds(),this},rotate:function(e){if(0!==e){for(var t=this.points,i=t.length,n=0;i>n;n++)t[n].rotate(e);this.recalc(),this.updateBounds()}return this},scale:function(e,t){t="undefined"!=typeof t?t:e;for(var i=this.points,n=i.length,r=0;n>r;r++)i[r].scale(e,t);return this.recalc(),this.updateBounds(),this},scaleV:function(e){return this.scale(e.x,e.y)},recalc:function(){var e,t=this.edges=[],i=this.normals=[],n=this.points,r=n.length;if(3>r)throw new me.Polygon.Error("Requires at least 3 points");for(e=0;r>e;e++){var o=(new me.Vector2d).copy(n[(e+1)%r]).sub(n[e]);t.push(o),i.push((new me.Vector2d).copy(o).perp().normalize())}return this},translate:function(e,t){return this.pos.x+=e,this.pos.y+=t,this.bounds.translate(e,t),this},translateV:function(e){return this.pos.add(e),this.bounds.translateV(e),this},containsPointV:function(e){return this.containsPoint(e.x,e.y)},containsPoint:function(e,t){for(var i=!1,n=this.pos.x,r=this.pos.y,o=this.points,s=o.length,a=0,h=s-1;s>a;h=a++){var l=o[a].y+r,u=o[a].x+n,d=o[h].y+r,c=o[h].x+n;l>t!=d>t&&(c-u)*(t-l)/(d-l)+u>e&&(i=!i)}return i},getBounds:function(){return this.bounds},updateBounds:function(){var e=1/0,t=1/0,i=-1/0,n=-1/0;return this.points.forEach(function(r){e=Math.min(e,r.x),t=Math.min(t,r.y),i=Math.max(i,r.x),n=Math.max(n,r.y)}),this.bounds?this.bounds.setShape(e,t,i-e,n-t):this.bounds=new me.Rect(e,t,i-e,n-t),this.bounds.translateV(this.pos)},clone:function(){var e=[];return this.points.forEach(function(t){e.push(new me.Vector2d(t.x,t.y))}),new me.Polygon(this.pos.x,this.pos.y,e)}}),me.Polygon.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.Polygon.Error"}})}(),function(){me.Line=me.Polygon.extend({containsPointV:function(e){return this.containsPoint(e.x,e.y)},containsPoint:function(e,t){e-=this.pos.x,t-=this.pos.y;var i=this.points[0],n=this.points[1];return(t-i.y)*(n.x-i.x)===(n.y-i.y)*(e-i.x)},recalc:function(){var e=this.edges=[],t=this.normals=[],i=this.points;if(2!==i.length)throw new me.Line.Error("Requires exactly 2 points");var n=(new me.Vector2d).copy(i[1]).sub(i[0]);return e.push(n),t.push((new me.Vector2d).copy(n).perp().normalize()),this}}),me.Line.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.Line.Error"}})}(),function(){me.Matrix2d=Object.extend({init:function(e){this.val=new Float32Array(6),e?this.copy(e):this.identity()},identity:function(){return this.set(1,0,0,1,0,0),this},set:function(){var e=this.val;return e[0]=arguments[0],e[1]=arguments[1],e[2]=arguments[2],e[3]=arguments[3],e[4]=arguments[4],e[5]=arguments[5],this},multiply:function(e){var t=this.val,i=e.val,n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],h=t[5],l=i[0],u=i[1],d=i[2],c=i[3],f=i[4],p=i[5];return t[0]=n*l+o*u,t[1]=r*l+s*u,t[2]=n*d+o*c,t[3]=r*d+s*c,t[4]=n*f+o*p+a,t[5]=r*f+s*p+h,this},scale:function(e,t){var i=this.val;return i[0]*=e,i[1]*=e,i[2]*=t,i[3]*=t,this},rotate:function(e){if(0!==e){var t=this.val,i=t[0],n=t[1],r=t[2],o=t[3],s=Math.sin(e),a=Math.cos(e);t[0]=i*a+r*s,t[1]=n*a+o*s,t[2]=i*-s+r*a,t[3]=n*-s+o*a}return this},translate:function(e,t){var i=this.val;return i[4]+=e,i[5]+=t,this},translateV:function(e){return this.translate(e.x,e.y)},isIdentity:function(){var e=this.val;return 1===e[0]&&0===e[1]&&0===e[2]&&1===e[3]&&0===e[4]&&0===e[5]},clone:function(){return new me.Matrix2d(this)},toString:function(){var e=this.val;return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"}})}(),function(){me.Matrix3d=Object.extend({init:function(e){this.val=new Float32Array(9),e?this.copy(e):this.identity()},adjoint:function(){var e=this.val,t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],h=e[7],l=e[8];return e[0]=o*l-s*h,e[1]=n*h-i*l,e[2]=i*s-n*o,e[3]=s*a-r*l,e[4]=t*l-n*a,e[5]=n*r-t*s,e[6]=r*h-o*a,e[7]=i*a-t*h,e[8]=t*o-i*r,this},isIdentity:function(){var e=this.val;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]},clone:function(){return new me.Matrix3d(this)},copy:function(e){var t=this.val,i=e.val;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this},determinant:function(){var e=this.val,t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],h=e[7],l=e[8];return t*(l*o-s*h)+i*(-l*r+s*a)+n*(h*r-o*a)},identity:function(){var e=this.val;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},invert:function(){var e=this.val,t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],h=e[7],l=e[8],u=l*o-s*h,d=-l*r+s*a,c=h*r-o*a,f=t*u+i*d+n*c;return f?(f=1/f,e[0]=u*f,e[1]=(-l*i+n*h)*f,e[2]=(s*i-n*o)*f,e[3]=d*f,e[4]=(l*t-n*a)*f,e[5]=(-s*t+n*r)*f,e[6]=c*f,e[7]=(-h*t+i*a)*f,e[8]=(o*t-i*r)*f,this):null},multiply:function(e){return this.multiplyArray(e.val)},multiplyArray:function(e){var t=this.val,i=e,n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],h=t[5],l=t[6],u=t[7],d=t[8],c=i[0],f=i[1],p=i[2],m=i[3],g=i[4],y=i[5],v=i[6],w=i[7],_=i[8];return t[0]=c*n+f*s+p*l,t[1]=c*r+f*a+p*u,t[2]=c*o+f*h+p*d,t[3]=m*n+g*s+y*l,t[4]=m*r+g*a+y*u,t[5]=m*o+g*h+y*d,t[6]=v*n+w*s+_*l,t[7]=v*r+w*a+_*u,t[8]=v*o+w*h+_*d,this},rotate:function(e){var t=this.val,i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],h=Math.sin(e),l=Math.cos(e);return t[0]=l*i+h*o,t[1]=l*n+h*s,t[2]=l*r+h*a,t[3]=l*o-h*i,t[4]=l*s-h*n,t[5]=l*a-h*r,this},scale:function(e,t){var i=this.val;return i[0]=e*i[0],i[1]=e*i[1],i[2]=e*i[2],i[3]=t*i[3],i[4]=t*i[4],i[5]=t*i[5],this},set:function(){var e=this.val;return e[0]=arguments[0],e[1]=arguments[1],e[2]=arguments[2],e[3]=arguments[3],e[4]=arguments[4],e[5]=arguments[5],e[6]=arguments[6],e[7]=arguments[7],e[8]=arguments[8],this},translate:function(e,t){var i=this.val;return i[6]=e*i[0]+t*i[3]+i[6],i[7]=e*i[1]+t*i[4]+i[7],i[8]=e*i[2]+t*i[5]+i[8],this},translateV:function(e){return this.translate(e.x,e.y)},transform:function(e,t,i,n,r,o){var s=this.val;return s[0]=e,s[1]=i,s[2]=r,s[3]=t,s[4]=n,s[5]=o,s[6]=0,s[7]=0,s[8]=1,this},transpose:function(){var e=this.val,t=e[1],i=e[2],n=e[5];return e[1]=e[3],e[2]=e[6],e[3]=t,e[5]=e[7],e[6]=i,e[7]=n,this},toString:function(){var e=this.val;return"mat3d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}})}(),function(){me.Body=me.Rect.extend({init:function(e,t){this.entity=e,this.shapes=t||[],this.collisionMask=me.collision.types.ALL_OBJECT,this.collisionType=me.collision.types.ENEMY_OBJECT,"undefined"==typeof this.vel&&(this.vel=new me.Vector2d),this.vel.set(0,0),"undefined"==typeof this.accel&&(this.accel=new me.Vector2d),this.accel.set(0,0),"undefined"==typeof this.friction&&(this.friction=new me.Vector2d),this.friction.set(0,0),"undefined"==typeof this.maxVel&&(this.maxVel=new me.Vector2d),this.maxVel.set(1e3,1e3),this.gravity="undefined"!=typeof me.sys.gravity?me.sys.gravity:.98,this.falling=!1,this.jumping=!0,this._super(me.Rect,"init",[0,0,e.width,e.height])},addShape:function(e){return this.shapes.push("Rectangle"===e.shapeType?e.toPolygon():e),this.updateBounds(),this.shapes.length},getShape:function(e){return this.shapes[e||0]},removeShape:function(e){return this.shapes.remove(e),this.updateBounds(),this.shapes.length},removeShapeAt:function(e){return this.removeShape(this.getShape(e))},setCollisionMask:function(e){this.collisionMask=e},respondToCollision:function(e){var t=e.overlapV;this.entity.pos.sub(t),0!==t.x&&(this.vel.x=~~(.5+this.vel.x-t.x)||0),0!==t.y&&(this.vel.y=~~(.5+this.vel.y-t.y)||0,this.falling=t.y>=1,this.jumping=t.y<=-1),this.entity.updateBounds()},updateBounds:function(){if(this.shapes.length>0){var e=this.shapes[0].getBounds();this.pos.setV(e.pos),this.resize(e.width,e.height);for(var t=1;t<this.shapes.length;t++)this.union(this.shapes[t].getBounds())}return this.entity.updateBounds(),this},setVelocity:function(e,t){this.accel.x=0!==e?e:this.accel.x,this.accel.y=0!==t?t:this.accel.y,this.setMaxVelocity(e,t)},setMaxVelocity:function(e,t){this.maxVel.x=e,this.maxVel.y=t},setFriction:function(e,t){this.friction.x=e||0,this.friction.y=t||0},computeVelocity:function(e){this.gravity&&(e.y+=this.gravity*me.timer.tick,this.falling=e.y>0,this.jumping=this.falling?!1:this.jumping),this.friction.x&&(e.x=me.utils.applyFriction(e.x,this.friction.x)),this.friction.y&&(e.y=me.utils.applyFriction(e.y,this.friction.y)),0!==e.y&&(e.y=e.y.clamp(-this.maxVel.y,this.maxVel.y)),0!==e.x&&(e.x=e.x.clamp(-this.maxVel.x,this.maxVel.x))},update:function(){return this.computeVelocity(this.vel),this.entity.pos.add(this.vel),this.entity.updateBounds(),0!==this.vel.x||0!==this.vel.y},destroy:function(){this.entity=null,this.shapes=[]}}),me.Body.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.Body.Error"}})}(),function(){function e(e,t,i,n){this.max_objects=t||4,this.max_levels=i||4,this.level=n||0,this.bounds=e,this.objects=[],this.nodes=[]}var t=[],i=function(e,i,n,r){if(t.length>0){var o=t.pop();return o.bounds=e,o.max_objects=i||4,o.max_levels=n||4,o.level=r||0,o}return new me.QuadTree(e,i,n,r)},n=function(e){t.push(e)};e.prototype.split=function(){var e=this.level+1,t=~~(.5+this.bounds.width/2),n=~~(.5+this.bounds.height/2),r=~~(.5+this.bounds.pos.x),o=~~(.5+this.bounds.pos.y);
this.nodes[0]=i({pos:{x:r+t,y:o},width:t,height:n},this.max_objects,this.max_levels,e),this.nodes[1]=i({pos:{x:r,y:o},width:t,height:n},this.max_objects,this.max_levels,e),this.nodes[2]=i({pos:{x:r,y:o+n},width:t,height:n},this.max_objects,this.max_levels,e),this.nodes[3]=i({pos:{x:r+t,y:o+n},width:t,height:n},this.max_objects,this.max_levels,e)},e.prototype.getIndex=function(e){var t=-1,i=this.bounds.pos.x+this.bounds.width/2,n=this.bounds.pos.y+this.bounds.height/2,r=e.pos.y<n&&e.pos.y+e.height<n,o=e.pos.y>n;return e.pos.x<i&&e.pos.x+e.width<i?r?t=1:o&&(t=2):e.pos.x>i&&(r?t=0:o&&(t=3)),t},e.prototype.insertContainer=function(e){for(var t,i=e.children.length;i--,t=e.children[i];)t instanceof me.Container?this.insertContainer(t):"undefined"!=typeof t.body&&this.insert(t)},e.prototype.insert=function(e){var t=-1;if(this.nodes.length>0&&(t=this.getIndex(e.getBounds()),-1!==t))return void this.nodes[t].insert(e);if(this.objects.push(e),this.objects.length>this.max_objects&&this.level<this.max_levels){0===this.nodes.length&&this.split();for(var i=0;i<this.objects.length;)t=this.getIndex(this.objects[i].getBounds()),-1!==t?this.nodes[t].insert(this.objects.splice(i,1)[0]):i+=1}},e.prototype.retrieve=function(e){var t=this.objects;if(this.nodes.length>0){var i=this.getIndex(e.getBounds());if(-1!==i)t=t.concat(this.nodes[i].retrieve(e));else for(var n=0;n<this.nodes.length;n+=1)t=t.concat(this.nodes[n].retrieve(e))}return t},e.prototype.clear=function(e){this.objects=[];for(var t=0;t<this.nodes.length;t+=1)this.nodes[t].clear(e),n(this.nodes[t]);this.nodes=[],"undefined"!=typeof e&&(this.bounds.pos.x=e.pos.x,this.bounds.pos.y=e.pos.y,this.bounds.width=e.width,this.bounds.height=e.height)},me.QuadTree=e}(),function(){function e(e,t,i){for(var n=Number.MAX_VALUE,r=-Number.MAX_VALUE,o=e.length,s=0;o>s;s++){var a=e[s].dotProduct(t);n>a&&(n=a),a>r&&(r=a)}i[0]=n,i[1]=r}function t(t,i,n,r,o,a){var l=h.pop(),u=h.pop(),d=s.pop().copy(i).sub(t),c=d.dotProduct(o);if(e(n,o,l),e(r,o,u),u[0]+=c,u[1]+=c,l[0]>u[1]||u[0]>l[1])return s.push(d),h.push(l),h.push(u),!0;if(a){var f=0;if(l[0]<u[0])if(a.aInB=!1,l[1]<u[1])f=l[1]-u[0],a.bInA=!1;else{var p=l[1]-u[0],m=u[1]-l[0];f=m>p?p:-m}else if(a.bInA=!1,l[1]>u[1])f=l[0]-u[1],a.aInB=!1;else{var g=l[1]-u[0],y=u[1]-l[0];f=y>g?g:-y}var v=Math.abs(f);v<a.overlap&&(a.overlap=v,a.overlapN.copy(o),0>f&&a.overlapN.reverse())}return s.push(d),h.push(l),h.push(u),!1}function i(e,t){var i=e.length2(),s=t.dotProduct(e);return 0>s?n:s>i?o:r}for(var n=-1,r=0,o=1,s=[],a=0;10>a;a++)s.push(new me.Vector2d);for(var h=[],l=0;5>l;l++)h.push([]);me.collision=function(){var e={};return e.quadTree=null,e.maxDepth=4,e.maxChildren=8,e.bounds=null,e.types={NO_OBJECT:0,PLAYER_OBJECT:1,NPC_OBJECT:2,ENEMY_OBJECT:4,COLLECTABLE_OBJECT:8,ACTION_OBJECT:16,PROJECTILE_OBJECT:32,WORLD_SHAPE:64,ALL_OBJECT:4294967295},e.init=function(){e.bounds=me.game.viewport.clone(),e.quadTree=new me.QuadTree(e.bounds,e.maxChildren,e.maxDepth),me.event.subscribe(me.event.LEVEL_LOADED,function(){me.collision.bounds=me.game.world.clone(),me.collision.quadTree.clear(me.collision.bounds)})},e.ResponseObject=function(){this.a=null,this.b=null,this.overlapN=new me.Vector2d,this.overlapV=new me.Vector2d,this.aInB=!0,this.bInA=!0,this.indexShapeA=-1,this.indexShapeB=-1,this.overlap=Number.MAX_VALUE},e.ResponseObject.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this.indexShapeA=-1,this.indexShapeB=-1,this},e.response=new e.ResponseObject,e.shouldCollide=function(e,t){return e.body&&t.body&&0!==(e.body.collisionMask&t.body.collisionType)&&0!==(e.body.collisionType&t.body.collisionMask)},e.check=function(t,i){for(var n,r=0,o=i||e.response,s=e.quadTree.retrieve(t),a=s.length;a--,n=s[a];)if(n!==t&&e.shouldCollide(t,n)&&t.getBounds().overlaps(n.getBounds())){var h=t.body.shapes.length,l=n.body.shapes.length;if(0===h||0===l)continue;var u=0;do{var d=t.body.getShape(u),c=0;do{var f=n.body.getShape(c);e["test"+d.shapeType+f.shapeType].call(this,t,d,n,f,o.clear())===!0&&(r++,o.indexShapeA=u,o.indexShapeB=c,t.onCollision(o,n)!==!1&&t.body.respondToCollision.call(t.body,o),n.onCollision(o,t)!==!1&&n.body.respondToCollision.call(n.body,o)),c++}while(l>c);u++}while(h>u)}return r>0},e.testPolygonPolygon=function(e,i,n,r,o){var a,h=i.points,l=i.normals,u=l.length,d=r.points,c=r.normals,f=c.length,p=s.pop().copy(e.pos).add(i.pos),m=s.pop().copy(n.pos).add(r.pos);for(a=0;u>a;a++)if(t(p,m,h,d,l[a],o))return s.push(p),s.push(m),!1;for(a=0;f>a;a++)if(t(p,m,h,d,c[a],o))return s.push(p),s.push(m),!1;return o&&(o.a=e,o.b=n,o.overlapV.copy(o.overlapN).scale(o.overlap)),s.push(p),s.push(m),!0},e.testEllipseEllipse=function(e,t,i,n,r){var o=s.pop().copy(i.pos).add(n.pos).sub(e.pos).sub(t.pos),a=t.radius,h=n.radius,l=a+h,u=l*l,d=o.length2();if(d>u)return s.push(o),!1;if(r){var c=Math.sqrt(d);r.a=e,r.b=i,r.overlap=l-c,r.overlapN.copy(o.normalize()),r.overlapV.copy(o).scale(r.overlap),r.aInB=h>=a&&h-a>=c,r.bInA=a>=h&&a-h>=c}return s.push(o),!0},e.testPolygonEllipse=function(e,t,r,a,h){for(var l=s.pop().copy(r.pos).add(a.pos).sub(e.pos).sub(t.pos),u=a.radius,d=u*u,c=t.points,f=t.edges,p=f.length,m=s.pop(),g=s.pop(),y=s.pop(),v=0,w=0;p>w;w++){var _=w===p-1?0:w+1,T=0===w?p-1:w-1,b=0,x=null;m.copy(f[w]),y.copy(l).sub(c[w]),h&&y.length2()>d&&(h.aInB=!1);var A=i(m,y),E=!0;if(A===n){var S=null;if(p>1&&(m.copy(f[T]),S=s.pop().copy(l).sub(c[T]),A=i(m,S),A!==o&&(E=!1)),E){if(v=y.length(),v>u)return s.push(l),s.push(m),s.push(g),s.push(y),S&&s.push(S),!1;h&&(h.bInA=!1,x=y.normalize(),b=u-v)}S&&s.push(S)}else if(A===o){if(p>1&&(m.copy(f[_]),y.copy(l).sub(c[_]),A=i(m,y),A!==n&&(E=!1)),E){if(v=y.length(),v>u)return s.push(l),s.push(m),s.push(g),s.push(y),!1;h&&(h.bInA=!1,x=y.normalize(),b=u-v)}}else{g.copy(t.normals[w]),v=y.dotProduct(g);var M=Math.abs(v);if((1===p||v>0)&&M>u)return s.push(l),s.push(m),s.push(g),s.push(y),!1;h&&(x=g,b=u-v,(v>=0||2*u>b)&&(h.bInA=!1))}x&&h&&Math.abs(b)<Math.abs(h.overlap)&&(h.overlap=b,h.overlapN.copy(x))}return h&&(h.a=e,h.b=r,h.overlapV.copy(h.overlapN).scale(h.overlap)),s.push(l),s.push(m),s.push(g),s.push(y),!0},e.testEllipsePolygon=function(t,i,n,r,o){var s=e.testPolygonEllipse(n,r,t,i,o);if(s&&o){var a=o.a,h=o.aInB;o.overlapN.reverse(),o.overlapV.reverse(),o.a=o.b,o.b=a,o.aInB=o.bInA,o.bInA=h}return s},e}()}(),function(){me.Renderable=me.Rect.extend({init:function(e,t,i,n){this.isRenderable=!0,this.GUID=void 0,this.inViewport=!1,this.alwaysUpdate=!1,this.updateWhenPaused=!1,this.isPersistent=!1,this.floating=!1,this.z=0/0,this.anchorPoint=new me.Vector2d,this.alpha=1,me.Rect.prototype.init.apply(this,[e,t,i,n]),this.anchorPoint.set(.5,.5),this.setOpacity(1)},getOpacity:function(){return this.alpha},setOpacity:function(e){"number"==typeof e&&(this.alpha=e.clamp(0,1),this.alpha!==this.alpha&&(this.alpha=1))},update:function(){return!1},draw:function(){}}),me.Renderable.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.Renderable.Error"}})}(),function(){me.Sprite=me.Renderable.extend({init:function(e,t,i,n,r){this._scale=new me.Vector2d,this.scaleFlag=!1,this.lastflipX=!1,this.lastflipY=!1,this.z=0,this.offset=new me.Vector2d,this.angle=0,this._sourceAngle=0,this.image=null,this.flickering=!1,this.flickerDuration=0,this.flickercb=null,this.flickerState=!1,this.isSprite=!0,me.Renderable.prototype.init.apply(this,[e,t,n||i.width,r||i.height]),this.image=i,this._scale.set(1,1),this.lastflipX=this.lastflipY=!1,this.scaleFlag=!1,this.offset.set(0,0),this.isPersistent=!1,this.flickering=!1},setTransparency:function(e){e="#"===e.charAt(0)?e.substring(1,7):e,this.image=me.video.renderer.applyRGBFilter(this.image,"transparent",e.toUpperCase()).canvas},isFlickering:function(){return this.flickering},flicker:function(e,t){this.flickerDuration=e,this.flickerDuration<=0?(this.flickering=!1,this.flickercb=null):this.flickering||(this.flickercb=t,this.flickering=!0)},flipX:function(e){e!==this.lastflipX&&(this.lastflipX=e,this._scale.x=-this._scale.x,this.scaleFlag=1!==this._scale.x||1!==this._scale.y)},flipY:function(e){e!==this.lastflipY&&(this.lastflipY=e,this._scale.y=-this._scale.y,this.scaleFlag=1!==this._scale.x||1!==this._scale.y)},scale:function(e,t){var i=e,n="undefined"==typeof t?e:t;i>0&&(this._scale.x=this._scale.x<0?-i:i),n>0&&(this._scale.y=this._scale.y<0?-n:n),this.scaleFlag=1!==this._scale.x||1!==this._scale.y},scaleV:function(e){this.scale(e.x,e.y)},update:function(e){return this.flickering?(this.flickerDuration-=e,this.flickerDuration<0&&(this.flickercb&&this.flickercb(),this.flicker(-1)),!0):!1},draw:function(e){if(!this.flickering||(this.flickerState=!this.flickerState,this.flickerState)){e.save(),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity());var t=~~this.pos.x,i=~~this.pos.y,n=this.width,r=this.height,o=this.angle+this._sourceAngle;if(this.scaleFlag||0!==o){var s=n*this.anchorPoint.x,a=r*this.anchorPoint.y;e.translate(t+s,i+a),this.scaleFlag&&e.scale(this._scale.x,this._scale.y),0!==o&&e.rotate(o),0!==this._sourceAngle?(n=this.height,r=this.width,t=-a,i=-s):(t=-s,i=-a)}e.drawImage(this.image,this.offset.x,this.offset.y,n,r,t,i,n,r),e.restore()}},destroy:function(){this.onDestroyEvent.apply(this,arguments)},onDestroyEvent:function(){}})}(),function(){me.AnimationSheet=me.Sprite.extend({init:function(e,t,i){this.spacing=0,this.margin=0,this.animationpause=!1,this.animationspeed=100,this.anim={},this.resetAnim=null,this.current=null,this.animationspeed=100,this.spacing=i.spacing||0,this.margin=i.margin||0;var n=i.region||i.image;me.Sprite.prototype.init.apply(this,[e,t,i.image,i.spritewidth,i.spriteheight,this.spacing,this.margin]),this.textureAtlas=null,this.atlasIndices=null,this.buildLocalAtlas(i.atlas,i.atlasIndices,n),this.addAnimation("default",null),this.setCurrentAnimation("default")},buildLocalAtlas:function(e,t,i){if((null===i||"undefined"==typeof i)&&(i=this.image),"undefined"!=typeof e)this.textureAtlas=e,this.atlasIndices=t;else{if(this.textureAtlas=[],(i.width-this.margin)%(this.width+this.spacing)!==0||(i.height-this.margin)%(this.height+this.spacing)!==0)throw new me.Renderable.Error("Animation sheet for image: "+i.src+" is not divisible by "+(this.width+this.spacing)+"x"+(this.height+this.spacing));var n=new me.Vector2d(~~((i.width-this.margin)/(this.width+this.spacing)),~~((i.height-this.margin)/(this.height+this.spacing))),r=0,o=0;i.offset&&(r=i.offset.x,o=i.offset.y);for(var s=0,a=n.x*n.y;a>s;s++)this.textureAtlas[s]={name:""+s,offset:new me.Vector2d(this.margin+(this.spacing+this.width)*(s%n.x)+r,this.margin+(this.spacing+this.height)*~~(s/n.x)+o),width:this.width,height:this.height,hWidth:this.width/2,hHeight:this.height/2,angle:0}}},addAnimation:function(e,t,i){if(this.anim[e]={name:e,frame:[],idx:0,length:0,animationspeed:i||this.animationspeed,nextFrame:0},null==t){t=[];var n=0;this.textureAtlas.forEach(function(){t[n]=n++})}for(var r=0,o=t.length;o>r;r++)if("number"==typeof t[r])this.anim[e].frame[r]=this.textureAtlas[t[r]];else{if(null===this.atlasIndices)throw new me.Renderable.Error("string parameters for addAnimation are only allowed for TextureAtlas");this.anim[e].frame[r]=this.textureAtlas[this.atlasIndices[t[r]]]}this.anim[e].length=this.anim[e].frame.length},setCurrentAnimation:function(e,t){if(!this.anim[e])throw new me.Renderable.Error("animation id '"+e+"' not defined");this.current=this.anim[e],this.resetAnim=t||null,this.setAnimationFrame(this.current.idx),this.current.nextFrame=this.current.animationspeed},isCurrentAnimation:function(e){return this.current.name===e},setAnimationFrame:function(e){this.current.idx=(e||0)%this.current.length;var t=this.current.frame[this.current.idx];this.offset=t.offset,this.width=t.width,this.height=t.height,this.hWidth=t.hWidth,this.hHeight=t.hHeight,this._sourceAngle=t.angle},getCurrentAnimationFrame:function(){return this.current.idx},update:function(e){if(!this.animationpause&&this.current.length>1&&(this.current.nextFrame-=e,this.current.nextFrame<=0)){if(this.setAnimationFrame(++this.current.idx),0===this.current.idx&&this.resetAnim)if("string"==typeof this.resetAnim)this.setCurrentAnimation(this.resetAnim);else if("function"==typeof this.resetAnim&&this.resetAnim()===!1)return this.current.idx=this.current.length-1,this.setAnimationFrame(this.current.idx),me.Sprite.prototype.update.apply(this,[e]),!1;return this.current.nextFrame=this.current.animationspeed,me.Sprite.prototype.update.apply(this,[e])||!0}return me.Sprite.prototype.update.apply(this,[e])}})}(),function(){var e=-(Math.PI/2);me.TextureAtlas=Object.extend({init:function(e,t){if(this.format=null,this.texture=t||null,this.atlas=e||null,e&&e.meta){if(e.meta.app.contains("texturepacker"))if(this.format="texturepacker","undefined"==typeof t){var i=me.utils.getBasename(e.meta.image);if(this.texture=me.loader.getImage(i),null===this.texture)throw new me.TextureAtlas.Error("Atlas texture '"+i+"' not found")}else this.texture=t;if(e.meta.app.contains("ShoeBox")){if(!e.meta.exporter||!e.meta.exporter.contains("melonJS"))throw new me.TextureAtlas.Error("ShoeBox requires the JSON exporter : https://github.com/melonjs/melonJS/tree/master/media/shoebox_JSON_export.sbx");this.format="ShoeBox",this.texture=t}this.atlas=this.initFromTexturePacker(e)}if(null===this.atlas)throw new me.TextureAtlas.Error("texture atlas format not supported")},initFromTexturePacker:function(e){var t={};return e.frames.forEach(function(e){e.hasOwnProperty("filename")&&(t[e.filename]={frame:new me.Rect(e.frame.x,e.frame.y,e.frame.w,e.frame.h),source:new me.Rect(e.spriteSourceSize.x,e.spriteSourceSize.y,e.spriteSourceSize.w,e.spriteSourceSize.h),rotated:e.rotated===!0,trimmed:e.trimmed===!0})}),t},getTexture:function(){return this.texture},getRegion:function(t){var i=this.atlas[t];return i?{name:t,pos:i.source.pos.clone(),offset:i.frame.pos.clone(),width:i.frame.width,height:i.frame.height,hWidth:i.frame.width/2,hHeight:i.frame.height/2,angle:i.rotated===!0?e:0}:null},createSpriteFromName:function(e){var t=this.getRegion(e);if(t){var i=new me.Sprite(0,0,this.getTexture(),t.width,t.height);return i.offset.setV(t.offset),i._sourceAngle=t.angle,i}throw new me.TextureAtlas.Error("TextureAtlas - region for "+e+" not found")},createAnimationFromName:function(e){for(var t=[],i={},n=0;n<e.length;++n)if(t[n]=this.getRegion(e[n]),i[e[n]]=n,null==t[n])throw new me.TextureAtlas.Error("TextureAtlas - region for "+e[n]+" not found");return new me.AnimationSheet(0,0,{image:this.texture,spritewidth:0,spriteheight:0,margin:0,spacing:0,atlas:t,atlasIndices:i})}}),me.TextureAtlas.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.TextureAtlas.Error"}})}(),function(){var e=Math.min,t=Math.max;me.Viewport=me.Renderable.extend({init:function(e,t,i,n){this.AXIS={NONE:0,HORIZONTAL:1,VERTICAL:2,BOTH:3},this.bounds=null,this.deadzone=null,this.target=null,this.follow_axis=0,this._shake=null,this._fadeIn=null,this._fadeOut=null,this.screenX=0,this.screenY=0,me.Renderable.prototype.init.apply(this,[e,t,i-e,n-t]),this.bounds=new me.Rect(-1/0,-1/0,1/0,1/0),this.offset=new me.Vector2d,this.target=null,this.follow_axis=this.AXIS.NONE,this._shake={intensity:0,duration:0,axis:this.AXIS.BOTH,onComplete:null},this._fadeOut={color:null,duration:0,tween:null},this._fadeIn={color:null,duration:0,tween:null},this.setDeadzone(this.width/6,this.height/6)},_followH:function(i){var n=this.pos.x;return i.x-this.pos.x>this.deadzone.right?this.pos.x=~~e(i.x-this.deadzone.right,this.bounds.width-this.width):i.x-this.pos.x<this.deadzone.pos.x&&(this.pos.x=~~t(i.x-this.deadzone.pos.x,this.bounds.pos.x)),n!==this.pos.x},_followV:function(i){var n=this.pos.y;return i.y-this.pos.y>this.deadzone.bottom?this.pos.y=~~e(i.y-this.deadzone.bottom,this.bounds.height-this.height):i.y-this.pos.y<this.deadzone.pos.y&&(this.pos.y=~~t(i.y-this.deadzone.pos.y,this.bounds.pos.y)),n!==this.pos.y},reset:function(e,t){this.pos.x=e||0,this.pos.y=t||0,this.target=null,this.follow_axis=null},setDeadzone:function(e,t){null===this.deadzone&&(this.deadzone=new me.Rect(0,0,0,0)),this.deadzone.pos.set(~~((this.width-e)/2),~~((this.height-t)/2-.25*t)),this.deadzone.resize(e,t),this.updateTarget()},setBounds:function(e,t,i,n){this.bounds.pos.set(e,t),this.bounds.resize(i,n)},follow:function(e,t){if(e instanceof me.Entity)this.target=e.pos;else{if(!(e instanceof me.Vector2d))throw new me.Renderable.Error("invalid target for viewport.follow");this.target=e}this.follow_axis="undefined"==typeof t?this.AXIS.BOTH:t,this.updateTarget()},move:function(e,t){this.moveTo(~~(this.pos.x+e),~~(this.pos.y+t))},moveTo:function(e,t){this.pos.x=(~~e).clamp(this.bounds.pos.x,this.bounds.width-this.width),this.pos.y=(~~t).clamp(this.bounds.pos.y,this.bounds.height-this.height),me.event.publish(me.event.VIEWPORT_ONCHANGE,[this.pos])},updateTarget:function(){var e=!1;if(this.target)switch(this.follow_axis){case this.AXIS.NONE:break;case this.AXIS.HORIZONTAL:e=this._followH(this.target);break;case this.AXIS.VERTICAL:e=this._followV(this.target);break;case this.AXIS.BOTH:e=this._followH(this.target),e=this._followV(this.target)||e}return e},update:function(e){var t=this.updateTarget();return this._shake.duration>0&&(this._shake.duration-=e,this._shake.duration<=0?(this._shake.duration=0,this.offset.setZero(),"function"==typeof this._shake.onComplete&&this._shake.onComplete()):((this._shake.axis===this.AXIS.BOTH||this._shake.axis===this.AXIS.HORIZONTAL)&&(this.offset.x=(Math.random()-.5)*this._shake.intensity),(this._shake.axis===this.AXIS.BOTH||this._shake.axis===this.AXIS.VERTICAL)&&(this.offset.y=(Math.random()-.5)*this._shake.intensity)),t=!0),t===!0&&me.event.publish(me.event.VIEWPORT_ONCHANGE,[this.pos]),(null!=this._fadeIn.tween||null!=this._fadeOut.tween)&&(t=!0),t},shake:function(e,t,i,n){this._shake.duration>0||(this._shake={intensity:e,duration:t,axis:i||this.AXIS.BOTH,onComplete:n})},fadeOut:function(e,t,i){this._fadeOut.color=me.pool.pull("me.Color").copy(e),this._fadeOut.color.alpha=1,this._fadeOut.duration=t||1e3,this._fadeOut.tween=me.pool.pull("me.Tween",this._fadeOut.color).to({alpha:0},this._fadeOut.duration).onComplete(i||null),this._fadeOut.tween.start()},fadeIn:function(e,t,i){this._fadeIn.color=me.pool.pull("me.Color").copy(e),this._fadeIn.color.alpha=0,this._fadeIn.duration=t||1e3,this._fadeIn.tween=me.pool.pull("me.Tween",this._fadeIn.color).to({alpha:1},this._fadeIn.duration).onComplete(i||null),this._fadeIn.tween.start()},getWidth:function(){return this.width},getHeight:function(){return this.height},focusOn:function(e){var t=e.getBounds();this.moveTo(e.pos.x+t.pos.x+t.width/2,e.pos.y+t.pos.y+t.height/2)},isVisible:function(e){return e.overlaps(this)},localToWorld:function(e,t,i){return i=i||new me.Vector2d,i.set(e,t).add(this.pos).sub(me.game.currentLevel.pos)},worldToLocal:function(e,t,i){return i=i||new me.Vector2d,i.set(e,t).sub(this.pos).add(me.game.currentLevel.pos)},draw:function(){this._fadeIn.tween&&(me.video.renderer.clearSurface(null,this._fadeIn.color),1===this._fadeIn.color.alpha&&(this._fadeIn.tween=null,me.pool.push(this._fadeIn.color),this._fadeIn.color=null)),this._fadeOut.tween&&(me.video.renderer.clearSurface(null,this._fadeOut.color),0===this._fadeOut.color.alpha&&(this._fadeOut.tween=null,me.pool.push(this._fadeOut.color),this._fadeOut.color=null))}})}(),function(){me.GUI_Object=me.Sprite.extend({init:function(e,t,i){this.isClickable=!0,this.holdThreshold=250,this.isHoldable=!1,this.holdTimeout=null,this.updated=!1,this.released=!0,me.Sprite.prototype.init.apply(this,[e,t,"string"==typeof i.image?me.loader.getImage(i.image):i.image,i.spritewidth,i.spriteheight]),this.floating=!0,me.input.registerPointerEvent("pointerdown",this,this.clicked.bind(this)),me.input.registerPointerEvent("pointerup",this,this.release.bind(this))},update:function(){return this.updated?(this.released||(this.updated=!1),!0):!1},clicked:function(e){return this.isClickable?(this.updated=!0,this.isHoldable&&(null!==this.holdTimeout&&me.timer.clearTimeout(this.holdTimeout),this.holdTimeout=me.timer.setTimeout(this.hold.bind(this),this.holdThreshold,!1),this.released=!1),this.onClick(e)):void 0},onClick:function(){return!1},release:function(e){return this.released=!0,me.timer.clearTimeout(this.holdTimeout),this.onRelease(e)},onRelease:function(){return!1},hold:function(){me.timer.clearTimeout(this.holdTimeout),this.released||this.onHold()},onHold:function(){},onDestroyEvent:function(){me.input.releasePointerEvent("pointerdown",this),me.input.releasePointerEvent("pointerup",this),me.timer.clearTimeout(this.holdTimeout)}})}(),function(){var e=function(e,t){e.ancestor&&e.ancestor.removeChildNow(e,t)},t=new me.Rect(0,0,0,0),i=0;me.Container=me.Renderable.extend({init:function(e,t,i,n){this.pendingSort=null,this.transform=new me.Matrix2d,me.Renderable.prototype.init.apply(this,[e,t,i||1/0,n||1/0]),this.bounds=void 0,this.children=[],this.sortOn=me.game.sortOn,this.autoSort=!0,this.transform.identity(),this.drawCount=0},addChild:function(e,t){return"undefined"!=typeof e.ancestor?e.ancestor.removeChildNow(e):e.isRenderable&&(e.GUID=me.utils.createGUID()),"number"==typeof t&&(e.z=t),("undefined"==typeof e.z||e.z!==e.z)&&(e.z=this.children.length),e.ancestor=this,this.children.push(e),this.autoSort===!0&&this.sort(),"function"==typeof e.onActivateEvent&&e.onActivateEvent(),e},addChildAt:function(e,t){if(t>=0&&t<this.children.length)return"undefined"!=typeof e.ancestor?e.ancestor.removeChildNow(e):e.isRenderable&&(e.GUID=me.utils.createGUID()),e.ancestor=this,this.children.splice(t,0,e),"function"==typeof e.onActivateEvent&&e.onActivateEvent(),e;throw new me.Container.Error("Index ("+t+") Out Of Bounds for addChildAt()")},swapChildren:function(e,t){var i=this.getChildIndex(e),n=this.getChildIndex(t);if(-1===i||-1===n)throw new me.Container.Error(e+" Both the supplied childs must be a child of the caller "+this);var r=e.z;e.z=t.z,t.z=r,this.children[i]=t,this.children[n]=e},getChildAt:function(e){if(e>=0&&e<this.children.length)return this.children[e];throw new me.Container.Error("Index ("+e+") Out Of Bounds for getChildAt()")},getChildIndex:function(e){return this.children.indexOf(e)},hasChild:function(e){return this===e.ancestor},getChildByProp:function(e,t){function i(e,i){"string"==typeof e[i]?e[i].match(r)&&n.push(e):e[i]===t&&n.push(e)}for(var n=[],r=new RegExp(t,"i"),o=this.children.length-1;o>=0;o--){var s=this.children[o];s instanceof me.Container?(i(s,e),n=n.concat(s.getChildByProp(e,t))):i(s,e)}return n},getChildByName:function(e){return this.getChildByProp("name",e)},getChildByGUID:function(e){var t=this.getChildByProp("GUID",e);return t.length>0?t[0]:null},getBounds:function(){this.bounds?(this.bounds.pos.set(1/0,1/0),this.bounds.resize(-1/0,-1/0)):this.bounds=new me.Rect(1/0,1/0,-1/0,-1/0);for(var e,t,i=this.children.length;i--,t=this.children[i];)t.isRenderable&&(e=t.getBounds(),null!==e&&this.bounds.union(e));return this.bounds},removeChild:function(t,i){t.ancestor&&e.defer(this,t,i)},removeChildNow:function(e,t){if(!this.hasChild(e))throw new me.Container.Error(e+" The supplied child must be a child of the caller "+this);e.ancestor=void 0,"function"==typeof e.onDeactivateEvent&&e.onDeactivateEvent(),t||("function"==typeof e.destroy&&e.destroy(),me.pool.push(e)),this.children.splice(this.getChildIndex(e),1)},setChildsProperty:function(e,t,i){for(var n=this.children.length;n>=0;n--){var r=this.children[n];i===!0&&r instanceof me.Container&&r.setChildsProperty(e,t,i),r[e]=t}},moveUp:function(e){var t=this.getChildIndex(e);t-1>=0&&this.swapChildren(e,this.getChildAt(t-1))},moveDown:function(e){var t=this.getChildIndex(e);t+1<this.children.length&&this.swapChildren(e,this.getChildAt(t+1))},moveToTop:function(e){var t=this.getChildIndex(e);t>0&&(this.children.splice(0,0,this.children.splice(t,1)[0]),e.z=this.children[1].z+1)},moveToBottom:function(e){var t=this.getChildIndex(e);t<this.children.length-1&&(this.children.splice(this.children.length-1,0,this.children.splice(t,1)[0]),e.z=this.children[this.children.length-2].z-1)},sort:function(e){if(null===this.pendingSort){if(e===!0)for(var t,i=this.children.length;i--,t=this.children[i];)t instanceof me.Container&&t.sort(e);this.pendingSort=function(e){e.children.sort(e["_sort"+e.sortOn.toUpperCase()]),e.pendingSort=null,me.game.repaint()}.defer(this,this)}},_sortZ:function(e,t){return t.z-e.z},_sortX:function(e,t){var i=t.z-e.z;return i?i:(t.pos&&t.pos.x)-(e.pos&&e.pos.x)||0},_sortY:function(e,t){var i=t.z-e.z;return i?i:(t.pos&&t.pos.y)-(e.pos&&e.pos.y)||0},destroy:function(){this.pendingSort&&(clearTimeout(this.pendingSort),this.pendingSort=null);for(var e,t=this.children.length;t--,e=this.children[t];)e.isPersistent||this.removeChildNow(e);this.transform.identity()},update:function(e){for(var n,r=!1,o=!1,s=me.state.isPaused(),a=!1,h=!1,l=[],u=0,d=0,c=0,f=me.game.viewport,p=this.children.length;p--,n=this.children[p];)(!s||n.updateWhenPaused)&&(n.isRenderable?(o=i>0||n.floating,o&&i++,a=!o,a&&(u=n.pos.x,d=n.pos.y,c=Math.abs(u+d+n.width+n.height),(c!==c||1/0===c)&&(h=!0,l.push(t.clone())),t.translateV(n.pos),t.resize(n.width,n.height)),n.inViewport=o||f.isVisible(t),r=(n.inViewport||n.alwaysUpdate)&&n.update(e)||r,a&&(h?(h=!1,t.copy(l.pop())):t.translate(-u,-d)),i>0&&i--):r=n.update(e)||r);return r},draw:function(e,t){var i=me.game.viewport,n=!1;this.drawCount=0,e.save(),e.transform.apply(e,this.transform.val),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity()),e.translate(this.pos.x,this.pos.y);for(var r,o=this.children.length;o--,r=this.children[o];)n=r.floating,(r.inViewport||n)&&r.isRenderable&&(n===!0&&e.translate(i.screenX-this.pos.x,i.screenY-this.pos.y),r.draw(e,t),n===!0&&e.translate(this.pos.x-i.screenX,this.pos.y-i.screenY),this.drawCount++);e.restore()}}),me.Container.Error=me.Renderable.Error.extend({init:function(e){me.Renderable.Error.prototype.init.apply(this,[e]),this.name="me.Container.Error"}})}(),function(){me.Entity=me.Renderable.extend({init:function(e,t,i){if(this.renderable=null,this.bounds=void 0,"number"!=typeof i.width||"number"!=typeof i.height)throw new me.Entity.Error("height and width properties are mandatory when passing settings parameters to an object entity");if(me.Renderable.prototype.init.apply(this,[e,t,i.width,i.height]),i.image){var n="object"==typeof i.image?i.image:me.loader.getImage(i.image);this.renderable=new me.AnimationSheet(0,0,{image:n,spritewidth:~~(i.spritewidth||i.width),spriteheight:~~(i.spriteheight||i.height),spacing:~~i.spacing,margin:~~i.margin}),i.transparent_color&&this.renderable.setTransparency(i.transparent_color)}if(this.name=i.name?i.name.toLowerCase():"",this.type=i.type,this.alive=!0,this.body=new me.Body(this,"function"==typeof i.getTMXShapes?i.getTMXShapes():[]),this.body.updateBounds(),0===this.width&&0===this.height&&this.resize(this.body.width,this.body.height),"undefined"!=typeof i.collisionMask&&this.body.setCollisionMask(i.collisionMask),"undefined"!=typeof i.collisionType){if("undefined"==typeof me.collision.types[i.collisionType])throw new me.Entity.Error("Invalid value for the collisionType property");this.body.collisionType=me.collision.types[i.collisionType]}},getBounds:function(){return this.bounds},updateBounds:function(){return this.bounds||(this.bounds=new me.Rect(0,0,0,0)),this.bounds.pos.setV(this.pos).add(this.body.pos),this.bounds.resize(this.body.width,this.body.height),this.bounds},distanceTo:function(e){var t=this.pos.x+this.width/2-(e.pos.x+e.width/2),i=this.pos.y+this.height/2-(e.pos.y+e.height/2);return Math.sqrt(t*t+i*i)},distanceToPoint:function(e){var t=this.pos.x+this.width/2-e.x,i=this.pos.y+this.height/2-e.y;return Math.sqrt(t*t+i*i)},angleTo:function(e){var t=this.getBounds(),i=e.getBounds(),n=i.pos.x+i.width/2-(t.pos.x+t.width/2),r=i.pos.y+i.height/2-(t.pos.y+t.height/2);return Math.atan2(r,n)},angleToPoint:function(e){var t=this.getBounds(),i=e.x-(t.pos.x+t.width/2),n=e.y-(t.pos.y+t.height/2);return Math.atan2(n,i)},update:function(e){return this.renderable?this.renderable.update(e):!1},draw:function(e){if(this.renderable){var t=this.getBounds(),i=~~(.5+t.pos.x+this.anchorPoint.x*(t.width-this.renderable.width)),n=~~(.5+t.pos.y+this.anchorPoint.y*(t.height-this.renderable.height));e.translate(i,n),this.renderable.draw(e),e.translate(-i,-n)}},destroy:function(){this.renderable&&(this.renderable.destroy.apply(this.renderable,arguments),this.renderable=null),this.body.destroy.apply(this.body,arguments),this.body=null},onDestroyEvent:function(){},onCollision:function(){return!1}}),me.CollectableEntity=me.Entity.extend({init:function(e,t,i){me.Entity.prototype.init.apply(this,[e,t,i]),this.body.collisionType=me.collision.types.COLLECTABLE_OBJECT}}),me.LevelEntity=me.Entity.extend({init:function(e,t,i){me.Entity.prototype.init.apply(this,[e,t,i]),this.nextlevel=i.to,this.fade=i.fade,this.duration=i.duration,this.fading=!1,this.name="levelEntity",this.gotolevel=i.to,this.body.collisionType=me.collision.types.ACTION_OBJECT},onFadeComplete:function(){me.levelDirector.loadLevel(this.gotolevel),me.game.viewport.fadeOut(this.fade,this.duration)},goTo:function(e){this.gotolevel=e||this.nextlevel,this.fade&&this.duration?this.fading||(this.fading=!0,me.game.viewport.fadeIn(this.fade,this.duration,this.onFadeComplete.bind(this))):me.levelDirector.loadLevel(this.gotolevel)},onCollision:function(){return"levelEntity"===this.name&&this.goTo(),!1}}),me.Entity.Error=me.Renderable.Error.extend({init:function(e){me.Renderable.Error.prototype.init.apply(this,[e]),this.name="me.Entity.Error"}})}(),function(){me.ScreenObject=Object.extend({init:function(){},reset:function(){me.game.reset(),this.onResetEvent.apply(this,arguments)},destroy:function(){this.onDestroyEvent.apply(this,arguments)},onResetEvent:function(){},onDestroyEvent:function(){}}),function(){var e=0,t=1e3/60,i=me.agent.prefixed("requestAnimationFrame"),n=me.agent.prefixed("cancelAnimationFrame")||me.agent.prefixed("cancelRequestAnimationFrame");i&&n||(i=function(i){var n=window.performance.now(),r=Math.max(0,t-(n-e)),o=window.setTimeout(function(){i(n+r)},r);return e=n+r,o},n=function(e){window.clearTimeout(e)}),window.requestAnimationFrame=i,window.cancelAnimationFrame=n}(),me.state=function(){function e(){-1===h&&-1!==a&&(me.timer.reset(),h=window.requestAnimationFrame(n))}function t(){l&&-1!==a&&(me.timer.reset(),l=!1)}function i(){l=!0}function n(e){me.game.update(e),me.game.draw(),-1!==h&&(h=window.requestAnimationFrame(n))}function r(){window.cancelAnimationFrame(h),h=-1}function o(t){r(),u[a]&&u[a].screen.destroy(),u[t]&&(a=t,u[a].screen.reset.apply(u[a].screen,f),e(),c&&c(),me.game.repaint())}var s={},a=-1,h=-1,l=!1,u={},d={color:"",duration:0},c=null,f=null,p=0;return s.LOADING=0,s.MENU=1,s.READY=2,s.PLAY=3,s.GAMEOVER=4,s.GAME_END=5,s.SCORE=6,s.CREDITS=7,s.SETTINGS=8,s.USER=100,s.onPause=null,s.onResume=null,s.onStop=null,s.onRestart=null,s.init=function(){s.set(s.LOADING,new me.DefaultLoadingScreen)},s.stop=function(e){a!==s.LOADING&&s.isRunning()&&(r(),e===!0&&me.audio.pauseTrack(),p=window.performance.now(),me.event.publish(me.event.STATE_STOP),"function"==typeof s.onStop&&s.onStop())},s.pause=function(e){a===s.LOADING||s.isPaused()||(i(),e===!0&&me.audio.pauseTrack(),p=window.performance.now(),me.event.publish(me.event.STATE_PAUSE),"function"==typeof s.onPause&&s.onPause())},s.restart=function(t){s.isRunning()||(e(),t===!0&&me.audio.resumeTrack(),p=window.performance.now()-p,me.game.repaint(),me.event.publish(me.event.STATE_RESTART,[p]),"function"==typeof s.onRestart&&s.onRestart())},s.resume=function(e){s.isPaused()&&(t(),e===!0&&me.audio.resumeTrack(),p=window.performance.now()-p,me.event.publish(me.event.STATE_RESUME,[p]),"function"==typeof s.onResume&&s.onResume())},s.isRunning=function(){return-1!==h},s.isPaused=function(){return l},s.set=function(e,t){u[e]={},u[e].screen=t,u[e].transition=!0},s.current=function(){return u[a].screen},s.transition=function(e,t,i){"fade"===e&&(d.color=t,d.duration=i)
},s.setTransition=function(e,t){u[e].transition=t},s.change=function(e){if("undefined"==typeof u[e])throw new me.Error("Undefined ScreenObject for state '"+e+"'");f=null,arguments.length>1&&(f=Array.prototype.slice.call(arguments,1)),d.duration&&u[e].transition?(c=function(){me.game.viewport.fadeOut(d.color,d.duration)},me.game.viewport.fadeIn(d.color,d.duration,function(){o.defer(this,e)})):o.defer(this,e)},s.isCurrent=function(e){return a===e},s}()}(),function(){var e=me.Renderable.extend({init:function(e,t,i){me.Renderable.prototype.init.apply(this,[e.x,e.y,t,i]),this.invalidate=!1,this.barHeight=4,this.progress=0},onProgressUpdate:function(e){this.progress=~~(e*this.width),this.invalidate=!0},update:function(){return this.invalidate===!0?(this.invalidate=!1,!0):!1},draw:function(e){e.setColor("#000000"),e.fillRect(0,this.height/2-this.barHeight/2,this.width,this.barHeight),e.setColor("#55aa00"),e.fillRect(2,this.height/2-this.barHeight/2,this.progress,this.barHeight)}}),t=me.Renderable.extend({init:function(e,t,i){me.Renderable.prototype.init.apply(this,[t,i,100,85]),this.iconCanvas=e;var n=me.CanvasRenderer.getContext2d(this.iconCanvas);n.translate(this.pos.x,this.pos.y),n.beginPath(),n.moveTo(.7,48.9),n.bezierCurveTo(10.8,68.9,38.4,75.8,62.2,64.5),n.bezierCurveTo(86.1,53.1,97.2,27.7,87,7.7),n.lineTo(87,7.7),n.bezierCurveTo(89.9,15.4,73.9,30.2,50.5,41.4),n.bezierCurveTo(27.1,52.5,5.2,55.8,.7,48.9),n.lineTo(.7,48.9),n.lineTo(.7,48.9),n.closePath(),n.fillStyle="rgb(255, 255, 255)",n.fill(),n.beginPath(),n.moveTo(84,7),n.bezierCurveTo(87.6,14.7,72.5,30.2,50.2,41.6),n.bezierCurveTo(27.9,53,6.9,55.9,3.2,48.2),n.bezierCurveTo(-.5,40.4,14.6,24.9,36.9,13.5),n.bezierCurveTo(59.2,2.2,80.3,-.8,84,7),n.lineTo(84,7),n.closePath(),n.lineWidth=5.3,n.strokeStyle="rgb(255, 255, 255)",n.lineJoin="miter",n.miterLimit=4,n.stroke()},draw:function(e){e.drawImage(this.iconCanvas,0,0)}}),i=me.Renderable.extend({init:function(e,t){me.Renderable.prototype.init.apply(this,[0,0,e,t]),this.logo1=new me.Font("century gothic",32,"white","middle"),this.logo2=new me.Font("century gothic",32,"#55aa00","middle"),this.logo2.bold(),this.logo1.textBaseline=this.logo2.textBaseline="alphabetic"},draw:function(e){var t=e.measureText(this.logo1,"melon").width,i=(this.width-t-e.measureText(this.logo2,"JS").width)/2,n=this.height/2+e.measureText(this.logo2,"melon").height;e.drawFont(this.logo1,"melon",i,n),i+=t,e.drawFont(this.logo2,"JS",i,n)}});me.DefaultLoadingScreen=me.ScreenObject.extend({onResetEvent:function(){me.game.reset(),me.game.world.addChild(new me.ColorLayer("background","#202020",0));var n=new e(new me.Vector2d,me.video.renderer.getWidth(),me.video.renderer.getHeight());this.handle=me.event.subscribe(me.event.LOADER_PROGRESS,n.onProgressUpdate.bind(n)),me.game.world.addChild(n,1),this.iconCanvas=me.video.createCanvas(me.game.viewport.width,me.game.viewport.height,!1);var r=new t(this.iconCanvas,(me.video.renderer.getWidth()-100)/2,me.video.renderer.getHeight()/2-n.barHeight/2-90);me.game.world.addChild(r,1),me.game.world.addChild(new i(me.video.renderer.getWidth(),me.video.renderer.getHeight()),1)},onDestroyEvent:function(){this.handle&&(me.event.unsubscribe(this.handle),this.handle=null)}})}(),function(){me.loader=function(){function e(){d===u?o.onload?(clearTimeout(c),setTimeout(function(){o.onload(),me.event.publish(me.event.LOADER_COMPLETE)},300)):console.error("no load callback defined"):c=setTimeout(e,100)}function t(e,t,i){s[e.name]=new Image,s[e.name].onload=t,s[e.name].onerror=i,s[e.name].src=e.src+o.nocache}function i(e,t,i){function n(t,i){a[e.name]={data:t,isTMX:"tmx"===e.type,format:i}}if("tmx"===e.type&&me.levelDirector.addTMXLevel(e.name),e.data)return n(e.data,e.format),void t();var r=new XMLHttpRequest,s=me.utils.getFileExtension(e.src).toLowerCase();r.overrideMimeType&&r.overrideMimeType("json"===s?"application/json":"text/xml"),r.open("GET",e.src+o.nocache,!0),r.ontimeout=i,r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0===r.status&&r.responseText){var e=null;switch(s){case"xml":case"tmx":case"tsx":e=me.device.ua.match(/msie/i)||!r.responseXML?(new DOMParser).parseFromString(r.responseText,"text/xml"):r.responseXML,e=me.TMXUtils.parse(e),"tmx"===s&&(e=e.map),s="json";break;case"json":e=JSON.parse(r.responseText);break;default:throw new o.Error("TMX file format "+s+"not supported !")}n(e,s),t()}else i()},r.send(null)}function n(e,t,i){var n=new XMLHttpRequest;n.overrideMimeType&&n.overrideMimeType("application/json"),n.open("GET",e.src+o.nocache,!0),n.ontimeout=i,n.onreadystatechange=function(){4===n.readyState&&(200===n.status||0===n.status&&n.responseText?(l[e.name]=JSON.parse(n.responseText),t()):i())},n.send(null)}function r(e,t,i){var n=new XMLHttpRequest;n.open("GET",e.src+o.nocache,!0),n.responseType="arraybuffer",n.onerror=i,n.onload=function(){var i=n.response;if(i){for(var r=new Uint8Array(i),o=[],s=0;s<r.byteLength;s++)o[s]=String.fromCharCode(r[s]);h[e.name]=o.join(""),t()}},n.send()}var o={},s={},a={},h={},l={},u=0,d=0,c=0;return o.nocache="",o.onload=void 0,o.onProgress=void 0,o.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.loader.Error"}}),o.onResourceLoaded=function(e){d++;var t=o.getLoadProgress();o.onProgress&&o.onProgress(t,e),me.event.publish(me.event.LOADER_PROGRESS,[t,e])},o.onLoadingError=function(e){throw new o.Error("Failed loading resource "+e.src)},o.setNocache=function(e){o.nocache=e?"?"+~~(1e7*Math.random()):""},o.preload=function(t){for(var i=0;i<t.length;i++)u+=o.load(t[i],o.onResourceLoaded.bind(o,t[i]),o.onLoadingError.bind(o,t[i]));e()},o.load=function(e,s,a){switch(e.name=e.name.toLowerCase(),e.type){case"binary":return r.call(this,e,s,a),1;case"image":return t.call(this,e,s,a),1;case"json":return n.call(this,e,s,a),1;case"tmx":case"tsx":return i.call(this,e,s,a),1;case"audio":return me.audio.load(e,s,a),1;default:throw new o.Error("load : unknown or invalid resource type : "+e.type)}},o.unload=function(e){switch(e.name=e.name.toLowerCase(),e.type){case"binary":return e.name in h?(delete h[e.name],!0):!1;case"image":return e.name in s?("function"==typeof s[e.name].dispose&&s[e.name].dispose(),delete s[e.name],!0):!1;case"json":return e.name in l?(delete l[e.name],!0):!1;case"tmx":case"tsx":return e.name in a?(delete a[e.name],!0):!1;case"audio":return me.audio.unload(e.name);default:throw new o.Error("unload : unknown or invalid resource type : "+e.type)}},o.unloadAll=function(){var e;for(e in h)h.hasOwnProperty(e)&&o.unload({name:e,type:"binary"});for(e in s)s.hasOwnProperty(e)&&o.unload({name:e,type:"image"});for(e in a)a.hasOwnProperty(e)&&o.unload({name:e,type:"tmx"});for(e in l)l.hasOwnProperty(e)&&o.unload({name:e,type:"json"});me.audio.unloadAll()},o.getTMX=function(e){return e=""+e,e=e.toLowerCase(),e in a?a[e].data:null},o.getBinary=function(e){return e=""+e,e=e.toLowerCase(),e in h?h[e]:null},o.getImage=function(e){return e=""+e,e=e.toLowerCase(),e in s?s[e]:null},o.getJSON=function(e){return e=""+e,e=e.toLowerCase(),e in l?l[e]:null},o.getLoadProgress=function(){return d/u},o}()}(),function(){me.Font=me.Renderable.extend({init:function(e,t,i,n){this.fontSize=new me.Vector2d,this.fillStyle=i||"#000000",this.strokeStyle="#000000",this.lineWidth=1,this.textAlign=n||"left",this.textBaseline="top",this.lineHeight=1,this.setFont(e,t,i,n),this.pos=new me.Vector2d(0,0),me.Renderable.prototype.init.apply(this,[this.pos.x,this.pos.y,0,this.fontSize.y]),this.gid||(this.gid=me.utils.createGUID())},bold:function(){this.font="bold "+this.font},italic:function(){this.font="italic "+this.font},setFont:function(e,t,i,n){var r=e.split(",").map(function(e){return e=e.trim(),/(^".*"$)|(^'.*'$)/.test(e)?e:'"'+e+'"'});this.fontSize.y=+t,this.height=this.fontSize.y,"number"==typeof t&&(t+="px"),this.font=t+" "+r.join(","),this.fillStyle=i,n&&(this.textAlign=n)},measureText:function(e,t){e.font=this.font,e.fillStyle=this.fillStyle,e.textAlign=this.textAlign,e.textBaseline=this.textBaseline,this.height=this.width=0;for(var i=(""+t).split("\n"),n=0;n<i.length;n++)this.width=Math.max(e.measureText(i[n].trimRight()).width,this.width),this.height+=this.fontSize.y*this.lineHeight;return{width:this.width,height:this.height}},draw:function(e,t,i,n){i=~~i,n=~~n;var r=e.globalAlpha;e.globalAlpha*=this.getOpacity(),this.pos.set(i,n),e.font=this.font,e.fillStyle=this.fillStyle,e.textAlign=this.textAlign,e.textBaseline=this.textBaseline;for(var o=(""+t).split("\n"),s=0;s<o.length;s++)e.fillText(o[s].trimRight(),i,n),n+=this.fontSize.y*this.lineHeight;e.globalAlpha=r},drawStroke:function(e,t,i,n){i=~~i,n=~~n;var r=e.globalAlpha;e.globalAlpha*=this.getOpacity(),this.pos.set(i,n),e.font=this.font,e.fillStyle=this.fillStyle,e.strokeStyle=this.strokeStyle,e.lineWidth=this.lineWidth,e.textAlign=this.textAlign,e.textBaseline=this.textBaseline;for(var o=(""+t).split("\n"),s=0;s<o.length;s++){var a=o[s].trimRight();e.strokeText(a,i,n),e.fillText(a,i,n),n+=this.fontSize.y*this.lineHeight}e.globalAlpha=r}})}(),function(){me.BitmapFont=me.Font.extend({init:function(e,t,i,n){this.sSize=new me.Vector2d,this.firstChar=32,this.charCount=0,me.Font.prototype.init.apply(this,[e,null,null]),this.firstChar=n||32,this.loadFontMetrics(e,t),this.textAlign="left",this.textBaseline="top",i&&this.resize(i)},loadFontMetrics:function(e,t){this.font=me.loader.getImage(e),this.fontSize.x=t.x||t,this.fontSize.y=t.y||this.font.height,this.sSize.copy(this.fontSize),this.height=this.sSize.y,this.charCount=~~(this.font.width/this.fontSize.x)},set:function(e,t){this.textAlign=e,t&&this.resize(t)},resize:function(e){this.sSize.setV(this.fontSize),this.sSize.x*=e,this.sSize.y*=e,this.height=this.sSize.y},measureText:function(e,t){var i=(""+t).split("\n");this.height=this.width=0;for(var n=0;n<i.length;n++)this.width=Math.max(i[n].trimRight().length*this.sSize.x,this.width),this.height+=this.sSize.y*this.lineHeight;return{width:this.width,height:this.height}},draw:function(e,t,i,n){var r=(""+t).split("\n"),o=i,s=this.sSize.y*this.lineHeight,a=e.globalAlpha();e.setGlobalAlpha(a*this.getOpacity()),this.pos.set(i,n);for(var h=0;h<r.length;h++){i=o;var l=r[h].trimRight(),u=l.length*this.sSize.x;switch(this.textAlign){case"right":i-=u;break;case"center":i-=.5*u}switch(this.textBaseline){case"middle":n-=.5*s;break;case"ideographic":case"alphabetic":case"bottom":n-=s}for(var d=0,c=l.length;c>d;d++){var f=l.charCodeAt(d)-this.firstChar;f>=0&&e.drawImage(this.font,this.fontSize.x*(f%this.charCount),this.fontSize.y*~~(f/this.charCount),this.fontSize.x,this.fontSize.y,~~i,~~n,this.sSize.x,this.sSize.y),i+=this.sSize.x}n+=s}e.setGlobalAlpha(a)}})}(),function(){me.audio=function(){function e(e,n){if(r++>3){var o="melonJS: failed loading "+e;if(me.sys.stopOnAudioError!==!1)throw new t.Error(o);me.audio.disable(),n&&n(),console.log(o+", disabling audio")}else i[e].load()}var t={},i={},n=null,r=0;return t.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.audio.Error"}}),t.init=function(e){if(!me.initialized)throw new t.Error("me.audio.init() called before engine initialization.");return e="string"==typeof e?e:"mp3",this.audioFormats=e.split(","),!Howler.noAudio},t.enable=function(){this.unmuteAll()},t.disable=function(){this.muteAll()},t.load=function(n,o,s){var a=[];if("undefined"==typeof this.audioFormats||0===this.audioFormats.length)throw new t.Error("target audio extension(s) should be set through me.audio.init() before calling the preloader.");for(var h=0;h<this.audioFormats.length;h++)a.push(n.src+n.name+"."+this.audioFormats[h]+me.loader.nocache);return i[n.name]=new Howl({src:a,volume:Howler.volume(),onloaderror:function(){i[n.name]=this,e.call(me.audio,n.name,s)},onload:function(){i[n.name]=this,r=0,o&&o()}}),1},t.play=function(e,t,n,r){var o=i[e.toLowerCase()];if(o&&"undefined"!=typeof o){var s=o.play();return"boolean"==typeof t&&o.loop(t,s),o.volume("number"==typeof r?r.clamp(0,1):Howler.volume(),s),"function"==typeof n&&(t===!0?o.on("end",n,s):o.once("end",n,s)),s}},t.fade=function(e,t,n,r,o){var s=i[e.toLowerCase()];s&&"undefined"!=typeof s&&s.fade(t,n,r,o)},t.stop=function(e,t){var n=i[e.toLowerCase()];n&&"undefined"!=typeof n&&(n.stop(t),n.off("end",t))},t.pause=function(e,t){var n=i[e.toLowerCase()];n&&"undefined"!=typeof n&&n.pause(t)},t.playTrack=function(e,t){return n=e.toLowerCase(),me.audio.play(n,!0,null,t)},t.stopTrack=function(){null!==n&&(i[n].stop(),n=null)},t.pauseTrack=function(){null!==n&&i[n].pause()},t.resumeTrack=function(){null!==n&&i[n].play()},t.getCurrentTrack=function(){return n},t.setVolume=function(e){Howler.volume(e)},t.getVolume=function(){return Howler.volume()},t.mute=function(e,t,n){n="undefined"==typeof n?!0:!!n;var r=i[e.toLowerCase()];r&&"undefined"!=typeof r&&r.mute(n,t)},t.unmute=function(e,i){t.mute(e,i,!1)},t.muteAll=function(){Howler.mute(!0)},t.unmuteAll=function(){Howler.mute(!1)},t.unload=function(e){return e=e.toLowerCase(),e in i?(i[e].unload(),delete i[e],!0):!1},t.unloadAll=function(){for(var e in i)i.hasOwnProperty(e)&&t.unload(e)},t}()}(),function(){me.CanvasRenderer=function(){var e={},t=null,i=null,n=null,r=null,o=null,s=null,a=[],h=0,l=0;return e.init=function(a,u,d,c,f,p){return t=a,i=this.getContext2d(t),n=c,n?(r=me.video.createCanvas(u,d,!1),o=this.getContext2d(r)):(r=t,o=i),l=f,h=p,s=new me.Color(255,255,255,1),e.setColor(s),this},e.applyRGBFilter=function(t,i,n){var r,o,s=e.getContext2d(me.video.createCanvas(t.width,t.height,!1)),a=me.utils.getPixels(t),h=a.data;switch(i){case"b&w":for(r=0,o=h.length;o>r;r+=4){var l=3*h[r]+4*h[r+1]+h[r+2]>>>3;h[r]=l,h[r+1]=l,h[r+2]=l}break;case"brightness":var u=Math.abs(n).clamp(0,1);for(r=0,o=h.length;o>r;r+=4)h[r]*=u,h[r+1]*=u,h[r+2]*=u;break;case"transparent":var d=me.pool.pull("me.Color").parseCSS(n),c=me.pool.pull("me.Color");for(r=0,o=h.length;o>r;r+=4)c.setColor(h[r],h[r+1],h[r+2]),c.equals(d)&&(h[r+3]=0);me.pool.push(d),me.pool.push(c);break;default:return null}return s.putImageData(a,0,0),s},e.blitSurface=function(){e.blitSurface=n?function(){i.drawImage(r,0,0,r.width,r.height,0,0,l,h)}:function(){},e.blitSurface()},e.clearSurface=function(e,t){e||(e=o);var i=e.canvas;e.save(),e.setTransform(1,0,0,1,0,0),e.fillStyle=t instanceof me.Color?t.toRGBA():t,e.fillRect(0,0,i.width,i.height),e.restore()},e.drawFont=function(e,t,i,n){e.draw(o,t,i,n)},e.drawLine=function(e,t,i,n){o.translate(e,t),o.beginPath(),o.moveTo(0,0),o.lineTo(i,n),o.stroke(),o.closePath(),o.translate(-e,-t)},e.drawImage=function(){o.drawImage.apply(o,arguments)},e.fillArc=function(e,t,i,n,r,s){o.save(),o.beginPath(),o.translate(e+i,t+i),o.arc(0,0,i,n,r,s||!1),o.fill(),o.closePath(),o.restore()},e.fillRect=function(e,t,i,n){o.fillRect(e,t,i,n)},e.getScreenCanvas=function(){return t},e.getScreenContext=function(){return i},e.getContext2d=function(e){if("undefined"==typeof e||null===e)throw new me.video.Error("You must pass a canvas element in order to create a 2d context");if("undefined"==typeof e.getContext)throw new me.video.Error("Your browser does not support HTML5 canvas.");var t;return t=navigator.isCocoonJS?e.getContext("2d",{antialias:me.sys.scalingInterpolation}):e.getContext("2d"),t.canvas||(t.canvas=e),this.setImageSmoothing(t,me.sys.scalingInterpolation),t},e.getCanvas=function(){return r},e.getColor=function(){return s.clone()},e.getContext=function(){return o},e.getWidth=function(){return r.width},e.getHeight=function(){return r.height},e.globalAlpha=function(){return s.alpha},e.measureText=function(e,t){return e.measureText(o,t)},e.resetTransform=function(){o.setTransform(1,0,0,1,0,0)},e.resize=function(e,n){t.width=l=r.width*e,t.height=h=r.height*n,me.device.getPixelRatio()>1&&(t.style.width=t.width/me.device.getPixelRatio()+"px",t.style.height=t.height/me.device.getPixelRatio()+"px"),this.setImageSmoothing(i,me.sys.scalingInterpolation),this.blitSurface()},e.save=function(){a.push(e.getColor()),o.save()},e.restore=function(){var t=a.pop();me.pool.push("me.Color",t),o.restore(),e.setColor(t)},e.rotate=function(e){o.rotate(e)},e.scale=function(e,t){o.scale(e,t)},e.setAlpha=function(e){o.globalCompositeOperation=e?"source-over":"copy"},e.setColor=function(e){s.copy(e),o.strokeStyle=o.fillStyle=s.toRGBA()},e.setGlobalAlpha=function(e){s.setColor(s.r,s.g,s.b,e),o.globalAlpha=e},e.setImageSmoothing=function(e,t){me.agent.setPrefixed("imageSmoothingEnabled",t===!0,e)},e.setLineWidth=function(e){o.lineWidth=e},e.strokeArc=function(e,t,i,n,r,s){o.beginPath(),o.translate(e+i,t+i),o.arc(0,0,i,n,r,s||!1),o.stroke(),o.closePath()},e.strokeEllipse=function(e,t,n,r){i.beginPath();var s=n,a=r,h=e-s,l=e+s,u=t-a,d=t+a,c=.551784*s,f=.551784*a,p=e-c,m=e+c,g=t-f,y=t+f;o.moveTo(e,u),o.bezierCurveTo(m,u,l,g,l,t),o.bezierCurveTo(l,y,m,d,e,d),o.bezierCurveTo(p,d,h,y,h,t),o.bezierCurveTo(h,g,p,u,e,u),o.stroke()},e.strokeLine=function(e,t,n,r){i.beginPath(),i.moveTo(e,t),i.lineTo(n,r),i.stroke()},e.strokePolygon=function(e){o.translate(e.pos.x,e.pos.y),o.beginPath(),o.moveTo(e.points[0].x,e.points[0].y);for(var t,i=1;i<e.points.length;i++)t=e.points[i],o.lineTo(t.x,t.y);o.lineTo(e.points[0].x,e.points[0].y),o.stroke(),o.closePath(),o.translate(-e.pos.x,-e.pos.y)},e.strokeRect=function(e,t,i,n){o.strokeRect(e,t,i,n)},e.drawShape=function(t){t instanceof me.Rect?e.strokeRect(t.left,t.top,t.width,t.height):t instanceof me.Line||t instanceof me.Polygon?(e.save(),e.strokePolygon(t),e.restore()):t instanceof me.Ellipse&&(e.save(),t.radiusV.x===t.radiusV.y?e.strokeArc(t.pos.x-t.radius,t.pos.y-t.radius,t.radius,0,2*Math.PI):e.strokeEllipse(t.pos.x,t.pos.y,t.radiusV.x,t.radiusV.y),e.restore())},e.transform=function(){o.transform(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5])},e.translate=function(e,t){o.translate(e,t)},e}()}(),function(){me.video=function(){function e(){try{return me.WebGLRenderer.init.apply(me.WebGLRenderer,arguments)}catch(e){return me.CanvasRenderer.init.apply(me.CanvasRenderer,arguments)}}var t={},i=null,n=null,r=-1,o=!1,s=!1,a=!0,h=1/0,l=1/0;return t.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.video.Error"}}),t.CANVAS=0,t.WEBGL=1,t.AUTO=2,t.init=function(r,h,l,u,d,c,f){if(!me.initialized)throw new t.Error("me.video.init() called before engine initialization.");o=d||!1,s="auto"===c||!1,a="undefined"!=typeof f?f:!0,c=s?1:+c||1,me.sys.scale=new me.Vector2d(c,c),(s||1!==c)&&(o=!0);var p=l*me.sys.scale.x,m=u*me.sys.scale.y;if(window.addEventListener("resize",throttle(100,!1,function(e){me.event.publish(me.event.WINDOW_ONRESIZE,[e])}),!1),window.addEventListener("orientationchange",function(e){me.event.publish(me.event.WINDOW_ONORIENTATION_CHANGE,[e])},!1),me.event.subscribe(me.event.WINDOW_ONRESIZE,me.video.onresize.bind(me.video)),me.event.subscribe(me.event.WINDOW_ONORIENTATION_CHANGE,me.video.onresize.bind(me.video)),i=t.createCanvas(p,m,!0),r&&(n=document.getElementById(r)),n||(n=document.body),n.appendChild(i),!i.getContext)return!1;switch(h){case t.WEBGL:this.renderer=me.WebGLRenderer.init(i,l,u);break;case t.AUTO:this.renderer=e(i,l,u,o,p,m);break;default:this.renderer=me.CanvasRenderer.init(i,l,u,o,p,m)}var g=me.device.getPixelRatio();if(g>1&&(i.style.width=i.width/g+"px",i.style.height=i.height/g+"px"),window.getComputedStyle){var y=window.getComputedStyle(i,null);me.video.setMaxSize(parseInt(y.maxWidth,10),parseInt(y.maxHeight,10))}return me.video.onresize(),me.game.init(),!0},t.getPos=function(e){return e=e||this.renderer.getScreenCanvas(),e.getBoundingClientRect?e.getBoundingClientRect():{left:0,top:0}},t.setMaxSize=function(e,t){h=e||1/0,l=t||1/0},t.createCanvas=function(e,n,r){if(0===e||0===n)throw new t.Error("width or height was zero, Canvas could not be initialized !");var o=document.createElement("canvas");return r===!0&&navigator.isCocoonJS&&me.device.android2!==!0&&(o.screencanvas=!0),o.width=e||i.width,o.height=n||i.height,o},t.getWrapper=function(){return n},t.onresize=function(){var e=1,t=1;if(me.device.orientation="undefined"!=typeof window.orientation?window.orientation:window.outerWidth>window.outerHeight?90:0,s){var i=me.video.renderer.getScreenCanvas().parentNode,n=Math.min(h,i.width||window.innerWidth),o=Math.min(l,i.height||window.innerHeight);if(a){var u=me.video.renderer.getWidth()/me.video.renderer.getHeight(),d=n/o;e=t=u>d?n/me.video.renderer.getWidth():o/me.video.renderer.getHeight()}else e=n/me.video.renderer.getWidth(),t=o/me.video.renderer.getHeight();if(e*=me.device.getPixelRatio(),t*=me.device.getPixelRatio(),1!==e||1!==t)return r>=0&&clearTimeout(r),void(r=me.video.updateDisplaySize.defer(this,e,t))}me.input._offset=me.video.getPos()},t.updateDisplaySize=function(e,t){me.sys.scale.set(e,t),this.renderer.resize(e,t),me.input._offset=me.video.getPos(),r=-1},t.setAlpha=function(e){this.renderer.setAlpha(e)},t}()}(),function(){me.video.shader=function(){function e(e,t,i){var n=e.createShader(t);if(e.shaderSource(n,i),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new me.video.Error(e.getShaderInfoLog(n));return n}var t={attributes:{},uniforms:{},handle:null},i="precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec4 uColor;\nuniform sampler2D texture;\nvoid main(void) {\n    gl_FragColor = texture2D(texture, vec2(vTexCoord.s, vTexCoord.t)) * uColor;\n}\n",n="attribute vec2 aPosition;\nattribute vec2 aTexture;\nuniform mat3 uMatrix;\nuniform mat3 pMatrix;\nvarying vec2 vTexCoord;\nvoid main(void) {\n   gl_Position = vec4((pMatrix * (uMatrix * vec3(aPosition, 1))).xy, 0, 1);\n   vTexCoord = aTexture;\n}\n";return t.bind=function(){},t.createShader=function(r){var o=t.handle=r.createProgram();if(r.attachShader(o,e(r,r.VERTEX_SHADER,n)),r.attachShader(o,e(r,r.FRAGMENT_SHADER,i)),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS))throw new me.video.Error("Could not initialize shaders");r.useProgram(o);var s={},a={};["aPosition","aTexture"].forEach(function(e){a[e]={location:r.getAttribLocation(o,e)},r.enableVertexAttribArray(a[e].location),s[e]={get:function(e){return function(){return a[e]}}(e)}}),Object.defineProperties(t.attributes,s);var h={},l={};return["pMatrix","uMatrix","uColor","texture"].forEach(function(e){l[e]={location:r.getUniformLocation(o,e)},h[e]={get:function(e){return function(){return l[e]}}(e),set:function(e){return"uColor"===e?function(t){r.uniform4fv(l[e].location,t)}:"texture"===e?function(){r.uniform1i(l[e].location,0)}:function(t){r.uniformMatrix3fv(l[e].location,!1,t)}}(e)}}),Object.defineProperties(t.uniforms,h),t},t.gltexture2d=function(e,t){var i=e.createTexture(),n=me.sys.scalingInterpolation?e.LINEAR:e.NEAREST;return i.bind=function(){return e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i),i},i.bind(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),i},t}()}(),function(){me.WebGLRenderer=function(){var e={},t=null,i=[],n=null,r={},o=null,s=null,a=null,h=null,l=new Float32Array(8),u=new Float32Array(8),d=[],c=null,f=null,p=null,m=new Float32Array(12),g=null,y=new Float32Array(12),v=null;return e.init=function(e,i,r){return t=e,a=this.getContextGL(e),a.FALSE=!1,a.TRUE=!0,n={width:i,height:r},this.uniformMatrix=new me.Matrix3d,this.projection=new me.Matrix3d({val:new Float32Array([2/i,0,0,0,-2/r,0,-1,1,1])}),this.createShader(),f.bind(),a.enableVertexAttribArray(f.attributes.aTexture.location),a.enableVertexAttribArray(f.attributes.aPosition.location),h=new me.Color(255,255,255,1),o=me.video.createCanvas(i,r,!1),s=me.CanvasRenderer.getContext2d(o),v=a.createTexture(),a.bindTexture(a.TEXTURE_2D,v),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,1,1,0,a.RGBA,a.UNSIGNED_BYTE,new Uint8Array([255,255,255,255])),this.createBuffers(),a.clearColor(0,0,0,1),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),g=a.getUniformLocation(f.handle,"texture"),this.resize(1,1),this},e.applyProjection=function(){f.uniforms.pMatrix=this.projection.val},e.bindTexture=function(e){var t=e.width,i=e.height;e.texture=me.video.shader.gltexture2d(a,e),e.vb=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,e.vb),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,t,0,0,i,t,i]),a.STATIC_DRAW),e.t={};var n="0,0,"+t+","+i;this.cacheTextureCoords(e,n,0,0,t,i),e.ib=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.ib),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,1,3]),a.STATIC_DRAW)},e.bindTextureCoords=function(e,t,i,n,r){var o=t+","+i+","+n+","+r;o in e.t?a.bindBuffer(a.ARRAY_BUFFER,e.t[o]):this.cacheTextureCoords(e,o,t,i,n,r)},e.cacheTextureCoords=function(e,t,i,n,r,o){r=(i+r)/e.width,o=(n+o)/e.height,i/=e.width,n/=e.height,e.t[t]=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,e.t[t]),a.bufferData(a.ARRAY_BUFFER,new Float32Array([i,n,r,n,i,o,r,o]),a.STATIC_DRAW)},e.blitSurface=function(){},e.clearSurface=function(e,n){e||(e=a),i.push(this.getColor()),this.setColor(n),this.fillRect(0,0,t.width,t.height),this.setColor(i.pop())},e.createBuffers=function(){p=a.createBuffer(),c=a.createBuffer()},e.createShader=function(){f=me.video.shader.createShader(a)},e.drawFont=function(e,i,n,a){var h,l=e.gid;if(r[l]){var u=r[l];if(e.font!==u.font||e.fontSize!==u.fontSize||e.fillStyle!==u.fillStyle||e.textAlign!==u.textAlign||e.textBaseline!==u.textBaseline||e.lineHeight!==u.lineHeight||i!==u.text){switch(u.font=e.font,u.fontSize=e.fontSize,u.fillStyle=e.fillStyle,u.textAlign=e.textAlign,u.textBaseline=e.textBaseline,u.lineHeight=e.lineHeight,u.text=i,e.draw(s,i,n,a),h=e.measureText(s,i),u.yOffset=0,u.textBaseline){case"alphabetic":case"ideographic":case"bottom":u.yOffset=h.height;break;case"middle":u.yOffset=h.height/2}u.width=h.width,u.height=1.2*h.height,u.image=s.getImageData(0,0,o.width,o.height),s.clearRect(0,0,t.width,t.height)}}else{switch(e.draw(s,i,n,a),h=e.measureText(s,i),r[l]={font:e.font,fontSize:e.fontSize,fillStyle:e.fillStyle,textAlign:e.textAlign,textBaseline:e.textBaseline,lineHeight:e.lineHeight,text:e.text,image:s.getImageData(0,0,o.width,o.height),width:h.width,height:1.2*h.height,yOffset:0},e.textBaseline){case"alphabetic":case"ideographic":case"bottom":r[l].yOffset=h.height;break;case"middle":r[l].yOffset=h.height/2}s.clearRect(0,0,t.width,t.height)}a-=r[l].yOffset,this.drawImage(r[l].image,n,a,r[l].width,r[l].height,n,a,r[l].width,r[l].height)},e.drawLine=function(){},e.drawImage=function(e,t,i,n,r,o,s,l,u){"undefined"==typeof e.texture&&this.bindTexture(e),"undefined"==typeof n?(n=l=e.width,r=u=e.height,o=t,s=i,t=0,i=0):"undefined"==typeof o&&(o=t,s=i,l=n,u=r,n=e.width,r=e.height,t=0,i=0),d.push(this.uniformMatrix.clone()),this.uniformMatrix.translate(~~o,~~s),this.uniformMatrix.scale(l/e.width,u/e.height),a.bindBuffer(a.ARRAY_BUFFER,e.vb),a.vertexAttribPointer(f.attributes.aPosition.location,2,a.FLOAT,!1,0,0),this.bindTextureCoords(e,~~t,~~i,~~n,~~r),a.vertexAttribPointer(f.attributes.aTexture.location,2,a.FLOAT,!1,0,0),f.uniforms.texture=e.texture.bind(),f.uniforms.uMatrix=this.uniformMatrix.val,f.uniforms.uColor=h.toGL(),a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0),this.uniformMatrix.copy(d.pop())},e.fillRect=function(e,t,i,n){var r=e,o=t,s=e+i,l=t+n;y[0]=r,y[1]=o,y[2]=s,y[3]=o,y[4]=r,y[5]=l,y[6]=r,y[7]=l,y[8]=s,y[9]=o,y[10]=s,y[11]=l,a.bindBuffer(a.ARRAY_BUFFER,c),a.bufferData(a.ARRAY_BUFFER,y,a.STATIC_DRAW),a.vertexAttribPointer(f.attributes.aPosition.location,2,a.FLOAT,!1,0,0),m[0]=0,m[1]=0,m[2]=1,m[3]=0,m[4]=0,m[5]=1,m[6]=0,m[7]=1,m[8]=1,m[9]=0,m[10]=1,m[11]=1,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,v),a.bindBuffer(a.ARRAY_BUFFER,p),a.bufferData(a.ARRAY_BUFFER,m,a.STATIC_DRAW),a.vertexAttribPointer(f.attributes.aTexture.location,2,a.FLOAT,!1,0,0),a.uniform1i(g,0),f.uniforms.uMatrix=this.uniformMatrix.val,f.uniforms.uColor=h.toGL(),a.drawArrays(a.TRIANGLES,0,6)},e.getScreenCanvas=function(){return t},e.getScreenContext=function(){return a},e.getContextGL=function(e){if("undefined"==typeof e||null===e)throw new me.video.Error("You must pass a canvas element in order to create a GL context");if("undefined"==typeof e.getContext)throw new me.video.Error("Your browser does not support WebGL.");var t={antialias:me.sys.scalingInterpolation};return e.getContext("webgl",t)||e.getContext("experimental-webgl",t)},e.getCanvas=function(){return t},e.getColor=function(){return h.clone()},e.getContext=function(){return a},e.getWidth=function(){return a.canvas.width},e.getHeight=function(){return a.canvas.height},e.globalAlpha=function(){return h.alpha},e.measureText=function(e,t){return e.measureText(s,t)},e.resetTransform=function(){this.uniformMatrix.identity()},e.resize=function(e,i){t.width=n.width,t.height=n.height;var r=n.width*e,o=n.height*i;me.device.getPixelRatio()>1?(t.style.width=r/me.device.getPixelRatio()+"px",t.style.height=o/me.device.getPixelRatio()+"px"):(t.style.width=r+"px",t.style.height=o+"px"),a.viewport(0,0,n.width,n.height),this.setProjection(),this.applyProjection()},e.restore=function(){var e=i.pop();me.pool.push("me.Color",e),h.copy(e),this.uniformMatrix.copy(d.pop())},e.rotate=function(e){this.uniformMatrix.rotate(e)},e.save=function(){i.push(this.getColor()),d.push(this.uniformMatrix.clone())},e.scale=function(e,t){this.uniformMatrix.scale(e,t)},e.setAlpha=function(){},e.setProjection=function(){this.projection.set(2/t.width,0,0,0,-2/t.height,0,-1,1,1)},e.setImageSmoothing=function(){},e.setGlobalAlpha=function(e){h.setColor(h.r,h.g,h.b,e)},e.setColor=function(e){h.copy(e)},e.setLineWidth=function(){},e.strokeArc=function(){},e.strokeEllipse=function(){},e.strokeLine=function(){},e.strokePolygon=function(){},e.strokeRect=function(e,t,i,n){var r=e,o=t,s=e+i,d=t+n;u[0]=r,u[1]=o,u[2]=s,u[3]=o,u[4]=s,u[5]=d,u[6]=r,u[7]=d,a.bindBuffer(a.ARRAY_BUFFER,c),a.bufferData(a.ARRAY_BUFFER,u,a.STATIC_DRAW),a.vertexAttribPointer(f.attributes.aPosition.location,2,a.FLOAT,!1,0,0),l[0]=0,l[1]=0,l[2]=1,l[3]=0,l[4]=1,l[5]=1,l[6]=0,l[7]=1,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,v),a.bindBuffer(a.ARRAY_BUFFER,p),a.bufferData(a.ARRAY_BUFFER,l,a.STATIC_DRAW),a.vertexAttribPointer(f.attributes.aTexture.location,2,a.FLOAT,!1,0,0),a.uniform1i(g,0),f.uniforms.uMatrix=this.uniformMatrix.val,f.uniforms.uColor=h.toGL(),a.drawArrays(a.LINE_LOOP,0,4)},e.drawShape=function(t){t instanceof me.Rect?e.strokeRect(t.left,t.top,t.width,t.height):t instanceof me.Line||t instanceof me.Polygon?(e.save(),e.strokePolygon(t),e.restore()):t instanceof me.Ellipse&&(e.save(),t.radiusV.x===t.radiusV.y?e.strokeArc(t.pos.x-t.radius,t.pos.y-t.radius,t.radius,0,2*Math.PI):e.strokeEllipse(t.pos.x,t.pos.y,t.radiusV.x,t.radiusV.y),e.restore())},e.transform=function(){var e=new Float32Array(9);e[0]=arguments[0],e[1]=arguments[1],e[2]=0,e[3]=arguments[2],e[4]=arguments[3],e[5]=0,e[6]=arguments[4],e[7]=arguments[5],e[8]=1,this.uniformMatrix.multiplyArray(e)},e.translate=function(e,t){this.uniformMatrix.translate(e,t)},e}()}(),function(){me.input=function(){var e={};return e._preventDefault=function(e){return e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault?e.preventDefault():e.returnValue=!1,!1},e.preventDefault=!0,e}()}(),function(){var e=me.input;e._KeyBinding={};var t={},i={},n={},r={},o={},s=!1;e._enableKeyboardEvent=function(){s||(window.addEventListener("keydown",e._keydown,!1),window.addEventListener("keyup",e._keyup,!1),s=!0)},e._keydown=function(i,s,a){s=s||i.keyCode||i.which;var h=e._KeyBinding[s];if(me.event.publish(me.event.KEYDOWN,[h,s,h?!n[h]:!0]),h){if(!n[h]){var l=a?a:s;r[h][l]||(t[h]++,r[h][l]=!0)}return o[s]?e._preventDefault(i):!0}return!0},e._keyup=function(i,s,a){s=s||i.keyCode||i.which;var h=e._KeyBinding[s];if(me.event.publish(me.event.KEYUP,[h,s]),h){var l=a?a:s;return r[h][l]=void 0,t[h]>0&&t[h]--,n[h]=!1,o[s]?e._preventDefault(i):!0}return!0},e.KEY={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,PRINT_SCREEN:42,INSERT:45,DELETE:46,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,WINDOW_KEY:91,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,PLUS:187,COMMA:188,MINUS:189,PERIOD:190,FORWAND_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222},e.isKeyPressed=function(e){return t[e]&&!n[e]?(i[e]&&(n[e]=!0),!0):!1
},e.keyStatus=function(e){return t[e]>0},e.triggerKeyEvent=function(t,i){i?e._keydown({},t):e._keyup({},t)},e.bindKey=function(s,a,h,l){e._enableKeyboardEvent(),"boolean"!=typeof l&&(l=e.preventDefault),e._KeyBinding[s]=a,o[s]=l,t[a]=0,i[a]=h?h:!1,n[a]=!1,r[a]={}},e.unlockKey=function(e){n[e]=!1},e.unbindKey=function(n){var s=e._KeyBinding[n];t[s]=0,i[s]=!1,r[s]={},e._KeyBinding[n]=null,o[n]=null}}(),function(){function e(e,t){for(var i=2;i<e.length;++i)"undefined"!=typeof e[i]&&me.video.renderer.getScreenCanvas().addEventListener(e[i],t,!1)}function t(){l||(b.push({x:0,y:0}),a.mouse.pos=new me.Vector2d(0,0),a._offset=me.video.getPos(),window.addEventListener("scroll",throttle(100,!1,function(e){a._offset=me.video.getPos(),me.event.publish(me.event.WINDOW_ONSCROLL,[e])}),!1),c=navigator.pointerEnabled?f:navigator.msPointerEnabled?p:me.device.touch?g:m,e(c,s),u="onwheel"in document.createElement("div")?"wheel":"mousewheel",window.addEventListener(u,r,!1),"undefined"==typeof a.throttlingInterval&&(a.throttlingInterval=~~(1e3/me.sys.fps)),a.throttlingInterval<17?me.video.renderer.getScreenCanvas().addEventListener(c[y],o,!1):me.video.renderer.getScreenCanvas().addEventListener(c[y],throttle(a.throttlingInterval,!1,function(e){o(e)}),!1),l=!0)}function i(e){var t=!1,i=h[e.type];if(i||(i=c.indexOf(e.type)===_?h[c[w]]:h[e.type]),i){me.game.viewport.localToWorld(0,0,T);for(var n=0,r=b.length;r>n;n++){if("undefined"!=typeof e.timeStamp){if(e.timeStamp<d)continue;d=e.timeStamp}me.device.pointerEnabled||(e.pointerId=b[n].id),e.gameScreenX=b[n].x,e.gameScreenY=b[n].y,e.gameWorldX=e.gameScreenX+T.x,e.gameWorldY=e.gameScreenY+T.y;for(var o,s=i.length;s--,o=i[s];)if(o.floating===!0?(e.gameX=e.gameScreenX,e.gameY=e.gameScreenY):(e.gameX=e.gameWorldX,e.gameY=e.gameWorldY),o.rect.getBounds().containsPoint(e.gameX,e.gameY)&&o.cb(e)===!1){t=!0;break}}}return t}function n(e){var t;if(b.length=0,e.touches)for(var i=0,n=e.changedTouches.length;n>i;i++){var r=e.changedTouches[i];t=a.globalToLocal(r.clientX,r.clientY),t.id=r.identifier,b.push(t)}else t=a.globalToLocal(e.clientX,e.clientY),t.id=e.pointerId||1,b.push(t);e.isPrimary!==!1&&a.mouse.pos.set(b[0].x,b[0].y)}function r(e){if(e.target===me.video.renderer.getScreenCanvas()){var t={deltaMode:1,type:"mousewheel",deltaX:e.deltaX,deltaY:e.deltaY,deltaZ:e.deltaZ};if("mousewheel"===u&&(t.deltaY=-1/40*e.wheelDelta,e.wheelDeltaX&&(t.deltaX=-1/40*e.wheelDeltaX)),i(t))return a._preventDefault(e)}return!0}function o(e){return n(e),i(e)?a._preventDefault(e):!0}function s(e){if(n(e),i(e))return a._preventDefault(e);var t=e.button||0,r=a.mouse.bind[t];return r?e.type===c[v]?a._keydown(e,r,t+1):a._keyup(e,r,t+1):!0}var a=me.input,h={},l=!1,u="mousewheel",d=0,c=null,f=["mousewheel","pointermove","pointerdown","pointerup","pointercancel",void 0,void 0],p=["mousewheel","MSPointerMove","MSPointerDown","MSPointerUp","MSPointerCancel",void 0,void 0],m=["mousewheel","mousemove","mousedown","mouseup",void 0,void 0,void 0],g=[void 0,"touchmove","touchstart","touchend","touchcancel",void 0,void 0],y=1,v=2,w=3,_=4,T=new me.Vector2d,b=[];a._offset=null,a.mouse={pos:null,LEFT:0,MIDDLE:1,RIGHT:2,bind:[0,0,0]},a.throttlingInterval=void 0,a.globalToLocal=function(e,t){var i=a._offset,n=me.device.getPixelRatio();e-=i.left,t-=i.top;var r=me.sys.scale;return(1!==r.x||1!==r.y)&&(e/=r.x,t/=r.y),new me.Vector2d(e*n,t*n)},a.bindPointer=function(){var e=arguments.length<2?a.mouse.LEFT:arguments[0],i=arguments.length<2?arguments[0]:arguments[1];if(t(),!a._KeyBinding[i])throw new me.Error("no action defined for keycode "+i);a.mouse.bind[e]=i},a.unbindPointer=function(e){a.mouse.bind["undefined"==typeof e?me.input.mouse.LEFT:e]=null},a.registerPointerEvent=function(e,i,n,r){if(t(),-1===f.indexOf(e))throw new me.Error("invalid event type : "+e);f!==c&&(e=c[f.indexOf(e)]),h[e]||(h[e]=[]);var o=i.floating===!0?!0:!1;r&&(o=r===!0?!0:!1),h[e].push({rect:i,cb:n,floating:o})},a.releasePointerEvent=function(e,t){if(-1===f.indexOf(e))throw new me.Error("invalid event type : "+e);f!==c&&(e=c[f.indexOf(e)]),h[e]||(h[e]=[]);var i=h[e];if(i)for(var n,r=i.length;r--,n=i[r];)n.rect===t&&(n.rect=n.cb=n.floating=null,h[e].splice(r,1))},a._translatePointerEvents=function(){a.registerPointerEvent("pointermove",me.game.viewport,function(e){return me.event.publish(me.event.MOUSEMOVE,[e]),!1})}}(),function(){var e=function(){var e={},t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return e.decode=function(e){if(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),me.device.nativeBase64)return window.atob(e);for(var i,n,r,o,s,a,h,l=[],u=0;u<e.length;)o=t.indexOf(e.charAt(u++)),s=t.indexOf(e.charAt(u++)),a=t.indexOf(e.charAt(u++)),h=t.indexOf(e.charAt(u++)),i=o<<2|s>>4,n=(15&s)<<4|a>>2,r=(3&a)<<6|h,l.push(String.fromCharCode(i)),64!==a&&l.push(String.fromCharCode(n)),64!==h&&l.push(String.fromCharCode(r));return l=l.join("")},e.encode=function(e){if(e=e.replace(/\r\n/g,"\n"),me.device.nativeBase64)return window.btoa(e);for(var i,n,r,o,s,a,h,l=[],u=0;u<e.length;)i=e.charCodeAt(u++),n=e.charCodeAt(u++),r=e.charCodeAt(u++),o=i>>2,s=(3&i)<<4|n>>4,a=(15&n)<<2|r>>6,h=63&r,isNaN(n)?a=h=64:isNaN(r)&&(h=64),l.push(t.charAt(o)),l.push(t.charAt(s)),l.push(t.charAt(a)),l.push(t.charAt(h));return l=l.join("")},e}();me.utils=function(){var t={},i="",n=0,r=/^.*(\\|\/|\:)/,o=/\.[^\.]*$/;return t.decodeBase64=function(t){return e.decode(t)},t.encodeBase64=function(t){return e.encode(t)},t.decodeBase64AsArray=function(t,i){i=i||1;var n,r,o,s=e.decode(t),a=new Uint32Array(s.length/i);for(n=0,o=s.length/i;o>n;n++)for(a[n]=0,r=i-1;r>=0;--r)a[n]+=s.charCodeAt(n*i+r)<<(r<<3);return a},t.decompress=function(){throw new me.Error("GZIP/ZLIB compressed TMX Tile Map not supported!")},t.decodeCSV=function(e,t){e=e.trim().split("\n");for(var i=[],n=0;n<e.length;n++)for(var r=e[n].split(",",t),o=0;o<r.length;o++)i.push(+r[o]);return i},t.getBasename=function(e){return e.replace(r,"").replace(o,"")},t.getFileExtension=function(e){return e.substring(e.lastIndexOf(".")+1,e.length)},t.getPixels=function(e){if(e instanceof HTMLImageElement){var t=me.CanvasRenderer.getContext2d(me.video.createCanvas(e.width,e.height));return t.drawImage(e,0,0),t.getImageData(0,0,e.width,e.height)}return e.getContext("2d").getImageData(0,0,e.width,e.height)},t.resetGUID=function(e){i=e.toString().toUpperCase().toHex(),n=0},t.createGUID=function(){return i+"-"+n++},t.applyFriction=function(e,t){return 0>e+t?e+t*me.timer.tick:e-t>0?e-t*me.timer.tick:0},t}()}(),function(){var e={black:[0,0,0],silver:[192,192,129],gray:[128,128,128],white:[255,255,255],maroon:[128,0,0],red:[255,0,0],purple:[128,0,128],fuchsia:[255,0,255],green:[0,128,0],lime:[0,255,0],olive:[128,128,0],yellow:[255,255,0],navy:[0,0,128],blue:[0,0,255],teal:[0,128,128],aqua:[0,255,255],orange:[255,165,0],aliceblue:[240,248,245],antiquewhite:[250,235,215],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],blanchedalmond:[255,235,205],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,35],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],"darkgray[*]":[169,169,169],darkgreen:[0,100,0],"darkgrey[*]":[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],limegreen:[50,205,50],linen:[250,240,230],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],oldlace:[253,245,230],olivedrab:[107,142,35],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],whitesmoke:[245,245,245],yellowgreen:[154,205,50]};me.Color=Object.extend({init:function(e,t,i,n){return this.r=0,this.g=0,this.b=0,this.alpha=1,this.glArray=new Float32Array([0,0,0,1]),this.setColor(e,t,i,n)},onResetEvent:function(e,t,i,n){return this.setColor(e,t,i,n)},setColor:function(e,t,i,n){return this.r=(~~e||0).clamp(0,255),this.g=(~~t||0).clamp(0,255),this.b=(~~i||0).clamp(0,255),this.alpha="undefined"==typeof n?1:(+n).clamp(0,1),this.glArray[0]=this.r/255,this.glArray[1]=this.g/255,this.glArray[2]=this.b/255,this.glArray[3]=this.alpha,this},clone:function(){return me.pool.pull("me.Color",this.r,this.g,this.b,this.alpha)},copy:function(e){return e instanceof me.Color?this.setColor(e.r,e.g,e.b,e.alpha):this.parseCSS(e)},add:function(e){return this.setColor(this.r+e.r,this.g+e.g,this.b+e.b,(this.alpha+e.alpha)/2)},darken:function(e){return e=e.clamp(0,1),this.setColor(this.r*e,this.g*e,this.b*e,this.alpha)},lighten:function(e){return e=e.clamp(0,1),this.setColor(this.r+(255-this.r)*e,this.g+(255-this.g)*e,this.b+(255-this.b)*e,this.alpha)},random:function(){return this.setColor(256*Math.random(),256*Math.random(),256*Math.random(),this.alpha)},equals:function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.alpha===e.alpha},parseCSS:function(t){return t in e?this.setColor.apply(this,e[t]):this.parseRGB(t)},parseRGB:function(e){if("string"==typeof e){var t;if("rgba"===e.substring(0,4))t=5;else{if("rgb"!==e.substring(0,3))return this.parseHex(e);t=4}var i=e.slice(t,-1).split(/\s*,\s*/);return this.setColor.apply(this,i)}throw new me.Color.Error("invalid parameter (not a string)")},parseHex:function(e){if("string"==typeof e){"#"===e.charAt(0)&&(e=e.substring(1,e.length));var t,i,n;return e.length<6?(t=parseInt(e.charAt(0)+e.charAt(0),16),i=parseInt(e.charAt(1)+e.charAt(1),16),n=parseInt(e.charAt(2)+e.charAt(2),16)):(t=parseInt(e.substring(0,2),16),i=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16)),this.setColor(t,i,n)}throw new me.Color.Error("invalid parameter (not a string)")},toGL:function(){return this.glArray},toHex:function(){return"#"+this.r.toHex()+this.g.toHex()+this.b.toHex()},toRGB:function(){return"rgb("+this.r+","+this.g+","+this.b+")"},toRGBA:function(){return"rgba("+this.r+","+this.g+","+this.b+","+this.alpha+")"}}),me.Color.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.Color.Error"}})}(),function(){me.save=function(){function e(e){return"add"===e||"remove"===e}var t={},i={_init:function(){if(me.device.localStorage===!0){var e=JSON.parse(localStorage.getItem("me.save"))||[];e.forEach(function(e){t[e]=JSON.parse(localStorage.getItem("me.save."+e))})}},add:function(n){Object.keys(n).forEach(function(r){e(r)||(!function(e){Object.defineProperty(i,e,{configurable:!0,enumerable:!0,get:function(){return t[e]},set:function(i){t[e]=i,me.device.localStorage===!0&&localStorage.setItem("me.save."+e,JSON.stringify(i))}})}(r),r in t||(i[r]=n[r]))}),me.device.localStorage===!0&&localStorage.setItem("me.save",JSON.stringify(Object.keys(t)))},remove:function(i){e(i)||"undefined"!=typeof t[i]&&(delete t[i],me.device.localStorage===!0&&(localStorage.removeItem("me.save."+i),localStorage.setItem("me.save",JSON.stringify(Object.keys(t)))))}};return i}()}(),function(){me.TMXConstants={COLLISION_GROUP:"collision",TMX_TAG_MAP:"map",TMX_TAG_NAME:"name",TMX_TAG_VALUE:"value",TMX_TAG_VERSION:"version",TMX_TAG_ORIENTATION:"orientation",TMX_TAG_WIDTH:"width",TMX_TAG_HEIGHT:"height",TMX_TAG_TYPE:"type",TMX_TAG_OPACITY:"opacity",TMX_TAG_TRANS:"trans",TMX_TAG_TILEWIDTH:"tilewidth",TMX_TAG_TILEHEIGHT:"tileheight",TMX_TAG_TILEOFFSET:"tileoffset",TMX_TAG_FIRSTGID:"firstgid",TMX_TAG_GID:"gid",TMX_TAG_TILE:"tile",TMX_TAG_ID:"id",TMX_TAG_DATA:"data",TMX_TAG_COMPRESSION:"compression",TMX_TAG_GZIP:"gzip",TMX_TAG_ZLIB:"zlib",TMX_TAG_ENCODING:"encoding",TMX_TAG_ATTR_BASE64:"base64",TMX_TAG_CSV:"csv",TMX_TAG_SPACING:"spacing",TMX_TAG_MARGIN:"margin",TMX_TAG_PROPERTIES:"properties",TMX_TAG_PROPERTY:"property",TMX_TAG_IMAGE:"image",TMX_TAG_SOURCE:"source",TMX_TAG_VISIBLE:"visible",TMX_TAG_TILESET:"tileset",TMX_TAG_LAYER:"layer",TMX_TAG_TILE_LAYER:"tilelayer",TMX_TAG_IMAGE_LAYER:"imagelayer",TMX_TAG_OBJECTGROUP:"objectgroup",TMX_TAG_OBJECT:"object",TMX_TAG_X:"x",TMX_TAG_Y:"y",TMX_TAG_POLYGON:"polygon",TMX_TAG_POLYLINE:"polyline",TMX_TAG_ELLIPSE:"ellipse",TMX_TAG_POINTS:"points",TMX_BACKGROUND_COLOR:"backgroundcolor",TMX_ROTATION:"rotation"}}(),function(e){me.TMXUtils=function(){function t(e){if(!e||e.isBoolean())e=e?"true"===e:!0;else if(e.isNumeric())e=Number(e);else if(e.match(/^json:/i)){var t=e.split(/^json:/i)[1];try{e=JSON.parse(t)}catch(i){throw new me.Error("Unable to parse JSON: "+t)}}return e}var i={},n=function(e,i){if(i.attributes&&i.attributes.length>0)for(var n=0;n<i.attributes.length;n++){var r=i.attributes.item(n);"undefined"!=typeof r.name?e[r.name]=t(r.value):e[r.nodeName]=t(r.nodeValue)}};return i.parse=function(e,t){var i={},r="";if(t=t||1,1===e.nodeType&&n(i,e),e.hasChildNodes()){for(var o=0;o<e.childNodes.length;o++){var s=e.childNodes.item(o),a=s.nodeName;if("undefined"==typeof i[a])if(3===s.nodeType){var h=s.nodeValue.trim();h&&h.length>0&&(r+=h)}else 1===s.nodeType&&(i[a]=me.TMXUtils.parse(s,t),i[a]._draworder=t++);else Array.isArray(i[a])===!1&&(i[a]=[i[a]]),i[a].push(me.TMXUtils.parse(s,t)),i[a][i[a].length-1]._draworder=t++}r.length>0&&(i.value=r,r="")}return i},i.applyTMXProperties=function(i,n){var r=n[e.TMX_TAG_PROPERTIES];if("undefined"!=typeof r)if("undefined"!=typeof r.property){var o=r.property;Array.isArray(o)===!0?o.forEach(function(e){i[e.name]=e.value}):i[o.name]=o.value}else for(var s in r)r.hasOwnProperty(s)&&(i[s]=t(r[s]))},i}()}(me.TMXConstants),function(e){me.TMXObjectGroup=Object.extend({init:function(t,i,n,r,o){this.name=t,this.width=i[e.TMX_TAG_WIDTH],this.height=i[e.TMX_TAG_HEIGHT],this.z=o,this.objects=[];var s="undefined"!=typeof i[e.TMX_TAG_VISIBLE]?i[e.TMX_TAG_VISIBLE]:!0;this.opacity=s===!0?(+i[e.TMX_TAG_OPACITY]||1).clamp(0,1):0,me.TMXUtils.applyTMXProperties(this,i);var a=i.objects||i.object,h=this;Array.isArray(a)===!0?a.forEach(function(e){h.objects.push(new me.TMXObject(e,n,r,o))}):a&&h.objects.push(new me.TMXObject(a,n,r,o))},destroy:function(){this.objects=null},getObjectCount:function(){return this.objects.length},getObjectByIndex:function(e){return this.objects[e]}}),me.TMXObject=Object.extend({init:function(t,i,n,r){if(this.points=void 0,this.name=t[e.TMX_TAG_NAME],this.x=+t[e.TMX_TAG_X],this.y=+t[e.TMX_TAG_Y],this.z=+r,this.width=+t[e.TMX_TAG_WIDTH]||0,this.height=+t[e.TMX_TAG_HEIGHT]||0,this.gid=+t[e.TMX_TAG_GID]||null,this.type=t[e.TMX_TAG_TYPE],this.rotation=Number.prototype.degToRad(+(t[e.TMX_ROTATION]||0)),this.orientation=i,this.isEllipse=!1,this.isPolygon=!1,this.isPolyLine=!1,"number"==typeof this.gid)this.setImage(this.gid,n);else if("undefined"!=typeof t[e.TMX_TAG_ELLIPSE])this.isEllipse=!0;else{var o=t[e.TMX_TAG_POLYGON];if("undefined"!=typeof o?this.isPolygon=!0:(o=t[e.TMX_TAG_POLYLINE],"undefined"!=typeof o&&(this.isPolyLine=!0)),"undefined"!=typeof o)if(this.points=[],"undefined"!=typeof o.points){o=o.points.split(" ");for(var s,a=0;a<o.length;a++)s=o[a].split(","),this.points.push(new me.Vector2d(+s[0],+s[1]))}else{var h=this;o.forEach(function(e){h.points.push(new me.Vector2d(+e.x,+e.y))})}}me.game.tmxRenderer.adjustPosition(this),me.TMXUtils.applyTMXProperties(this,t)},setImage:function(e,t){var i=t.getTilesetByGid(this.gid);this.width=i.tilewidth,this.height=i.tileheight,this.spritewidth=this.width;var n=new me.Tile(this.x,this.y,i.tilewidth,i.tileheight,this.gid);this.image=i.getTileImage(n),"undefined"==typeof this.name&&(this.name="TileObject")},getTMXShapes:function(){var e=0,t=[];if(this.isEllipse===!0)t.push(new me.Ellipse(this.width/2,this.height/2,this.width,this.height).rotate(this.rotation));else if(this.isPolygon===!0)t.push(new me.Polygon(0,0,this.points).rotate(this.rotation));else if(this.isPolyLine===!0){var i,n,r=this.points,o=r.length-1;for(e=0;o>e;e++)i=r[e],n=r[e+1].clone(),0!==this.rotation&&(i=i.rotate(this.rotation),n=n.rotate(this.rotation)),t.push(new me.Line(0,0,[i,n]))}else t.push(new me.Polygon(0,0,[new me.Vector2d,new me.Vector2d(this.width,0),new me.Vector2d(this.width,this.height),new me.Vector2d(0,this.height)]).rotate(this.rotation));if("isometric"===this.orientation)for(e=0;e<t.length;e++)t[e].rotate(Math.PI/4).scale(Math.SQRT2,Math.SQRT1_2);return t},getObjectPropertyByName:function(e){return this[e]}})}(me.TMXConstants),function(e){var t=2147483648,i=1073741824,n=536870912;me.Tile=me.Rect.extend({init:function(e,r,o,s,a){this.tileset=null,this.transform=null,me.Rect.prototype.init.apply(this,[e*o,r*s,o,s]),this.col=e,this.row=r,this.tileId=a,this.flippedX=0!==(this.tileId&t),this.flippedY=0!==(this.tileId&i),this.flippedAD=0!==(this.tileId&n),this.flipped=this.flippedX||this.flippedY||this.flippedAD,this.flipped===!0&&this.createTransform(),this.tileId&=~(t|i|n)},createTransform:function(){null===this.transform&&(this.transform=new me.Matrix2d),this.transform.identity();var e=this.transform.val;this.flippedAD&&(this.transform.set(0,1,1,0,e[4],e[5]),this.transform.translate(0,this.height-this.width)),this.flippedX&&(e[0]*=-1,e[2]*=-1,this.transform.translate(this.flippedAD?this.height:this.width,0)),this.flippedY&&(e[1]*=-1,e[3]*=-1,this.transform.translate(0,this.flippedAD?this.width:this.height))}}),me.TMXTileset=Object.extend({init:function(t){var i=0;this.TileProperties=[],this.tileXOffset=[],this.tileYOffset=[],this.firstgid=this.lastgid=+t[e.TMX_TAG_FIRSTGID];var n=t[e.TMX_TAG_SOURCE];if(n&&"tsx"===me.utils.getFileExtension(n).toLowerCase()&&(n=me.utils.getBasename(n),t=me.loader.getTMX(n).tileset,!t))throw new me.Error(n+" TSX tileset not found");this.name=t[e.TMX_TAG_NAME],this.tilewidth=+t[e.TMX_TAG_TILEWIDTH],this.tileheight=+t[e.TMX_TAG_TILEHEIGHT],this.spacing=+t[e.TMX_TAG_SPACING]||0,this.margin=+t[e.TMX_TAG_MARGIN]||0,this.tileoffset=new me.Vector2d(0,0),this.isAnimated=!1,this.animations={};var r=t.tiles;if("undefined"!=typeof r)for(i in r)r.hasOwnProperty(i)&&"animation"in r[i]&&(this.isAnimated=!0,this.animations[+i+this.firstgid]={dt:0,idx:0,frames:r[i].animation,cur:r[i].animation[0]});var o=t[e.TMX_TAG_TILEOFFSET];o&&(this.tileoffset.x=+o[e.TMX_TAG_X],this.tileoffset.y=+o[e.TMX_TAG_Y]);var s=t.tileproperties;if(s)for(i in s)s.hasOwnProperty(i)&&this.setTileProperty(i+this.firstgid,s[i]);else if(t[e.TMX_TAG_TILE])for(s=t[e.TMX_TAG_TILE],Array.isArray(s)||(s=[s]),i=0;i<s.length;i++){var a=+s[i][e.TMX_TAG_ID]+this.firstgid,h={};me.TMXUtils.applyTMXProperties(h,s[i]),this.setTileProperty(a,h),"animation"in s[i]&&(this.isAnimated=!0,this.animations[a]={dt:0,idx:0,frames:s[i].animation.frame,cur:s[i].animation.frame[0]})}var l="string"==typeof t[e.TMX_TAG_IMAGE]?t[e.TMX_TAG_IMAGE]:t[e.TMX_TAG_IMAGE].source;if(l=me.utils.getBasename(l),this.image=l?me.loader.getImage(l):null,this.image){this.hTileCount=~~((this.image.width-this.margin)/(this.tilewidth+this.spacing)),this.vTileCount=~~((this.image.height-this.margin)/(this.tileheight+this.spacing)),this.lastgid=this.firstgid+(this.hTileCount*this.vTileCount-1||0);var u=t[e.TMX_TAG_TRANS]||t[e.TMX_TAG_IMAGE][e.TMX_TAG_TRANS];"undefined"!=typeof u&&(this.image=me.video.renderer.applyRGBFilter(this.image,"transparent",u.toUpperCase()).canvas)}else console.log("melonJS: '"+l+"' file for tileset '"+this.name+"' not found!")},setTileProperty:function(e,t){this.TileProperties[e]=t},contains:function(e){return e>=this.firstgid&&e<=this.lastgid},getTileImage:function(e){var t=me.CanvasRenderer.getContext2d(me.video.createCanvas(this.tilewidth,this.tileheight));return this.drawTile(t,0,0,e),t.canvas},getTileProperties:function(e){return this.TileProperties[e]},getTileOffsetX:function(e){var t=this.tileXOffset[e];return"undefined"==typeof t&&(t=this.tileXOffset[e]=this.margin+(this.spacing+this.tilewidth)*(e%this.hTileCount)),t},getTileOffsetY:function(e){var t=this.tileYOffset[e];return"undefined"==typeof t&&(t=this.tileYOffset[e]=this.margin+(this.spacing+this.tileheight)*~~(e/this.hTileCount)),t},update:function(e){var t=null,i=0,n=!1;for(var r in this.animations)this.animations.hasOwnProperty(r)&&(t=this.animations[r],t.dt+=e,i=t.cur.duration,t.dt>=i&&(t.dt-=i,t.idx=(t.idx+1)%t.frames.length,t.cur=t.frames[t.idx],n=!0));return n},drawTile:function(e,t,i,n){var r=n.tileId;if(n.flipped){e.save();var o=n.transform.val;e.transform(o[0],o[1],o[2],o[3],o[4]+t,o[5]+i),t=i=0}r in this.animations?r=this.animations[r].cur.tileid:r-=this.firstgid,e.drawImage(this.image,this.getTileOffsetX(r),this.getTileOffsetY(r),this.tilewidth,this.tileheight,t,i,this.tilewidth,this.tileheight),n.flipped&&e.restore()}}),me.TMXTilesetGroup=Object.extend({init:function(){this.tilesets=[]},add:function(e){this.tilesets.push(e)},getTilesetByIndex:function(e){return this.tilesets[e]},getTilesetByGid:function(e){for(var t=-1,i=0,n=this.tilesets.length;n>i;i++){if(this.tilesets[i].contains(e))return this.tilesets[i];this.tilesets[i].firstgid===this.tilesets[i].lastgid&&e>=this.tilesets[i].firstgid&&(t=i)}if(-1!==t)return this.tilesets[t];throw new me.Error("no matching tileset found for gid "+e)}})}(me.TMXConstants),function(){me.TMXOrthogonalRenderer=Object.extend({init:function(e,t,i,n){this.cols=e,this.rows=t,this.tilewidth=i,this.tileheight=n},canRender:function(e){return"orthogonal"===e.orientation&&this.cols===e.cols&&this.rows===e.rows&&this.tilewidth===e.tilewidth&&this.tileheight===e.tileheight},pixelToTileCoords:function(e,t){return new me.Vector2d(this.pixelToTileX(e),this.pixelToTileY(t))},pixelToTileX:function(e){return e/this.tilewidth},pixelToTileY:function(e){return e/this.tileheight},tileToPixelCoords:function(e,t){return new me.Vector2d(e*this.tilewidth,t*this.tileheight)},adjustPosition:function(e){"number"==typeof e.gid&&(e.y-=e.height)},drawTile:function(e,t,i,n,r){r.drawTile(e,r.tileoffset.x+t*this.tilewidth,r.tileoffset.y+(i+1)*this.tileheight-r.tileheight,n)},drawTileLayer:function(e,t,i){var n=this.pixelToTileCoords(i.pos.x,i.pos.y).floorSelf(),r=this.pixelToTileCoords(i.pos.x+i.width+this.tilewidth,i.pos.y+i.height+this.tileheight).ceilSelf();r.x=r.x>this.cols?this.cols:r.x,r.y=r.y>this.rows?this.rows:r.y;for(var o=n.y;o<r.y;o++)for(var s=n.x;s<r.x;s++){var a=t.layerData[s][o];a&&this.drawTile(e,s,o,a,a.tileset)}}}),me.TMXIsometricRenderer=Object.extend({init:function(e,t,i,n){this.cols=e,this.rows=t,this.tilewidth=i,this.tileheight=n,this.hTilewidth=i/2,this.hTileheight=n/2,this.originX=this.rows*this.hTilewidth},canRender:function(e){return"isometric"===e.orientation&&this.cols===e.cols&&this.rows===e.rows&&this.tilewidth===e.tilewidth&&this.tileheight===e.tileheight},pixelToTileCoords:function(e,t){return new me.Vector2d(this.pixelToTileX(e,t),this.pixelToTileY(t,e))},pixelToTileX:function(e,t){return t/this.tileheight+(e-this.originX)/this.tilewidth},pixelToTileY:function(e,t){return e/this.tileheight-(t-this.originX)/this.tilewidth},tileToPixelCoords:function(e,t){return new me.Vector2d((e-t)*this.hTilewidth+this.originX,(e+t)*this.hTileheight)},adjustPosition:function(e){var t=e.x/this.hTilewidth,i=e.y/this.tileheight,n=this.tileToPixelCoords(t,i);e.x=n.x,e.y=n.y},drawTile:function(e,t,i,n,r){r.drawTile(e,(this.cols-1)*r.tilewidth+(t-i)*r.tilewidth>>1,-r.tilewidth+(t+i)*r.tileheight>>2,n)},drawTileLayer:function(e,t,i){var n=t.tileset,r=n.tileoffset,o=this.pixelToTileCoords(i.pos.x-n.tilewidth,i.pos.y-n.tileheight).floorSelf(),s=this.pixelToTileCoords(i.pos.x+i.width+n.tilewidth,i.pos.y+i.height+n.tileheight).ceilSelf(),a=this.tileToPixelCoords(s.x,s.y),h=this.tileToPixelCoords(o.x,o.y);h.x-=this.hTilewidth,h.y+=this.tileheight;var l=h.y-i.pos.y>this.hTileheight,u=i.pos.x-h.x<this.hTilewidth;l&&(u?(o.x--,h.x-=this.hTilewidth):(o.y--,h.x+=this.hTilewidth),h.y-=this.hTileheight);for(var d=l^u,c=o.clone(),f=h.y;f-this.tileheight<a.y;f+=this.hTileheight){c.setV(o);for(var p=h.x;p<a.x;p+=this.tilewidth){if(c.x>=0&&c.y>=0&&c.x<this.cols&&c.y<this.rows){var m=t.layerData[c.x][c.y];m&&(n=m.tileset,r=n.tileoffset,n.drawTile(e,r.x+p,r.y+f-n.tileheight,m))}c.x++,c.y--}d?(o.y++,h.x-=this.hTilewidth,d=!1):(o.x++,h.x+=this.hTilewidth,d=!0)}}})}(),function(e){me.ColorLayer=me.Renderable.extend({init:function(e,t,i){me.Renderable.prototype.init.apply(this,[0,0,1/0,1/0]),this.name=e,this.color=t,this.z=i,this.floating=!0},draw:function(e,t){var i=e.globalAlpha();e.setGlobalAlpha(i*this.getOpacity());var n=me.game.viewport.pos,r=e.getColor();e.setColor(this.color),e.fillRect(t.left-n.x,t.top-n.y,t.width,t.height),e.setColor(r),e.setGlobalAlpha(i)}}),me.ImageLayer=me.Renderable.extend({init:function(e,t,i,n,r,o){if(this.name=e,this.image=n?me.loader.getImage(me.utils.getBasename(n)):null,!this.image)throw new me.Error("'"+n+"' file for Image Layer '"+this.name+"' not found!");this.imagewidth=this.image.width,this.imageheight=this.image.height;var s=me.game.viewport;t=t?Math.min(s.width,t):s.width,i=i?Math.min(s.height,i):s.height,me.Renderable.prototype.init.apply(this,[0,0,t,i]),this.z=r,this.ratio=new me.Vector2d(1,1),"undefined"!=typeof o&&("number"==typeof o?this.ratio.set(o,o):this.ratio.setV(o)),this.lastpos=s.pos.clone(),this.floating=!0,this._repeat="repeat",this.repeatX=!0,this.repeatY=!0,Object.defineProperty(this,"repeat",{get:function(){return this._repeat},set:function(e){switch(this._repeat=e,this._repeat){case"no-repeat":this.repeatX=!1,this.repeatY=!1;break;case"repeat-x":this.repeatX=!0,this.repeatY=!1;break;case"repeat-y":this.repeatX=!1,this.repeatY=!0;break;default:this.repeatX=!0,this.repeatY=!0}}}),this.anchorPoint.set(0,0),this.handle=me.event.subscribe(me.event.VIEWPORT_ONCHANGE,this.updateLayer.bind(this))},updateLayer:function(e){(0!==this.ratio.x||0!==this.ratio.y)&&(this.repeatX||this.repeatY?(this.pos.x+=(e.x-this.lastpos.x)*this.ratio.x%this.imagewidth,this.pos.x=(this.imagewidth+this.pos.x)%this.imagewidth,this.pos.y+=(e.y-this.lastpos.y)*this.ratio.y%this.imageheight,this.pos.y=(this.imageheight+this.pos.y)%this.imageheight):(this.pos.x+=(e.x-this.lastpos.x)*this.ratio.x,this.pos.y+=(e.y-this.lastpos.y)*this.ratio.y),this.lastpos.setV(e))},draw:function(e,t){var i=me.game.viewport,n=0!==this.anchorPoint.y||0!==this.anchorPoint.x,r=~~(this.anchorPoint.x*(i.width-this.imagewidth)),o=~~(this.anchorPoint.y*(i.height-this.imageheight));n&&e.translate(r,o),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity());var s,a;if(0===this.ratio.x&&0===this.ratio.y)s=Math.min(t.width,this.imagewidth),a=Math.min(t.height,this.imageheight),e.drawImage(this.image,t.left,t.top,s,a,t.left,t.top,s,a);else{var h=~~this.pos.x,l=~~this.pos.y,u=0,d=0;for(s=Math.min(this.imagewidth-h,this.width),a=Math.min(this.imageheight-l,this.height);;){do e.drawImage(this.image,h,l,s,a,u,d,s,a),l=0,d+=a,a=Math.min(this.imageheight,this.height-d);while(this.repeatY&&d<this.height);if(u+=s,!this.repeatX||u>=this.width)break;h=0,s=Math.min(this.imagewidth,this.width-u),l=~~this.pos.y,d=0,a=Math.min(this.imageheight-~~this.pos.y,this.height)}}n&&e.translate(-r,-o)},destroy:function(){this.handle&&(me.event.unsubscribe(this.handle),this.handle=null),this.image=null,this.lastpos=null}}),me.TMXLayer=me.Renderable.extend({init:function(e,t,i,n,r){if(me.Renderable.prototype.init.apply(this,[0,0,0,0]),this.tilewidth=e,this.tileheight=t,this.orientation=i,this.tilesets=n,this.tileset=this.tilesets?this.tilesets.getTilesetByIndex(0):null,this.animatedTilesets=[],this.tilesets)for(var o=this.tilesets.tilesets,s=0;s<o.length;s++)o[s].isAnimated&&(o[s].isAnimated=!1,this.animatedTilesets.push(o[s]));this.isAnimated=this.animatedTilesets.length>0,this.isAnimated&&(this.preRender=!1),this.z=r},initFromJSON:function(t){this.name=t[e.TMX_TAG_NAME],this.cols=+t[e.TMX_TAG_WIDTH],this.rows=+t[e.TMX_TAG_HEIGHT];var i="undefined"!=typeof t[e.TMX_TAG_VISIBLE]?t[e.TMX_TAG_VISIBLE]:!0;this.setOpacity(i?+t[e.TMX_TAG_OPACITY]:0),"isometric"===this.orientation?(this.width=(this.cols+this.rows)*(this.tilewidth/2),this.height=(this.cols+this.rows)*(this.tileheight/2)):(this.width=this.cols*this.tilewidth,this.height=this.rows*this.tileheight),me.TMXUtils.applyTMXProperties(this,t),"undefined"==typeof this.preRender&&(this.preRender=me.sys.preRender),this.preRender===!0&&(this.layerCanvas=me.video.createCanvas(this.cols*this.tilewidth,this.rows*this.tileheight),this.layerSurface=me.CanvasRenderer.getContext2d(this.layerCanvas)),this.initArray(this.cols,this.rows)},destroy:function(){this.preRender&&(this.layerCanvas=null,this.layerSurface=null),this.renderer=null,this.layerData=null,this.tileset=null,this.tilesets=null,this.animatedTilesets=null},setRenderer:function(e){this.renderer=e},initArray:function(e,t){this.layerData=[];for(var i=0;e>i;i++){this.layerData[i]=[];for(var n=0;t>n;n++)this.layerData[i][n]=null}},getTileId:function(e,t){var i=this.getTile(e,t);return i?i.tileId:null},getTile:function(e,t){return this.layerData[~~this.renderer.pixelToTileX(e,t)][~~this.renderer.pixelToTileY(t,e)]},setTile:function(e,t,i){var n=new me.Tile(e,t,this.tilewidth,this.tileheight,i);return n.tileset=this.tileset.contains(n.tileId)?this.tileset:this.tileset=this.tilesets.getTilesetByGid(n.tileId),this.layerData[e][t]=n,n},clearTile:function(e,t){this.layerData[e][t]=null,this.preRender&&this.layerSurface.clearRect(e*this.tilewidth,t*this.tileheight,this.tilewidth,this.tileheight)},update:function(e){if(this.isAnimated){for(var t=!1,i=0;i<this.animatedTilesets.length;i++)t=this.animatedTilesets[i].update(e)||t;return t}return!1},draw:function(e,t){if(this.preRender){var i=Math.min(t.width,this.width),n=Math.min(t.height,this.height);this.layerSurface.globalAlpha=e.globalAlpha()*this.getOpacity(),this.layerSurface.globalAlpha>0&&e.drawImage(this.layerCanvas,t.pos.x,t.pos.y,i,n,t.pos.x,t.pos.y,i,n)}else{var r=e.globalAlpha();e.setGlobalAlpha(e.globalAlpha()*this.getOpacity()),e.globalAlpha()>0&&this.renderer.drawTileLayer(e,this,t),e.setGlobalAlpha(r)}}})}(me.TMXConstants),function(){me.TMXTileMap=me.Renderable.extend({init:function(e){this.levelId=e,this.z=0,this.name=null,this.cols=0,this.rows=0,this.tilewidth=0,this.tileheight=0,this.tilesets=null,this.mapLayers=[],this.objectGroups=[],this.version="",this.orientation="",this.tilesets=null,this.initialized=!1,me.Renderable.prototype.init.apply(this,[0,0,0,0])
},setDefaultPosition:function(e,t){if(this.width<e||this.height<t){var i=~~((e-this.width)/2),n=~~((t-this.height)/2);this.pos.set(i>0?i:0,n>0?n:0)}},getObjectGroupByName:function(e){var t=null;e=e.trim().toLowerCase();for(var i=this.objectGroups.length;i--;)if(this.objectGroups[i].name.toLowerCase().contains(e)){t=this.objectGroups[i];break}return t},getObjectGroups:function(){return this.objectGroups},getLayers:function(){return this.mapLayers},getLayerByName:function(e){var t=null;e=e.trim().toLowerCase();for(var i=this.mapLayers.length;i--;)if(this.mapLayers[i].name.toLowerCase().contains(e)){t=this.mapLayers[i];break}return t},clearTile:function(e,t){for(var i=this.mapLayers.length;i--;)this.mapLayers[i]instanceof me.TMXLayer&&this.mapLayers[i].clearTile(e,t)},destroy:function(){var e;if(this.initialized===!0){for(e=this.mapLayers.length;e--;)this.mapLayers[e]=null;for(e=this.objectGroups.length;e--;)this.objectGroups[e].destroy(),this.objectGroups[e]=null;this.tilesets=null,this.mapLayers.length=0,this.objectGroups.length=0,this.pos.set(0,0),this.initialized=!1}}})}(),function(e){me.TMXMapReader=Object.extend({init:function(){},readMap:function(t,i){if(t.initialized!==!0){var n=0,r=this;t.version=i[e.TMX_TAG_VERSION],t.orientation=i[e.TMX_TAG_ORIENTATION],t.cols=+i[e.TMX_TAG_WIDTH],t.rows=+i[e.TMX_TAG_HEIGHT],t.tilewidth=+i[e.TMX_TAG_TILEWIDTH],t.tileheight=+i[e.TMX_TAG_TILEHEIGHT],"isometric"===t.orientation?(t.width=(t.cols+t.rows)*(t.tilewidth/2),t.height=(t.cols+t.rows)*(t.tileheight/2)):(t.width=t.cols*t.tilewidth,t.height=t.rows*t.tileheight),t.backgroundcolor=i[e.TMX_BACKGROUND_COLOR],t.z=n++,me.TMXUtils.applyTMXProperties(t,i),t.backgroundcolor&&t.mapLayers.push(new me.ColorLayer("background_color",t.backgroundcolor,n++)),t.background_image&&t.mapLayers.push(new me.ImageLayer("background_image",t.width,t.height,t.background_image,n++)),null!==me.game.tmxRenderer&&me.game.tmxRenderer.canRender(t)||(me.game.tmxRenderer=this.getNewDefaultRenderer(t)),t.tilesets||(t.tilesets=new me.TMXTilesetGroup);var o=i.tilesets||i.tileset;if(Array.isArray(o)===!0?o.forEach(function(e){t.tilesets.add(r.readTileset(e))}):t.tilesets.add(r.readTileset(o)),"undefined"!=typeof i.layers)i.layers.forEach(function(i){switch(i.type){case e.TMX_TAG_IMAGE_LAYER:t.mapLayers.push(r.readImageLayer(t,i,n++));break;case e.TMX_TAG_TILE_LAYER:t.mapLayers.push(r.readLayer(t,i,n++));break;case e.TMX_TAG_OBJECTGROUP:t.objectGroups.push(r.readObjectGroup(t,i,n++))}});else if("undefined"!=typeof i.layer){var s=i.layer;if(Array.isArray(s)===!0?s.forEach(function(e){t.mapLayers.push(r.readLayer(t,e,e._draworder))}):t.mapLayers.push(r.readLayer(t,s,s._draworder)),"undefined"!=typeof i[e.TMX_TAG_OBJECTGROUP]){var a=i[e.TMX_TAG_OBJECTGROUP];Array.isArray(a)===!0?a.forEach(function(e){t.objectGroups.push(r.readObjectGroup(t,e,e._draworder))}):t.objectGroups.push(r.readObjectGroup(t,a,a._draworder))}if("undefined"!=typeof i[e.TMX_TAG_IMAGE_LAYER]){var h=i[e.TMX_TAG_IMAGE_LAYER];Array.isArray(h)===!0?h.forEach(function(e){t.mapLayers.push(r.readImageLayer(t,e,e._draworder))}):t.mapLayers.push(r.readImageLayer(t,h,h._draworder))}}t.initialized=!0}},getNewDefaultRenderer:function(e){switch(e.orientation){case"orthogonal":return new me.TMXOrthogonalRenderer(e.cols,e.rows,e.tilewidth,e.tileheight);case"isometric":return new me.TMXIsometricRenderer(e.cols,e.rows,e.tilewidth,e.tileheight);default:throw new me.Error(e.orientation+" type TMX Tile Map not supported!")}},setLayerData:function(t,i,n,r){var o=Array.isArray(i)===!0?i:i.value;switch(n){case"json":o=i;break;case e.TMX_TAG_CSV:case e.TMX_TAG_ATTR_BASE64:n===e.TMX_TAG_CSV?o=me.utils.decodeCSV(o,t.cols):(o=me.utils.decodeBase64AsArray(o,4),null!==r&&(o=me.utils.decompress(o,r)));break;default:throw new me.Error("TMX Tile Map "+n+" encoding not supported!")}for(var s=0,a=0;a<t.rows;a++)for(var h=0;h<t.cols;h++){var l=null==n?this.TMXParser.getIntAttribute(o[s++],e.TMX_TAG_GID):o[s++];if(0!==l){var u=t.setTile(h,a,l);t.preRender&&t.renderer.drawTile(t.layerSurface,h,a,u,u.tileset)}}},readLayer:function(t,i,n){var r=new me.TMXLayer(t.tilewidth,t.tileheight,t.orientation,t.tilesets,n);r.initFromJSON(i),r.setRenderer(me.game.tmxRenderer.canRender(r)?me.game.tmxRenderer:me.mapReader.getNewDefaultRenderer(r));var o=Array.isArray(i[e.TMX_TAG_DATA])?i[e.TMX_TAG_ENCODING]:i[e.TMX_TAG_DATA][e.TMX_TAG_ENCODING];return this.setLayerData(r,i[e.TMX_TAG_DATA],o||"json",null),r},readImageLayer:function(t,i,n){var r=i[e.TMX_TAG_NAME],o=+i[e.TMX_TAG_WIDTH],s=+i[e.TMX_TAG_HEIGHT],a="string"!=typeof i[e.TMX_TAG_IMAGE]?i[e.TMX_TAG_IMAGE].source:i[e.TMX_TAG_IMAGE],h=new me.ImageLayer(r,o*t.tilewidth,s*t.tileheight,a,n),l="undefined"!=typeof i[e.TMX_TAG_VISIBLE]?i[e.TMX_TAG_VISIBLE]:!0;if(h.setOpacity(l===!0?(+i[e.TMX_TAG_OPACITY]||1).clamp(0,1):0),me.TMXUtils.applyTMXProperties(h,i),"number"==typeof h.ratio){var u=h.ratio;h.ratio=new me.Vector2d(u,u)}return h},readTileset:function(e){return new me.TMXTileset(e)},readObjectGroup:function(t,i,n){return new me.TMXObjectGroup(i[e.TMX_TAG_NAME],i,t.orientation,t.tilesets,n)}})}(me.TMXConstants),function(){me.levelDirector=function(){var e={},t={},i=[],n=0,r=function(e,t){t.autoSort=!1,me.game.currentLevel=e,me.game.viewport.setBounds(0,0,Math.max(e.width,me.game.viewport.width),Math.max(e.height,me.game.viewport.height)),e.setDefaultPosition(me.game.viewport.width,me.game.viewport.height);for(var i=e.getLayers(),n=i.length;n--;)t.addChild(i[n]);for(var r=t,o=!1,s=e.getObjectGroups(),a=0;a<s.length;a++){var h=s[a];o=h.name.toLowerCase().contains(me.TMXConstants.COLLISION_GROUP),me.game.mergeGroup===!1&&(r=new me.Container,r.name=h.name,r.z=h.z,r.setOpacity(h.opacity),r.autoSort=!1);for(var l=0;l<h.objects.length;l++){var u,d=h.objects[l];o===!1?u=me.pool.pull(d.name,d.x,d.y,"TileObject"===d.name?d.image:d):(u=me.pool.pull("me.Entity",d.x,d.y,d),u.body.collisionType=me.collision.types.WORLD_SHAPE),u&&(u.z=h.z,me.game.mergeGroup===!0&&u.isRenderable===!0&&(u.setOpacity(u.getOpacity()*h.opacity),u.renderable instanceof me.Renderable&&u.renderable.setOpacity(u.renderable.getOpacity()*h.opacity)),r.addChild(u))}me.game.mergeGroup===!1&&(t.addChild(r),r.autoSort=!0)}t.sort(!0),t.autoSort=!0,me.game.world.transform.translateV(me.game.currentLevel.pos),me.game.world.resize(me.game.currentLevel.width,me.game.currentLevel.height),me.game.onLevelLoaded&&me.game.onLevelLoaded.call(me.game.onLevelLoaded,e.name),me.event.publish(me.event.LEVEL_LOADED,[e.name])};return e.reset=function(){},e.addLevel=function(){throw new me.Error("no level loader defined")},e.addTMXLevel=function(e,n){return null!=t[e]?!1:(t[e]=new me.TMXTileMap(e),t[e].name=e,i.push(e),n&&n(),!0)},e.loadLevel=function(o){if(o=o.toString().toLowerCase(),"undefined"==typeof t[o])throw new me.Error("level "+o+" not found");if(!(t[o]instanceof me.TMXTileMap))throw new me.Error("no level loader defined");var s=me.state.isRunning();return s&&me.state.stop(),me.game.reset(),me.utils.resetGUID(o),t[e.getCurrentLevelId()]&&t[e.getCurrentLevelId()].destroy(),me.mapReader.readMap(t[o],me.loader.getTMX(o)),n=i.indexOf(o),r(t[o],me.game.world),s&&me.state.restart.defer(this),!0},e.getCurrentLevelId=function(){return i[n]},e.reloadLevel=function(){return e.loadLevel(e.getCurrentLevelId())},e.nextLevel=function(){return n+1<i.length?e.loadLevel(i[n+1]):!1},e.previousLevel=function(){return n-1>=0?e.loadLevel(i[n-1]):!1},e.levelCount=function(){return i.length},e}()}(),function(){me.Tween=function(e){var t=e,i={},n={},r={},o=1e3,s=0,a=!1,h=!1,l=0,u=null,d=me.Tween.Easing.Linear.None,c=me.Tween.Interpolation.Linear,f=[],p=null,m=!1,g=null,y=null;for(var v in e)"object"!=typeof e&&(i[v]=parseFloat(e[v],10));this.onResetEvent=function(e){t=e,i={},n={},r={},d=me.Tween.Easing.Linear.None,c=me.Tween.Interpolation.Linear,a=!1,h=!1,o=1e3,l=0,p=null,m=!1,g=null,y=null},this.to=function(e,t){return void 0!==t&&(o=t),n=e,this},this.start=function(e){m=!1,me.game.world.addChild(this),u=("undefined"==typeof e?me.timer.getTime():e)+l;for(var o in n){if(n[o]instanceof Array){if(0===n[o].length)continue;n[o]=[t[o]].concat(n[o])}i[o]=t[o],i[o]instanceof Array==!1&&(i[o]*=1),r[o]=i[o]||0}return this},this.stop=function(){return me.game.world.hasChild(this)&&me.game.world.removeChildNow(this),this},this.delay=function(e){return l=e,this},me.event.subscribe(me.event.STATE_RESUME,function(e){u&&(u+=e)}),this.repeat=function(e){return s=e,this},this.yoyo=function(e){return a=e,this},this.easing=function(e){if("function"!=typeof e)throw new me.Tween.Error("invalid easing function for me.Tween.easing()");return d=e,this},this.interpolation=function(e){return c=e,this},this.chain=function(){return f=arguments,this},this.onStart=function(e){return p=e,this},this.onUpdate=function(e){return g=e,this},this.onComplete=function(e){return y=e,this},this.update=function(){var e,v=me.timer.getTime();if(u>v)return!0;m===!1&&(null!==p&&p.call(t),m=!0);var w=(v-u)/o;w=w>1?1:w;var _=d(w);for(e in n){var T=i[e]||0,b=n[e];b instanceof Array?t[e]=c(b,_):("string"==typeof b&&(b=T+parseFloat(b,10)),"number"==typeof b&&(t[e]=T+(b-T)*_))}if(null!==g&&g.call(t,_),1===w){if(s>0){isFinite(s)&&s--;for(e in r){if("string"==typeof n[e]&&(r[e]=r[e]+parseFloat(n[e],10)),a){var x=r[e];r[e]=n[e],n[e]=x}i[e]=r[e]}return a&&(h=!h),u=v+l,!0}me.game.world.removeChildNow(this),null!==y&&y.call(t);for(var A=0,E=f.length;E>A;A++)f[A].start(v);return!1}return!0}},me.Tween.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(-Math.pow(2,-10*(e-1))+2)}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),-(i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/n)))},Out:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/n)+1)},InOut:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?-.5*i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/n):i*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/n)*.5+1)}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?.5*e*e*((t+1)*e-t):.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-me.Tween.Easing.Bounce.Out(1-e)},Out:function(e){return 1/2.75>e?7.5625*e*e:2/2.75>e?7.5625*(e-=1.5/2.75)*e+.75:2.5/2.75>e?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return.5>e?.5*me.Tween.Easing.Bounce.In(2*e):.5*me.Tween.Easing.Bounce.Out(2*e-1)+.5}}},me.Tween.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),o=me.Tween.Interpolation.Utils.Linear;return 0>t?o(e[0],e[1],n):t>1?o(e[i],e[i-1],i-n):o(e[r],e[r+1>i?i:r+1],n-r)},Bezier:function(e,t){var i,n=0,r=e.length-1,o=Math.pow,s=me.Tween.Interpolation.Utils.Bernstein;for(i=0;r>=i;i++)n+=o(1-t,r-i)*o(t,i)*e[i]*s(r,i);return n},CatmullRom:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),o=me.Tween.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(0>t&&(r=Math.floor(n=i*(1+t))),o(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],n-r)):0>t?e[0]-(o(e[0],e[0],e[1],e[1],-n)-e[0]):t>1?e[i]-(o(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):o(e[r?r-1:0],e[r],e[r+1>i?i:r+1],e[r+2>i?i:r+2],n-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=me.Tween.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:function(){var e=[1];return function(t){var i,n=1;if(e[t])return e[t];for(i=t;i>1;i--)n*=i;return e[t]=n}}(),CatmullRom:function(e,t,i,n,r){var o=.5*(i-e),s=.5*(n-t),a=r*r,h=r*a;return(2*t-2*i+o+s)*h+(-3*t+3*i-2*o-s)*a+o*r+t}}},me.Tween.Error=me.Error.extend({init:function(e){me.Error.prototype.init.apply(this,[e]),this.name="me.Tween.Error"}})}(),function(){me.event=function(){var e={},t={};return e.STATE_PAUSE="me.state.onPause",e.STATE_RESUME="me.state.onResume",e.STATE_STOP="me.state.onStop",e.STATE_RESTART="me.state.onRestart",e.GAME_INIT="me.game.onInit",e.LEVEL_LOADED="me.game.onLevelLoaded",e.LOADER_COMPLETE="me.loader.onload",e.LOADER_PROGRESS="me.loader.onProgress",e.KEYDOWN="me.input.keydown",e.KEYUP="me.input.keyup",e.MOUSEMOVE="me.game.pointermove",e.DRAGSTART="me.game.dragstart",e.DRAGEND="me.game.dragend",e.WINDOW_ONRESIZE="window.onresize",e.WINDOW_ONORIENTATION_CHANGE="window.orientationchange",e.WINDOW_ONSCROLL="window.onscroll",e.VIEWPORT_ONCHANGE="viewport.onchange",e.publish=function(e,i){for(var n=t[e],r=n?n.length:0;r--;)n[r].apply(window,i||[])},e.subscribe=function(e,i){return t[e]||(t[e]=[]),t[e].push(i),[e,i]},e.unsubscribe=function(e,i){var n=t[i?e:e[0]],r=n?n.length:0;for(i=i||e[1];r--;)n[r]===i&&n.splice(r,1)},e}()}(),function(){"use strict";function e(){try{"undefined"!=typeof AudioContext?t=new AudioContext:"undefined"!=typeof webkitAudioContext?t=new webkitAudioContext:i=!1}catch(e){i=!1}if(!i)if("undefined"!=typeof Audio)try{new Audio}catch(e){n=!0}else n=!0}var t=null,i=!0,n=!1;if(e(),i){var r="undefined"==typeof t.createGain?t.createGainNode():t.createGain();r.gain.value=1,r.connect(t.destination)}var o=function(){this.init()};o.prototype={init:function(){var e=this||s;return e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e.iOSAutoEnable=!0,e.noAudio=n,e.usingWebAudio=i,e.ctx=t,n||e._setupCodecs(),e},volume:function(e){var t=this||s;if(e=parseFloat(e),"undefined"!=typeof e&&e>=0&&1>=e){t._volume=e,i&&(r.gain.value=e);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var o=t._howls[n]._getSoundIds(),a=0;a<o.length;a++){var h=t._howls[n]._soundById(o[a]);h&&h._node&&(h._node.volume=h._volume*e)}return t}return t._volume},mute:function(e){var t=this||s;t._muted=e,i&&(r.gain.value=e?0:t._volume);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var o=t._howls[n]._getSoundIds(),a=0;a<o.length;a++){var h=t._howls[n]._soundById(o[a]);h&&h._node&&(h._node.muted=e?!0:h._muted)}return t},codecs:function(e){return(this||s)._codecs[e]},_setupCodecs:function(){var e=this||s,t=new Audio;return e._codecs={mp3:!!t.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!t.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(t.canPlayType("audio/x-mp4;")||t.canPlayType("audio/mp4;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")},e},_enableiOSAudio:function(){var e=this||s;if(!t||!e._iOSEnabled&&/iPhone|iPad|iPod/i.test(navigator.userAgent)){e._iOSEnabled=!1;var i=function(){var n=t.createBuffer(1,1,22050),r=t.createBufferSource();r.buffer=n,r.connect(t.destination),"undefined"==typeof r.start?r.noteOn(0):r.start(0),setTimeout(function(){(r.playbackState===r.PLAYING_STATE||r.playbackState===r.FINISHED_STATE)&&(e._iOSEnabled=!0,e.iOSAutoEnable=!1,window.removeEventListener("touchstart",i,!1))},0)};return window.addEventListener("touchstart",i,!1),e}}};var s=new o,a=function(e){var t=this;return e.src?void t.init(e):void console.error("An array of source files must be passed with any new Howl.")};a.prototype={init:function(e){var n=this;return n._autoplay=e.autoplay||!1,n._ext=e.ext||null,n._html5=e.html5||!1,n._muted=e.mute||!1,n._loop=e.loop||!1,n._pool=e.pool||5,n._preload="boolean"==typeof e.preload?e.preload:!0,n._rate=e.rate||1,n._sprite=e.sprite||{},n._src="string"!=typeof e.src?e.src:[e.src],n._volume=void 0!==e.volume?e.volume:1,n._duration=0,n._loaded=!1,n._sounds=[],n._endTimers={},n._onend=e.onend?[{fn:e.onend}]:[],n._onfaded=e.onfaded?[{fn:e.onfaded}]:[],n._onload=e.onload?[{fn:e.onload}]:[],n._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],n._onpause=e.onpause?[{fn:e.onpause}]:[],n._onplay=e.onplay?[{fn:e.onplay}]:[],n._webAudio=i&&!n._html5,"undefined"!=typeof t&&t&&s.iOSAutoEnable&&s._enableiOSAudio(),s._howls.push(n),n._preload&&n.load(),n},load:function(){var e=this,t=null;if(n)return void e._emit("loaderror");"string"==typeof e._src&&(e._src=[e._src]);for(var i=0;i<e._src.length;i++){var r,o;if(e._ext&&e._ext[i]?r=e._ext[i]:(o=e._src[i],r=/^data:audio\/([^;,]+);/i.exec(o),r||(r=/\.([^.]+)$/.exec(o.split("?",1)[0])),r&&(r=r[1].toLowerCase())),s.codecs(r)){t=e._src[i];break}}return t?(e._src=t,new h(e),e._webAudio&&u(e),e):void e._emit("loaderror")},play:function(e){var i=this,n=null;if("number"==typeof e)n=e,e=null;else if("undefined"==typeof e){e="__default";for(var r=0,o=0;o<i._sounds.length;o++)i._sounds[o]._paused&&!i._sounds[o]._ended&&(r++,n=i._sounds[o]._id);1===r?e=null:n=null}var a=n?i._soundById(n):i._inactiveSound();if(n&&!e&&(e=a._sprite||"__default"),!a)return null;if(!i._loaded&&!i._sprite[e])return i.once("load",function(){i.play(i._soundById(a._id)?a._id:void 0)}),a._id;if(n&&!a._paused)return a._id;var h=a._seek>0?a._seek:i._sprite[e][0]/1e3,l=(i._sprite[e][0]+i._sprite[e][1])/1e3-h,u=function(){var n=!(!a._loop&&!i._sprite[e][2]);i._emit("end",a._id),!i._webAudio&&n&&i.stop(a._id).play(a._id),i._webAudio&&n&&(i._emit("play",a._id),a._seek=a._start||0,a._playStart=t.currentTime,i._endTimers[a._id]=setTimeout(u,1e3*(a._stop-a._start)/Math.abs(i._rate))),i._webAudio&&!n&&(a._paused=!0,a._ended=!0,a._seek=a._start||0,i._clearTimer(a._id),a._node.bufferSource=null),i._webAudio||n||i.stop(a._id)};i._endTimers[a._id]=setTimeout(u,1e3*l/Math.abs(i._rate)),a._paused=!1,a._ended=!1,a._sprite=e,a._seek=h,a._start=i._sprite[e][0]/1e3,a._stop=(i._sprite[e][0]+i._sprite[e][1])/1e3,a._loop=!(!a._loop&&!i._sprite[e][2]);var d=a._node;if(i._webAudio){var c=function(){i._refreshBuffer(a);var e=a._muted||i._muted?0:a._volume*s.volume();d.gain.setValueAtTime(e,t.currentTime),a._playStart=t.currentTime,"undefined"==typeof d.bufferSource.start?d.bufferSource.noteGrainOn(0,h,l):d.bufferSource.start(0,h,l),i._endTimers[a._id]||(i._endTimers[a._id]=setTimeout(u,1e3*l/Math.abs(i._rate))),setTimeout(function(){i._emit("play",a._id)},0)};i._loaded?c():(i.once("load",c),i._clearTimer(a._id))}else{var f=function(){d.currentTime=h,d.muted=a._muted||i._muted||s._muted||d.muted,d.volume=a._volume*s.volume(),d.playbackRate=i._rate,setTimeout(function(){d.play(),i._emit("play",a._id)},0)};if(4===d.readyState||!d.readyState&&navigator.isCocoonJS)f();else{var p=function(){i._endTimers[a._id]=setTimeout(u,1e3*l/Math.abs(i._rate)),f(),d.removeEventListener("canplaythrough",p,!1)};d.addEventListener("canplaythrough",p,!1),i._clearTimer(a._id)}}return a._id},pause:function(e){var t=this;if(!t._loaded)return t.once("play",function(){t.pause(e)}),t;for(var i=t._getSoundIds(e),n=0;n<i.length;n++){t._clearTimer(i[n]);var r=t._soundById(i[n]);if(r&&!r._paused){if(r._seek=t.seek(i[n]),r._paused=!0,t._webAudio){if(!r._node.bufferSource)return t;"undefined"==typeof r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),r._node.bufferSource=null}else isNaN(r._node.duration)||r._node.pause();arguments[1]||t._emit("pause",r._id)}}return t},stop:function(e){var t=this;if(!t._loaded)return"undefined"!=typeof t._sounds[0]._sprite&&t.once("play",function(){t.stop(e)}),t;for(var i=t._getSoundIds(e),n=0;n<i.length;n++){t._clearTimer(i[n]);var r=t._soundById(i[n]);if(r&&!r._paused)if(r._seek=r._start||0,r._paused=!0,r._ended=!0,t._webAudio){if(!r._node.bufferSource)return t;"undefined"==typeof r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),r._node.bufferSource=null}else isNaN(r._node.duration)||(r._node.pause(),r._node.currentTime=r._start||0)}return t},mute:function(e,i){var n=this;if(!n._loaded)return n.once("play",function(){n.mute(e,i)}),n;if("undefined"==typeof i){if("boolean"!=typeof e)return n._muted;n._muted=e}for(var r=n._getSoundIds(i),o=0;o<r.length;o++){var a=n._soundById(r[o]);a&&(a._muted=e,n._webAudio&&a._node?a._node.gain.setValueAtTime(e?0:a._volume*s.volume(),t.currentTime):a._node&&(a._node.muted=s._muted?!0:e))}return n},volume:function(){var e,i,n=this,r=arguments;if(0===r.length)return n._volume;if(1===r.length){var o=n._getSoundIds(),a=o.indexOf(r[0]);a>=0?i=parseInt(r[0],10):e=parseFloat(r[0])}else 2===r.length&&(e=parseFloat(r[0]),i=parseInt(r[1],10));var h;if(!("undefined"!=typeof e&&e>=0&&1>=e))return h=i?n._soundById(i):n._sounds[0],h?h._volume:0;if(!n._loaded)return n.once("play",function(){n.volume.apply(n,r)}),n;"undefined"==typeof i&&(n._volume=e),i=n._getSoundIds(i);for(var l=0;l<i.length;l++)h=n._soundById(i[l]),h&&(h._volume=e,n._webAudio&&h._node?h._node.gain.setValueAtTime(e*s.volume(),t.currentTime):h._node&&(h._node.volume=e*s.volume()));return n},fade:function(e,i,n,r){var o=this;if(!o._loaded)return o.once("play",function(){o.fade(e,i,n,r)}),o;o.volume(e,r);for(var s=o._getSoundIds(r),a=0;a<s.length;a++){var h=o._soundById(s[a]);if(h)if(o._webAudio){var l=t.currentTime,u=l+n/1e3;h._volume=e,h._node.gain.setValueAtTime(e,l),h._node.gain.linearRampToValueAtTime(i,u),setTimeout(function(e,n){setTimeout(function(){n._volume=i,o._emit("faded",e)},u-t.currentTime>0?Math.ceil(1e3*(u-t.currentTime)):0)}.bind(o,s[a],h),n)}else{var d=Math.abs(e-i),c=e>i?"out":"in",f=d/.01,p=n/f;!function(){var t=e,n=setInterval(function(e){t+="in"===c?.01:-.01,t=Math.max(0,t),t=Math.min(1,t),t=Math.round(100*t)/100,o.volume(t,e),t===i&&(clearInterval(n),o._emit("faded",e))}.bind(o,s[a]),p)}()}}return o},loop:function(){var e,t,i,n=this,r=arguments;if(0===r.length)return n._loop;if(1===r.length){if("boolean"!=typeof r[0])return i=n._soundById(parseInt(r[0],10)),i?i._loop:!1;e=r[0],n._loop=e}else 2===r.length&&(e=r[0],t=parseInt(r[1],10));for(var o=n._getSoundIds(t),s=0;s<o.length;s++)i=n._soundById(o[s]),i&&(i._loop=e,n._webAudio&&i._node&&(i._node.bufferSource.loop=e));return n},seek:function(){var e,i,n=this,r=arguments;if(0===r.length)i=n._sounds[0]._id;else if(1===r.length){var o=n._getSoundIds(),s=o.indexOf(r[0]);s>=0?i=parseInt(r[0],10):(i=n._sounds[0]._id,e=parseFloat(r[0]))}else 2===r.length&&(e=parseFloat(r[0]),i=parseInt(r[1],10));if("undefined"==typeof i)return n;if(!n._loaded)return n.once("load",function(){n.seek.apply(n,r)}),n;var a=n._soundById(i);if(a){if(!(e>=0))return n._webAudio?a._seek+(t.currentTime-a._playStart):a._node.currentTime;var h=n.playing(i);h&&n.pause(i,!0),a._seek=e,n._clearTimer(i),h&&n.play(i)}return n},playing:function(e){var t=this,i=t._soundById(e)||t._sounds[0];return i?!i._paused:!1},duration:function(){return this._duration},unload:function(){for(var e=this,t=e._sounds,i=0;i<t.length;i++){t[i]._paused||(e.stop(t[i]._id),e._emit("end",t[i]._id)),e._webAudio||(t[i]._node.src="",t[i]._node.removeEventListener("error",t[i]._errorFn,!1),t[i]._node.removeEventListener("canplaythrough",t[i]._loadFn,!1)),delete t[i]._node,e._clearTimer(t[i]._id);var n=s._howls.indexOf(e);n>=0&&s._howls.splice(n,1)}return l&&delete l[e._src],e=null,null},on:function(e,t,i){var n=this,r=n["_on"+e];return"function"==typeof t&&r.push({id:i,fn:t}),n},off:function(e,t,i){var n=this,r=n["_on"+e];if(t){for(var o=0;o<r.length;o++)if(t===r[o].fn&&i===r[o].id){r.splice(o,1);break}}else r=[];return n},once:function(e,t,i){var n=this,r=function(){t.apply(n,arguments),n.off(e,r,i)};return n.on(e,r,i),n},_emit:function(e,t,i){for(var n=this,r=n["_on"+e],o=0;o<r.length;o++)r[o].id&&r[o].id!==t||setTimeout(function(e){e.call(this,t,i)}.bind(n,r[o].fn),0);return n},_clearTimer:function(e){var t=this;return t._endTimers[e]&&(clearTimeout(t._endTimers[e]),delete t._endTimers[e]),t},_soundById:function(e){for(var t=this,i=0;i<t._sounds.length;i++)if(e===t._sounds[i]._id)return t._sounds[i];return null},_inactiveSound:function(){var e=this;e._drain();for(var t=0;t<e._sounds.length;t++)if(e._sounds[t]._ended)return e._sounds[t].reset();return new h(e)},_drain:function(){var e=this,t=e._pool,i=0,n=0;if(!(e._sounds.length<t)){for(n=0;n<e._sounds.length;n++)e._sounds[n]._ended&&i++;for(n=e._sounds.length-1;n>=0;n--){if(t>=i)return;e._sounds[n]._ended&&(e._webAudio&&e._sounds[n]._node&&e._sounds[n]._node.disconnect(0),e._sounds.splice(n,1),i--)}}},_getSoundIds:function(e){var t=this;if("undefined"==typeof e){for(var i=[],n=0;n<t._sounds.length;n++)i.push(t._sounds[n]._id);return i}return[e]},_refreshBuffer:function(e){var i=this;return e._node.bufferSource=t.createBufferSource(),e._node.bufferSource.buffer=l[i._src],e._node.bufferSource.connect(e._panner?e._panner:e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop),e._node.bufferSource.playbackRate.value=i._rate,i}};var h=function(e){this._parent=e,this.init()};if(h.prototype={init:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._muted=t._muted,e._seek=0,e._paused=!0,e._ended=!0,e._id=Math.round(Date.now()*Math.random()),t._sounds.push(e),e.create(),e},create:function(){var e=this,i=e._parent,n=s._muted||e._muted||e._parent._muted?0:e._volume*s.volume();return i._webAudio?(e._node="undefined"==typeof t.createGain?t.createGainNode():t.createGain(),e._node.gain.setValueAtTime(n,t.currentTime),e._node.paused=!0,e._node.connect(r)):(e._node=new Audio,e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener("canplaythrough",e._loadFn,!1),e._node.src=i._src,e._node.preload="auto",e._node.volume=n,e._node.load()),e},reset:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._muted=t._muted,e._seek=0,e._paused=!0,e._ended=!0,e._sprite=null,e._id=Math.round(Date.now()*Math.random()),e},_errorListener:function(){var e=this;e._node.error&&4===e._node.error.code&&(s.noAudio=!0),e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorListener,!1)},_loadListener:function(){var e=this,t=e._parent;t._duration=Math.ceil(10*e._node.duration)/10,0===Object.keys(t._sprite).length&&(t._sprite={__default:[0,1e3*t._duration]}),t._loaded||(t._loaded=!0,t._emit("load")),t._autoplay&&t.play(),e._node.removeEventListener("canplaythrough",e._loadListener,!1)}},i)var l={},u=function(e){var t=e._src;if(l[t])return e._duration=l[t].duration,void f(e);if(/^data:[^;]+;base64,/.test(t)){for(var i=atob(t.split(",")[1]),n=new Uint8Array(i.length),r=0;r<i.length;++r)n[r]=i.charCodeAt(r);c(n.buffer,e)}else{var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){c(o.response,e)},o.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete l[t],e.load())},d(o)}},d=function(e){try{e.send()}catch(t){e.onerror()}},c=function(e,i){t.decodeAudioData(e,function(e){e&&(l[i._src]=e,f(i,e))},function(){i._emit("loaderror")})},f=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),e._loaded||(e._loaded=!0,e._emit("load")),e._autoplay&&e.play()};"function"==typeof define&&define.amd&&define("howler",function(){return{Howler:s,Howl:a}}),"undefined"!=typeof exports&&(exports.Howler=s,exports.Howl=a),"undefined"!=typeof window&&(window.HowlerGlobal=o,window.Howler=s,window.Howl=a,window.Sound=h)}(),function(){me.plugin=function(){var e={};return e.Base=Object.extend({init:function(){this.version="2.0.2"}}),e.patch=function(e,t,i){if("undefined"!=typeof e.prototype&&(e=e.prototype),"function"==typeof e[t]){var n=e[t];Object.defineProperty(e,t,{configurable:!0,value:function(e,t){return function(){this._patched=n;var e=t.apply(this,arguments);return this._patched=null,e}}(t,i)})}else console.error(t+" is not an existing function")},e.register=function(e,t){me.plugin[t]&&console.error("plugin "+t+" already registered");var i=[];if(arguments.length>2&&(i=Array.prototype.slice.call(arguments,1)),i[0]=e,me.plugin[t]=new(e.bind.apply(e,i)),!(me.plugin[t]&&me.plugin[t]instanceof me.plugin.Base))throw new me.Error("Plugin should extend the me.plugin.Base Class !");if(me.sys.checkVersion(me.plugin[t].version)>0)throw new me.Error("Plugin version mismatch, expected: "+me.plugin[t].version+", got: "+me.version)},e}()}(),me.DraggableEntity=function(e,t,i,n){"use strict";return e.extend({init:function(i,r,o){e.prototype.init.apply(this,[i,r,o]),this.dragging=!1,this.dragId=null,this.grabOffset=new n(0,0),this.onPointerEvent=t.registerPointerEvent,this.removePointerEvent=t.releasePointerEvent,this.initEvents()},initEvents:function(){var e=this;this.mouseDown=function(e){this.translatePointerEvent(e,i.DRAGSTART)},this.mouseUp=function(e){this.translatePointerEvent(e,i.DRAGEND)},this.onPointerEvent("pointerdown",this,this.mouseDown.bind(this)),this.onPointerEvent("pointerup",this,this.mouseUp.bind(this)),i.subscribe(i.MOUSEMOVE,this.dragMove.bind(this)),i.subscribe(i.DRAGSTART,function(t,i){i===e&&e.dragStart(t)}),i.subscribe(i.DRAGEND,function(t,i){i===e&&e.dragEnd(t)})},translatePointerEvent:function(e,t){i.publish(t,[e,this])},dragStart:function(e){return this.dragging===!1?(this.dragging=!0,this.dragId=e.pointerId,this.grabOffset.set(e.gameX,e.gameY),this.grabOffset.sub(this.pos),!1):void 0},dragMove:function(e){this.dragging===!0&&this.dragId===e.pointerId&&(this.pos.set(e.gameX,e.gameY),this.pos.sub(this.grabOffset))},dragEnd:function(){return this.dragging===!0?(this.pointerId=void 0,this.dragging=!1,!1):void 0},destroy:function(){i.unsubscribe(i.MOUSEMOVE,this.dragMove),i.unsubscribe(i.DRAGSTART,this.dragStart),i.unsubscribe(i.DRAGEND,this.dragEnd),this.removePointerEvent("pointerdown",this),this.removePointerEvent("pointerup",this)}})}(me.Entity,me.input,me.event,me.Vector2d),me.DroptargetEntity=function(e,t){"use strict";return e.extend({init:function(i,n,r){this.CHECKMETHOD_OVERLAP="overlaps",this.CHECKMETHOD_CONTAINS="contains",this.checkMethod=null,e.prototype.init.apply(this,[i,n,r]),t.subscribe(t.DRAGEND,this.checkOnMe.bind(this)),this.checkMethod=this[this.CHECKMETHOD_OVERLAP]},setCheckMethod:function(e){"undefined"!=typeof this[e]&&(this.checkMethod=this[e])},checkOnMe:function(e,t){t&&this.checkMethod(t.getBounds().translateV(t.pos))&&this.drop(t)},drop:function(){},destroy:function(){t.unsubscribe(t.DRAGEND,this.checkOnMe)}})}(me.Entity,me.event),function(){var e=function(){var e=me.video.createCanvas(1,1),t=me.CanvasRenderer.getContext2d(e);return t.fillStyle="#fff",t.fillRect(0,0,1,1),e}();me.ParticleEmitterSettings={width:0,height:0,image:e,totalParticles:50,angle:Math.PI/2,angleVariation:0,minLife:1e3,maxLife:3e3,speed:2,speedVariation:1,minRotation:0,maxRotation:0,minStartScale:1,maxStartScale:1,minEndScale:0,maxEndScale:0,gravity:0,wind:0,followTrajectory:!1,textureAdditive:!1,onlyInViewport:!0,floating:!1,maxParticles:10,frequency:100,duration:1/0,framesToSkip:0},me.ParticleEmitter=me.Rect.extend({init:function(e,t,i){this._stream=!1,this._frequencyTimer=0,this._durationTimer=0,this._enabled=!1,this.isRenderable=!1,me.Rect.prototype.init.apply(this,[e,t,1/0,1/0]),this.autoSort=!1,this.container=new me.ParticleContainer(this),Object.defineProperty(this,"z",{get:function(){return this.container.z
},set:function(e){this.container.z=e},enumerable:!0,configurable:!0}),Object.defineProperty(this,"floating",{get:function(){return this.container.floating},set:function(e){this.container.floating=e},enumerable:!0,configurable:!0}),this.reset(i)},destroy:function(){this.reset()},getRandomPoint:function(){var e=this.pos.clone();return e.x+=0..randomFloat(this.width),e.y+=0..randomFloat(this.height),e},reset:function(e){e=e||{};var t=me.ParticleEmitterSettings,i="number"==typeof e.width?e.width:t.width,n="number"==typeof e.height?e.height:t.height;this.resize(i,n),this.image=e.image||t.image,this.totalParticles="number"==typeof e.totalParticles?e.totalParticles:t.totalParticles,this.angle="number"==typeof e.angle?e.angle:t.angle,this.angleVariation="number"==typeof e.angleVariation?e.angleVariation:t.angleVariation,this.minLife="number"==typeof e.minLife?e.minLife:t.minLife,this.maxLife="number"==typeof e.maxLife?e.maxLife:t.maxLife,this.speed="number"==typeof e.speed?e.speed:t.speed,this.speedVariation="number"==typeof e.speedVariation?e.speedVariation:t.speedVariation,this.minRotation="number"==typeof e.minRotation?e.minRotation:t.minRotation,this.maxRotation="number"==typeof e.maxRotation?e.maxRotation:t.maxRotation,this.minStartScale="number"==typeof e.minStartScale?e.minStartScale:t.minStartScale,this.maxStartScale="number"==typeof e.maxStartScale?e.maxStartScale:t.maxStartScale,this.minEndScale="number"==typeof e.minEndScale?e.minEndScale:t.minEndScale,this.maxEndScale="number"==typeof e.maxEndScale?e.maxEndScale:t.maxEndScale,this.gravity="number"==typeof e.gravity?e.gravity:t.gravity,this.wind="number"==typeof e.wind?e.wind:t.wind,this.followTrajectory="boolean"==typeof e.followTrajectory?e.followTrajectory:t.followTrajectory,this.textureAdditive="boolean"==typeof e.textureAdditive?e.textureAdditive:t.textureAdditive,this.onlyInViewport="boolean"==typeof e.onlyInViewport?e.onlyInViewport:t.onlyInViewport,this.floating="boolean"==typeof e.floating?e.floating:t.floating,this.maxParticles="number"==typeof e.maxParticles?e.maxParticles:t.maxParticles,this.frequency="number"==typeof e.frequency?e.frequency:t.frequency,this.duration="number"==typeof e.duration?e.duration:t.duration,this.framesToSkip="number"==typeof e.framesToSkip?e.framesToSkip:t.framesToSkip,this.container.destroy()},addParticles:function(e){for(var t=0;~~e>t;t++){var i=me.pool.pull("me.Particle",this);this.container.addChild(i)}},isRunning:function(){return this._enabled&&this._stream},streamParticles:function(e){this._enabled=!0,this._stream=!0,this.frequency=Math.max(this.frequency,1),this._durationTimer="number"==typeof e?e:this.duration},stopStream:function(){this._enabled=!1},burstParticles:function(e){this._enabled=!0,this._stream=!1,this.addParticles("number"==typeof e?e:this.totalParticles),this._enabled=!1},update:function(e){if(this._enabled&&this._stream){if(1/0!==this._durationTimer&&(this._durationTimer-=e,this._durationTimer<=0))return this.stopStream(),!1;this._frequencyTimer+=e;var t=this.container.children.length;t<this.totalParticles&&this._frequencyTimer>=this.frequency&&(this.addParticles(t+this.maxParticles<=this.totalParticles?this.maxParticles:this.totalParticles-t),this._frequencyTimer=0)}return!0}})}(),function(){me.ParticleContainer=me.Container.extend({init:function(e){me.Container.prototype.init.apply(this),this.autoSort=!1,this._updateCount=0,this._dt=0,this._emitter=e,this.bounds=me.game.viewport},getBounds:function(){return this.bounds},update:function(e){if(++this._updateCount>this._emitter.framesToSkip&&(this._updateCount=0),this._updateCount>0)return this._dt+=e,!1;e+=this._dt,this._dt=0;for(var t=me.game.viewport,i=this.children.length-1;i>=0;--i){var n=this.children[i];n.isRenderable=!0,n.inViewport=this.floating||n.pos.x<t.pos.x+t.width&&t.pos.x<n.pos.x+n.width&&n.pos.y<t.pos.y+t.height&&t.pos.y<n.pos.y+n.height,n.update(e)||this.removeChildNow(n)}return!0},draw:function(e,t){if(this.children.length>0){var i;this._emitter.textureAdditive&&(i=e.globalCompositeOperation,e.globalCompositeOperation="lighter"),me.Container.prototype.draw.apply(this,[e,t]),this._emitter.textureAdditive&&(e.globalCompositeOperation=i)}}})}(),function(){me.Particle=me.Renderable.extend({init:function(e){var t=e.getRandomPoint();me.Renderable.prototype.init.apply(this,[t.x,t.y,e.image.width,e.image.height]),this.alwaysUpdate=!0,this.isRenderable=!1,this.image=e.image;var i=e.angle+(e.angleVariation>0?(-1).random(2)*e.angleVariation:0),n=e.speed+(e.speedVariation>0?(-1).random(2)*e.speedVariation:0);this.vel=new me.Vector2d(n*Math.cos(i),-n*Math.sin(i)),this.life=e.minLife.random(e.maxLife),this.startLife=this.life,this.startScale=e.minStartScale.randomFloat(e.maxStartScale).clamp(e.minStartScale,e.maxStartScale),this.endScale=e.minEndScale.randomFloat(e.maxEndScale).clamp(e.minEndScale,e.maxEndScale),this.gravity=e.gravity,this.wind=e.wind,this.followTrajectory=e.followTrajectory,this.onlyInViewport=e.onlyInViewport,this.z=e.z,this._deltaInv=me.sys.fps/1e3,this.transform=new me.Matrix2d,e.followTrajectory||(this.angle=e.minRotation.randomFloat(e.maxRotation))},update:function(e){var t=e*this._deltaInv;this.life=this.life>e?this.life-e:0;var i=this.life/this.startLife,n=this.startScale;this.startScale>this.endScale?(n*=i,n=n<this.endScale?this.endScale:n):this.startScale<this.endScale&&(n/=i,n=n>this.endScale?this.endScale:n),this.alpha=i,this.vel.x+=this.wind*t,this.vel.y+=this.gravity*t;var r=this.followTrajectory?Math.atan2(this.vel.y,this.vel.x):this.angle;return this.transform.set(n,0,0,n,0,0).rotate(r),this.pos.x+=this.vel.x*t,this.pos.y+=this.vel.y*t,(this.inViewport||!this.onlyInViewport)&&this.life>0},draw:function(e){e.save(),e.setGlobalAlpha(e.globalAlpha()*this.alpha);var t=this.transform.val;e.transform(t[0],t[1],t[2],t[3],~~this.pos.x,~~this.pos.y);var i=this.width,n=this.height;e.drawImage(this.image,0,0,i,n,-i/2,-n/2,i,n),e.restore()}})}(window);
